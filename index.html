<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astropeak</title>
<style>
        @font-face {
            font-family: "libretto-icons";
            src:url(assets/fonts/libretto-icons.eot);
            src:url(assets/fonts/libretto-icons.eot#iefix) format("embedded-opentype"),
            url(assets/fonts/libretto-icons.woff) format("woff"),
            url(assets/fonts/libretto-icons.ttf) format("truetype"),
            url(assets/fonts/libretto-icons.svg#libretto-icons) format("svg");
            font-weight: normal;
            font-style: normal;
        }
    </style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Sans+Mono%7CLibre+Baskerville%7CMontserrat%7CPlayfair+Display">
<link rel="stylesheet" href="assets/css/libretto_styles.css">
<link href="assets/css/custom.css" rel="stylesheet" type="text/css">
</head>
<body>
    <!-- Navigation bar -->
    <header class="nav-bar"><div class="site-branding">
            <h1 class="site-title">
                <a href="https://astropeak.github.io/" title="Astropeak" rel="home">Astropeak</a>
            </h1>
        </div>
        <nav class="site-navigation" role="navigation"><div class="menu-toggle">
                <span class="mobile-site-title">Astropeak</span>
            </div>
            <ul class="menu">
<li><a href="archive.html">Archive</a></li>
                    <li><a href="categories/">Tags</a></li>
                    <li><a href="rss.xml">RSS feed</a></li>
                    <li><a href="http://github.com/astropeak">Github</a></li>
            </ul></nav></header><div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-decorator/" rel="bookmark">May 10, 2018</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-decorator/">Python 装饰器（Decorator）</a></h1>
                </div>
                <div class="entry-content">
                        <p>
装饰器的语法为 <code>@dec_name</code> ，置于函数定义之前。如：
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">atexit</span>

<span class="nd">@atexit.register</span>
<span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'Goodbye!'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'Script end here'</span><span class="p">)</span>
</pre></div>
<p>
<code>atexit.register</code> 是一个装饰器，它的作用是将被装饰的函数注册为在程序结束时执行。函数 <code>goodbye</code> 是被装饰的函数。
</p>

<p>
程序的运行结果是：
</p>
<div class="highlight"><pre><span></span>Script end here
Goodbye!
</pre></div>
<p>
可见函数 <code>goodbye</code> 在程序结束后被自动调用。
</p>

<p>
另一个常见的例子是 <code>@property</code> ，装饰类的成员函数，将其转换为一个描述符。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'attr called'</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'attr value'</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</pre></div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">等价语法</h2>
<div class="outline-text-2" id="text-1">
<p>
语句块
</p>
<div class="highlight"><pre><span></span><span class="nd">@atexit.register</span>
<span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'Goodbye!'</span><span class="p">)</span>
</pre></div>
<p>
等价于
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">goodbye</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'Goodbye!'</span><span class="p">)</span>
<span class="n">goodbye</span> <span class="o">=</span> <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">goodbye</span><span class="p">)</span>
</pre></div>
<p>
以上是使用装饰器的两种写法。第一种写法比较简洁，第二种写法更加直观，二者在作用上完全等价。
</p>

<p>
从中也可看出，装饰器实际上是一个函数（或callable），其输入、返回值为：
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left"> </th>
<th scope="col" class="left">说明</th>
<th scope="col" class="left">示例中的对应</th>
</tr></thead>
<tbody>
<tr>
<td class="left">输入</td>
<td class="left">被装饰的函数</td>
<td class="left">goodbye</td>
</tr>
<tr>
<td class="left">返回值</td>
<td class="left">变换后的函数或任意对象</td>
<td class="left"> </td>
</tr>
</tbody>
</table>
<p>
返回值会被赋值给原来指向输入函数的变量，如示例中的 <code>goodbye</code> 。此时变量 <code>goodbye</code> 将指向装饰器的返回值，而不是原来的函数定义。返回值一般为一个函数，这个函数是在输入参数函数添加了一些额外操作的版本。
</p>

<p>
如下面这个装饰器对原始函数添加了一个操作：每次调用这个函数时，打印函数的输入参数及返回值。
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Enter. Args: </span><span class="si">%s</span><span class="s1">, kwargs: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Exit. Return value: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rv</span>

  <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@trace</span>
<span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'area called'</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>

<span class="n">area</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

<p>
程序的运行结果为：
</p>
<div class="highlight"><pre><span></span>Enter. Args: (2, 3), kwargs: {}
area called
Exit. Return value: 6
</pre></div>

<p>
也可以将以上打印输入参数及返回值的语句直接写在 <code>area</code> 函数里，如：
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'Enter. Args: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'area called'</span><span class="p">)</span>
  <span class="n">rv</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'Exit. Return value: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">rv</span>

<span class="n">area</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

<p>
程序的运行结果与使用装饰器时相同。但使用装饰器的好处为：
</p>
<ol class="org-ol">
<li>打印输入参数及返回值这个操作可被重用

<p>
如对于一个新的函数 <code>foo</code> ，装饰器 <code>trace</code> 可以直接拿来使用，而无须在函数内部重复写两条 <code>print</code> 语句。
</p>
<div class="highlight"><pre><span></span><span class="nd">@trace</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">return</span> <span class="s1">'return value'</span>
</pre></div>

<blockquote>
<p>
一个装饰器实际上定义了一种可重复使用的操作。
</p>
</blockquote>
</li>
<li>函数的功能更单纯

<p>
 <code>area</code> 函数的功能是计算面积，而调试语句与其功能无关。使用装饰器可以将与函数功能无关的语句提取出来。
因此函数可以写地更小。
</p>

<blockquote>
<p>
使用装饰器，相当于将两个小函数组合起来，组成功能更强大的函数。
</p>
</blockquote>
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">修正名称</h2>
<div class="outline-text-2" id="text-2">
<p>
以上例子中有一个缺陷，函数 <code>area</code> 被 <code>trace</code> 装饰后，其名称变为 <code>wrapper</code> ，而非 <code>area</code> 。 <code>print(area)</code> 的结果为：
</p>
<div class="highlight"><pre><span></span>&lt;function wrapper at 0x10df45668&gt;
</pre></div>
<p>
<code>wrapper</code> 这个名称来源于 <code>trace</code> 中定义的 <code>wrapper</code> 函数。
</p>

<p>
可以通过 <code>functools.wraps</code> 来修正这个问题。
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Enter. Args: </span><span class="si">%s</span><span class="s1">, kwargs: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Exit. Return value: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">rv</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rv</span>

  <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@trace</span>
<span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'area called'</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
</pre></div>

<p>
即使用 <code>functools.wraps</code> 来装饰 <code>wrapper</code> 。此时 <code>print(area)</code> 的结果为：
</p>
<div class="highlight"><pre><span></span>&lt;function area at 0x10e8371b8&gt;
</pre></div>
<p>
函数的名称能够正确显示。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">接收参数</h2>
<div class="outline-text-2" id="text-3">
<p>
以上例子中 <code>trace</code> 这个装饰器在使用时不接受参数。如果想传入参数，如传入被装饰函数的名称，可以这么做：
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s1">'Enter </span><span class="si">%s</span><span class="s1">. Args: </span><span class="si">%s</span><span class="s1">, kwargs: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
      <span class="n">rv</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="s1">'Exit </span><span class="si">%s</span><span class="s1">. Return value: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rv</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">wrapped</span>
  <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@trace</span><span class="p">(</span><span class="s1">'area'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">'area called'</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>

<span class="n">area</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>

<p>
程序的运行结果为：
</p>
<div class="highlight"><pre><span></span>Enter area. Args: (2, 3), kwargs: {}
area called
Exit area. Return value: 6
</pre></div>
<p>
将函数名称传入后，在日志同时打印出函数名，日志更加清晰。
</p>

<p>
<code>@trace('area')</code> 是如何工作的？
</p>

<p>
这里其实包含了两个步骤。 <code>@trace('area')</code> 等价于：
</p>
<div class="highlight"><pre><span></span><span class="n">dec</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="s1">'area'</span><span class="p">)</span>
<span class="nd">@dec</span>
<span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
<p>
即先触发函数调用 <code>trace('area')</code> ，得到一个返回值，这个返回值为 <code>wrapper</code> 函数。
而这个函数才是真正的装饰器，然后使用这个装饰器装饰函数。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">多重装饰器</h2>
<div class="outline-text-2" id="text-4">
<p>
装饰器可以叠加使用，如：
</p>
<div class="highlight"><pre><span></span><span class="nd">@dec1</span>
<span class="nd">@dec2</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span><span class="k">pass</span>
</pre></div>
<p>
等价的代码为：
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span><span class="k">pass</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">dec2</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">dec1</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</pre></div>

<p>
即装饰器依次装饰函数，靠近函数定义的装饰器优先。相当于串联起来。
</p>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-descriptor/" rel="bookmark">May 9, 2018</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-descriptor/">Python描述符（Descriptor）</a></h1>
                </div>
                <div class="entry-content">
                        <p>
先看一个例子，@property。被@property修饰的成员函数，将变为一个描述符。这是最简单的创建描述符的方式。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'getting attr'</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'attr value'</span>

  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</pre></div>

<p>
上面这个例子中， <code>attr</code> 是类 <code>Foo</code> 的一个成员函数，可通过语句 <code>foo.attr()</code> 被调用。
但当它被 <code>@property</code> 修饰后，这个成员函数将不再是一个函数，而变为一个描述符。 <code>bar</code> 是一个未被修饰的成员函数。
 <code>type(Foo.attr)</code> 与 <code>type(Foo.bar)</code> 的结果分别为：
</p>
<div class="highlight"><pre><span></span>&lt;type 'property'&gt;
&lt;type 'instancemethod'&gt;
</pre></div>
<p>
<code>attr</code> 的类型为 <code>property</code> （注：一个 <code>property</code> 类型的对象总是一个描述符）， <code>bar</code> 的类型为 <code>instancemethod</code> ，也即一个常规的成员函数。
</p>

<p>
此时 <code>attr</code> 将无法再被调用，当尝试调用它时，语句 <code>foo.attr()</code> 将抛出错误：
</p>
<div class="highlight"><pre><span></span>TypeError: 'str' object is not callable
</pre></div>
<p>
让我们来理解这个错误。
</p>

<p>
首先来看 <code>foo.attr</code> 的值：
</p>
<div class="highlight"><pre><span></span>attr value
</pre></div>
<p>
其类型 <code>type(foo.attr)</code> ：
</p>
<div class="highlight"><pre><span></span>str
</pre></div>
<p>
 <code>foo.attr</code> 的类型为 <code>str</code> ，因此便有了以上的错误，一个 <code>str</code> 对象无法被调用。其值为'attr value'，正好是原始 <code>attr</code> 函数的返回值。
因此语句 <code>foo.attr</code> 实际上触发了原始 <code>attr</code> 函数的调用，并且将函数的返回值作为其值。实际上语句 <code>print(foo.attr)</code> 的输出为：
</p>
<div class="highlight"><pre><span></span>getting attr
attr value
</pre></div>
<p>
进一步验证了执行语句 <code>foo.attr</code> 时，原始的 <code>attr</code> 函数被调用。
</p>

<p>
发生了什么？当执行一个访问对象属性的语句 <code>foo.attr</code> 时，结果一个函数调用被触发！这便是描述符的作用：将属性访问转变为函数调用，并由这个函数来控制这个属性的值（也即函数的返回值），以及在返回值前做定制化的操作。此时可以给描述符一个简要定义：
</p>
<blockquote>
<p>
描述符是类的一个属性，控制类实例对象访问这个属性时如何返回值及做哪些额外操作
</p>
</blockquote>

<p>
这留给程序员的空间是巨大的。。
</p>



<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">描述符协议</h2>
<div class="outline-text-2" id="text-1">
<p>
任何实现了描述符协议的类都可以作为描述符类。描述符协议为一组成员函数定义，包括：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">函数</th>
<th scope="col" class="left">作用</th>
<th scope="col" class="left">返回值</th>
<th scope="col" class="left">是否必须</th>
</tr></thead>
<tbody>
<tr>
<td class="left"><code>__get__(self, obj, type)</code></td>
<td class="left">获取属性值</td>
<td class="left">属性的值</td>
<td class="left">是</td>
</tr>
<tr>
<td class="left"><code>__set__(self, obj, value)</code></td>
<td class="left">设置属性的值</td>
<td class="left">None</td>
<td class="left">否</td>
</tr>
<tr>
<td class="left"><code>__delete__(self, obj)</code></td>
<td class="left">删除属性</td>
<td class="left">None</td>
<td class="left">否</td>
</tr>
</tbody>
</table>
<p>
先来看一个自定义的描述符的实现。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDescriptor</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'get called'</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
  <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'set called'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'delete called'</span><span class="p">)</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="n">attr</span> <span class="o">=</span> <span class="n">MyDescriptor</span><span class="p">()</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
</pre></div>
<p>
示例中  <code>MyDescriptor</code> 实现了描述符协议（也即实现了 <code>__get__, __set__, __delete__</code> 函数），因此其为一个描述符类。 <code>Foo</code> 的 <code>attr</code> 属性为 <code>MyDescriptor</code> 类的实例对象，因此它是一个描述符。
</p>

<p>
<code>print(foo.attr)</code> 的输出为：
</p>
<div class="highlight"><pre><span></span>get called
None
</pre></div>
<p>
可见当访问 <code>foo</code> 的 <code>attr</code> 属性时， <code>MyDescriptor</code> 的 <code>__get__</code> 函数被调用。
</p>

<p>
foo.attr = 'new value' 的输出为：
</p>
<div class="highlight"><pre><span></span>set called
</pre></div>
<p>
可见当为 <code>attr</code> 设置一个新值时， <code>MyDescriptor</code> 的 <code>__set__</code> 函数被调用。
</p>

<p>
再运行 <code>print(foo.attr)</code> ，输出为：
</p>
<div class="highlight"><pre><span></span>get called
new value
</pre></div>
<p>
新值已被设置。
</p>

<p>
<code>del foo.attr</code> 的输出为：
</p>
<div class="highlight"><pre><span></span>delete called
</pre></div>
<p>
可见当为删除属性 <code>attr</code> 时， <code>MyDescriptor</code> 的  <code>__delete__</code>  函数被调用。
</p>

<p>
再执行 <code>print(foo.attr)</code> ， <code>AttributeError</code> 被抛出：
</p>
<div class="highlight"><pre><span></span>get called
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "1.py", line 6, in __get__
    return self.data
AttributeError: 'MyDescriptor' object has no attribute 'data'
</pre></div>
<p>
属性 <code>attr</code> 已被删除。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">参数意义</h2>
<div class="outline-text-2" id="text-2">
<p>
<code>__get__(self, obj, type)</code> 函数各个参数的意义为：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">参数</th>
<th scope="col" class="left">意义</th>
<th scope="col" class="left">例子中的对应</th>
</tr></thead>
<tbody>
<tr>
<td class="left">self</td>
<td class="left">描述符对象本身</td>
<td class="left">Foo.attr</td>
</tr>
<tr>
<td class="left">obj</td>
<td class="left">使用描述符的对象实例</td>
<td class="left">foo</td>
</tr>
<tr>
<td class="left">type</td>
<td class="left">obj的类型</td>
<td class="left">Foo</td>
</tr>
</tbody>
</table>
<p>
<code>__set__(self, obj, value)</code> 函数的self和obj参数的意义同 <code>__get__</code> ，value的意义为：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">参数</th>
<th scope="col" class="left">意义</th>
<th scope="col" class="left">例子中的对应</th>
</tr></thead>
<tbody><tr>
<td class="left">value</td>
<td class="left">属性的新值</td>
<td class="left">'new value'</td>
</tr></tbody>
</table>
<p>
<code>__delete__(self, obj)</code> 函数的self和obj参数的意义同 <code>__get__</code> 。</p>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-object-attribute-lookup/" rel="bookmark">May 7, 2018</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-object-attribute-lookup/">Python对象属性查询</a></h1>
                </div>
                <div class="entry-content">
                        <p>
对于语句x.y，即获取对象x的y属性，其查询过程为：
</p>
<ol class="org-ol">
<li>查询y是否存在于 <code>x.__dict__</code> 。 存在则返回
</li>
<li>查询y是否为x的类C（及其父类）的属性。 存在则返回
</li>
<li>查询失败，抛出 AttributeError。
</li>
</ol>
<p>
以上步骤为简化过程，仅包含了对象级别属性及类级别属性的处理，同时也忽略了一些特殊情况及描述符的处理。
第一条规则处理对象级属性，第二条规则处理类级属性。这两条规则能够覆盖大多数情况。
</p>

<p>
以下是一个例子：
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="n">attr1</span> <span class="o">=</span> <span class="s1">'value1'</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr2</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attr2</span> <span class="o">=</span> <span class="n">attr2</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">'value2'</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">attr2</span> <span class="ow">is</span> <span class="n">foo</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'attr2'</span><span class="p">])</span>
<span class="k">assert</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">attr1</span> <span class="ow">is</span> <span class="n">Foo</span><span class="o">.</span><span class="n">attr1</span><span class="p">)</span>
</pre></div>


<p>
foo.attr2是一个对象级属性，foo.attr1是一个类级属性。
<code>assert(foo.attr2 is foo.__dict__['attr2'])</code> 为True表明foo.attr2与 <code>foo.__dict__</code> 是相同的，即其通过第一条规则查询得到。
<code>assert(foo.attr1 is Foo.attr1)</code> 为True表明foo.attr1与 Foo.attr1是相同的，所以其通过第二条规则查询得到。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">规则2的补充</h2>
<div class="outline-text-2" id="text-1">
<p>
以上第2条规则提到：查询y是否为x的类C（及其父类）的属性。即为了获取x.y，去查询C.y，其中C为x的类型。C.y具体是如何查询的呢？
</p>

<p>
C.y与x.y的查询机制相同，此时C便是一个当前的对象（事实上Python类本身是一个类型为type的对象实例）。 所以查询C.y，将以上步骤中x替换为C，则得到C.y的具体步骤：
</p>
<ol class="org-ol">
<li>查询y是否存在于 <code>C.__dict__</code> 。 存在则返回
</li>
<li>查询y是否为C的类CC（此时为type）的属性。 存在则返回
</li>
<li>查询失败，抛出 AttributeError。
</li>
</ol>
<p>
以下例子可以验证。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="n">attr1</span> <span class="o">=</span> <span class="s1">'value1'</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr2</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attr2</span> <span class="o">=</span> <span class="n">attr2</span>

<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Foo</span><span class="p">))</span> <span class="c1"># &lt;type 'classobj'&gt;</span>
<span class="k">assert</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="n">attr1</span> <span class="ow">is</span> <span class="n">Foo</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'attr1'</span><span class="p">])</span>    <span class="c1"># True</span>
</pre></div>


<p>
<code>type(Foo)</code> 的结果为 <code>&lt;type 'classobj'&gt;</code> 。所以Foo是类型type的一个对象实例。attr1是Foo的一个属性，保存在 <code>Foo.__dict__</code> 中（这一点，跟其它自定义对象实例一致）。
</p>

<p>
由此可见，Foo（类本身）及foo（Foo的一个对象实例）在属性查询上，并没有什么不同。他们的不同点为Foo由Python解析器自动创建（当其解析class Foo语句时），而foo一般由程序自己创建（foo = Foo('value2'))。
</p>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">描述符的处理</h2>
<div class="outline-text-2" id="text-2">
<p>
对于x.y，当属性y是一个描述符时， Python2和Python3的处理规则有所不同。对于Python2，查询规则变为：
</p>
<ol class="org-ol">
<li>查询y是否存在于 <code>x.__dict__</code> 。 存在则返回
</li>
<li>查询y是否为描述符。若是则通过描述符来处理属性获取
</li>
<li>查询y是否为x的类C（及其父类）的属性。 存在则返回
</li>
<li>查询失败，抛出 AttributeError。
</li>
</ol>
<p>
对于Python3，查询规则为：
</p>
<ol class="org-ol">
<li>查询y是否为描述符。若是则通过描述符来处理属性获取
</li>
<li>查询y是否存在于 <code>x.__dict__</code> 。 存在则返回
</li>
<li>查询y是否为x的类C（及其父类）的属性。 存在则返回
</li>
<li>查询失败，抛出 AttributeError。
</li>
</ol>
<p>
区别在于描述符属性与对象级属性（通过 <code>x.__dict__</code> 获取的属性）的优先级不同。在Python2中，对象级属性优先级更高，而在Python3中，描述符属性优先级更高。
</p>

<p>
先来看一个例子。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="n">attr1</span> <span class="o">=</span> <span class="s1">'value1'</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr2</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'attr2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr2</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">attr2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">'value2, descriptor attr'</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">'value2, instance attr'</span><span class="p">)</span>
<span class="c1"># Python2的输出为: value2, instance attr</span>
<span class="c1"># Python3的输出为: value2, descriptor attr</span>
<span class="k">print</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">attr2</span><span class="p">)</span> 
</pre></div>


<p>
通过@property修饰后，函数attr2变为一个描述符。当通过foo.attr2获取attr2这个属性时，函数attr2会被调用，其返回值即为这个属性的值。
</p>

<p>
同时在 <code>__init__</code> 函数中，创建了一个同名的attr2实例级属性。需要注意此时不能使用语句 <code>self.attr2 = attr2</code> 来创建这个实例级属性，因为此时描述符已发生作用，attr2不会被保存在 <code>self.__dict__</code> 中，而是直接通过描述符函数处理。
</p>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">属性y是否为描述符</h2>
<div class="outline-text-2" id="text-3">
<p>
对于语句x.y，记对象x的类型为C， C.y的类型为D。如果
</p>
<ol class="org-ol">
<li>C.y存在，即hasattr(C, 'y') 为True
</li>
<li>且 D包含一个 <code>__get__</code> 属性， 即hasattr(D, '<code>__get__</code>' )为True
</li>
</ol>
<p>
则可判定y为一个描述符。 
</p>

<p>
第1个条件表示y为x的一个类级属性，即y为C的属性。第2个条件表示这个属性的类型包含一个 <code>__get__</code> 属性。 等价的Python代码如下：
</p>
<div class="highlight"><pre><span></span><span class="n">is_descriptor</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">):</span>
  <span class="n">D</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="vm">__class__</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="s1">'__get__'</span><span class="p">):</span>
    <span class="n">is_descriptor</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">数据描述符及非数据描述符</h2>
<div class="outline-text-2" id="text-4">
<p>
如果一个描述符仅包含 <code>__get__</code> 属性，而没有 <code>__set__</code> 属性，则它为一个非数据描述符，也即只能获取这个属性的值，而不能修改它的值。
</p>

<p>
如果一个描述符同时包含 <code>__get__</code> 和 <code>__set__</code> 属性，则它为一个数据描述符，此时即可获取属性值，也可修改它的值。
</p>


<p>
对于Python3，之前提到的规则只适用于数据描述符。如果一个属性是一个非数据描述符，则实例级属性（ <code>x.__dict__['attr']</code> ）的优先级高于描述符的优先级，所以查询规则变为：
</p>
<ol class="org-ol">
<li>查询y是否为数据描述符。若是则通过描述符来处理属性获取
</li>
<li>查询y是否存在于 <code>x.__dict__</code> 。 存在则返回
</li>
<li>查询y是否为非数据描述符。若是则通过描述符来处理属性获取
</li>
<li>查询y是否为x的类C（及其父类）的属性。 存在则返回
</li>
<li>查询失败，抛出 AttributeError。
</li>
</ol>
<p>
通过以下例子，可以看出这样做的逻辑。假设y是一个非数据描述符，且y不存在于 <code>x.__dict__</code> 中。
</p>
<ol class="org-ol">
<li>执行语句 x.y，第1、2条规则均不满足条件，因此第3条规则发生作用，属性值通过描述符来得到。
</li>
<li>执行语句 x.y = 'new value'， 由于y为一个非数据描述符，因此无法通过这个描述符修改这个属性的值。因此y会被保存在  <code>x.__dict__</code> 中。
</li>
<li>再次执行 x.y，第2条规则满足条件，此时返回 <code>x.__dict__</code> 中保存的值
</li>
</ol>
<p>
逻辑在于，当为属性设置一个新值后（第2步），再获取这个属性的值时（第3步），这个值应该与之前设置的值相同，而不是仍然为之前通过描述符返回的值。所以在这种情况下， <code>x.__dict__</code> 的优先级需要更高。
</p>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">成员函数是非数据描述符</h2>
<div class="outline-text-2" id="text-5">
<p>
类成员函数的实现为一个非数据描述符。根据以上规则，对象的属性会覆盖对象的同名成员函数。
</p>

<p>
以下为一个例子。
</p>
<div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'attr method'</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">attr2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'attr2 method'</span><span class="p">)</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">'attr value'</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">attr</span> <span class="ow">is</span> <span class="n">foo</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'attr'</span><span class="p">])</span>
<span class="n">foo</span><span class="o">.</span><span class="n">attr</span><span class="p">()</span> <span class="c1"># 错误，attr不是成员函数，无法调用</span>
<span class="n">foo</span><span class="o">.</span><span class="n">attr2</span><span class="p">()</span> <span class="c1"># 正确，输出为 attr2 method</span>
</pre></div>

<p>
对象foo包含一个属性attr，同时包含一个同名函数attr。assert 语句为True表明foo.attr为属性值，而非那个同名函数。
</p>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/encoding-and-decoding/" rel="bookmark">May 5, 2018</a>
                        </span>
                    </div>
                    <h1><a href="posts/encoding-and-decoding/">Encoding and Decoding</a></h1>
                </div>
                <div class="entry-content">
                        <p>
任何文件，想要保存在硬盘中时，首先要转换成某种编码。如UTF8，ASCII。编码的意思是一个字节流，因为硬盘中是以字节为单位来保存数据的。
刚开始可以简单的认为，在硬盘上保存的数据都是经过编码后的数据。那么这些数据就有一种编码格式。
</p>

<p>
每个操作系统都有默认的文件编码方式。文件被保存时，它首先被转换为这个编码格式的字节流。
</p>

<p>
一个python源文件也不例外，它在硬盘中也是以某种编码的形式保存的。这样，当python的解释器读取源文件时，必须知道这个文件的编码格式，才能读取到文件本身的内容。默认情况下，python解释器认为文件总是以ASCII的编码方式保存。也即每个字节都表示一个字符。每个字节的值总是在0到127之间。如果文件是以其他编码方式保存的，则可以通过加注释的形式，告诉解释器这个文件实际的编码方式。以下行告诉解释器文件的编码方式是UTF8。
</p>
<div class="highlight"><pre><span></span><span class="c1"># encoding:utf8</span>
</pre></div>
<p>
如果源文件中包含非ASCII字符，则必须包含上述行，否则文件无法加载，因为Python默认文件为ASCII编码的，当读取到一个非ASCII字符时，这个字符无法被读取。
</p>


<p>
文件被读取出来后，它在内存的表示是什么样的呢？首先，将文件从硬盘中读取到内存中的过程，有一个解码的过程。对于ASCII，文件在硬盘中保存的格式和内存中的格式是一样的，都是对应的数字。也即解码和编码对应的内容是相同的。
</p>

<p>
对于UTF8，解码后则为Unicode。为什么需要编码？因为编码可以节省保存空间。如果不是这个因素，则编导和解码没有必要存在。UTF8和UTF16分别是编码Unicode的不同的编码方式。Unicode由两个字节组成，所有的字符都要占两个字节。但通过UTF8编码之后，大多数常用的字符都可以用一个字节来编码，达到节省存储空间的目的。同时有些字符需要三个字节才能编码，但由于这些字符相对较少，所以整体来说，存储空间会变小。关于Unicode和UTF8关系可看<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">这里</a>
</p>


<p>
Python中的字符串是用什么格式保存的呢？
</p>

<p>
字符串保存有两种格式：一个是8bit的字符串，这个字符串是编码过后的。另外一种是Unicode字符串，这个字符串是未编码的。 <a href="https://www.pythoncentral.io/python-unicode-encode-decode-strings-python-2x/%0A">这篇文章</a>有详细的介绍。
</p>

<p>
对于一个8bit的字符串，其包含的内容就是解码后的内容。具体的编码格式有可能是就ASCII，也有可能 是UTF8。也可以认为字符串就是一个8bit的字节序列。一个容易弄混淆的概念是，尽管这个字符串是已经编码过后的内容，它仍然可以继续被编码。
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'abc'</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</pre></div>

<p>
这是一种错误的用法，除了Unicode字符串，编码一个8bit字符串是错误的用法。但Python在这里做了一个workaround，即当其发现encode函数被一个8bit字符串调用时，它首先会将这个字符串decode为Unicode字符串，然后在这个Unicode字符串上调用encode函数。以上代码与以下代码等价。
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'abc'</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</pre></div>
<p>
其中s.decode()的结果是一个Unicode字符串。
</p>

<p>
编码时出现的一个错误是，unicodedecordererror ascii codec can decode …..
</p>


<p>
在解析器中输入字符串儿
</p>

<p>
具体的过程是：解析器得到这个字符串时，已经是被编码过后的。相当于是操作系统传递给解析器的。而传输的格式也是编码后的内容。而具体的编码格式是由操作系统决定的。也即解析器默认使用的编码格式。
</p>


<p>
Encoding 是将Unicode字符串转化为8bit字符串。有多种编码格式供选择，如UTF8，UTF16，UTF32。但也可以使用ASCII作为编码格式。此时编码规则为：
</p>
<ul class="org-ul">
<li>如果Unicode的值小于128，则转化为相应的ASCII字符
</li>
<li>否则，则抛出一个异常。
</li>
</ul>
<p>
以上编码过程对于latin1也是一样，只不过此时Unicode的值小于256都被认为正常的字符。
</p>


<p>
<a href="https://docs.python.org/2/howto/unicode.html">这篇文章</a>里讲解了Unicode编码为UTF8的优点。
</p>


<p>
Python Unicode的实现应该就是一个数字数组，每个元素是一个数字，这个数字表示Unicode的值。
</p>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-cookbook-readnote-5/" rel="bookmark">July 30, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-cookbook-readnote-5/">Python Cookbook 读书笔记（五）</a></h1>
                </div>
                <div class="entry-content">
                        <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">chapter 8: Classes and Objects</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">8.1. Changing the String Representation of Instances</h3>
<div class="outline-text-3" id="text-1-1">
<p>
It's good practice to define both _<sub>repr</sub>_<sub>()</sub> and _<sub>str</sub>_<sub>()</sub></p>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">the _<sub>repr</sub>_<sub>()</sub> method of a class: the literal representation of a object</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
eval(repr(x)) = x
It it not possiable to create an object from the repr(x) results, then the repr(x) result should be enclosed in '&lt;&gt;' 
</p>
</div>
</div>

<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">the _<sub>str</sub>_<sub>()</sub> method of a class: the toString method  of a object</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
The method will be called  when the object is passed to print() function
If _<sub>str</sub>_<sub>()</sub> is not provided, then _<sub>repr</sub>_<sub>()</sub> will be used.
</p>
</div>
</div>

<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3">the format function: positional field, by {N}, N means the nth parameter</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
ValueError: cannot switch from manual field specification to automatic field numbering
If you put a numbers to a field, then you should put numbers to all field.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">'{0}, {1},  {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

<p>
Get an object's attribute by {N.attt<sub>name</sub>} syntax
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">'{0}, {0.chain}, {0.permutations}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itertools</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

<p>
for {0!r} or {0!s}, '!r' means use _<sub>repr</sub>_<sub>()</sub>, '!s' means use _<sub>str</sub>_<sub>()</sub>. '!s' is the default value.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">8.2. Customizing String Formatting</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1">the format(aobj[, format<sub>spec]</sub>) builtin function</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
The function is equal to: aobj._<sub>format</sub>_<sub>(format<sub>spec</sub>)</sub>
而一般的aobj._<sub>format</sub>_<sub>(spec)</sub> 的实现是调用 str.format(…) 函数来实现。
</p>

<p>
str.format(…) method 还支持关键字参数来指定field name.(问题：当关键字参数与普通参数混合时会发生什么？)
{:spec} 中的 spec 会传给 aobj._<sub>format</sub>_<sub>(format<sub>spec</sub>)</sub> 作为参数。 spec 可以为任意字符串，它可以作为参数传递给aobj._<sub>format</sub>_<sub>()</sub> method.
</p>

<p>
str.format(aobj)时， 到底是哪个method会被调用呢？
From below codes, it can be see that if <span class="underline"><span class="underline">format</span></span> method is defined, then <span class="underline"><span class="underline">format</span></span> will be called. else <span class="underline"><span class="underline">str</span></span> will be called, when the object is formated by the str.format(…) method.
For str(aobj), aobj._<sub>str</sub>__ will always be called.
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__repr__ called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'Point({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__str__ called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__format__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__format__ called. spec: </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">spec</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">'{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">[NOT FINISHED]8.3. Making Objects Support the Context-Management Protocol, that is, the with statement</h3>
<div class="outline-text-3" id="text-1-3">
<p>
To provide with statement support, just define two methods:
</p>
<ol class="org-ol">
<li>_<sub>enter</sub>_<sub>(self)</sub>
</li>
<li>_<sub>exit</sub>_<sub>(self, exc<sub>ty</sub>, exc<sub>val</sub>, tb)</sub>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SaveVar</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avar</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">avar</span> <span class="o">=</span> <span class="n">avar</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__enter__ called"</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">8.5. Encapsulating Names in a Class</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1">one underscore _ means private variable, just convention, you can still access that  variable outside  of a class</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_age</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_age</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2">two underscore __ means name mangling, when used for inheritance</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
the variable will be renamed to _C_<sub>name</sub>. Then it will not override the super class's variable.
Because it is also has one leading underscore, so the rules for one underscore also applies.
</p>

<p>
_<sub>age</sub> is renamed to _Person_<sub>age</sub>:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">__age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__age</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_Person__age</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">8.6. Creating Managed Attributes, with @property decorator/annotation, add a setter, getter, deleter to a field</h3>
<div class="outline-text-3" id="text-1-5">
<p>
Steps:
</p>
<ol class="org-ol">
<li>first create a property object by @property decorator, on a getter method. The name of the getter should be the same with the attribute field.
</li>
<li>create the setter object: by @attribute<sub>name</sub>.setter, on a setter method. The name of the setter should be the same with the attribute field.
</li>
<li>the getter, setter function are a way to define what will be called when the attribute with the same name is get,  set. 
e.g. the attribute name is 'foo', then the 'foo' attribute will be a object that has methods: 'getter', 'setter', 'deleter'. You can choose any name to store the real value for this  attribute, but the most common value will be add a underscore, that is '<sub>foo'</sub>.
Type of 'foo' is &lt;class 'property'&gt;

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="c1"># here the name attribute is depend on the def name(self) getter function. Not the reverse.</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"getting name"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameL</span>

    <span class="nd">@name.setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"setting name"</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span>

	<span class="bp">self</span><span class="o">.</span><span class="n">nameL</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">create caculate attribute by @property, getter, setter, then the attribute works like a attribute,  not a method</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Seems a good application of @property.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Circle</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radis</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">radis</span> <span class="o">=</span> <span class="n">radis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"getting area"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">radis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">radis</span><span class="o">*</span><span class="mf">3.14</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">radis</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">8.7. Calling a Method on a Parent Class, by super() function</h3>
<div class="outline-text-3" id="text-1-7">
<p>
There are many format
</p>
<div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">()</span> <span class="c1"># unbound</span>
<span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="c1"># isinstance(obj, type)</span>
<span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">type2</span><span class="p">)</span> <span class="c1"># issubclass(type2, type). issubclass(object, object) is True</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">8.9. Creating a New Kind of Class or Instance Attribute, by creating a descriptor class for the type</h3>
<div class="outline-text-3" id="text-1-8">
<p>
如果一个类定义了三个函数： <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span>, <span class="underline"><span class="underline">delete</span></span>, 则它是一个descriptor, 可能通过它来为一个instance的attribute添加一些get, set时的函数。
</p>

<p>
@property 只是descriptor的一种表象， descriptor是最底层，最灵活的实现，在库中大量使用。 TODO： 可以再研究下基于descriptor， @property的实现。
</p>

<p>
调用顺序：如果descriptor对应的class attribute 存在, 则总会优先调用这个descriptor的函数，来获取或设置attribute的值。
但当descriptor只定义了_<sub>get</sub>_<sub>方法时，则如果同名的变量在instance</sub>._<sub>dict</sub>_<sub>中存在，则会优先从instance</sub>._<sub>dict</sub>_<sub>中获取。</sub></p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Integer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__get__ method called, name: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
	<span class="c1"># If instance is None, then it is the class attribute</span>
	<span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__set__ method called, name </span><span class="si">%s</span><span class="s2">, value: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
	<span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="c1"># 关键的是量的值，输入参数的值只是用于内部实现的。并且Integer的实现中使用instance.__dict__保存数据也只是一种实现方式。</span>
    <span class="c1"># Point.x决定了atribute的名称为x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="s1">'z'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"p.x"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="c1"># setattr(p, 'x', 5)</span>
<span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">8.10. Using Lazily Computed Properties, an application of descriptor</h3>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">8.11. Simplifying the Initialization of Data Structures, by define a common base class</h3>
<div class="outline-text-3" id="text-1-10">
<div class="highlight"><pre><span></span><span class="c1"># python  is very flexiable</span>
<span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'Expected {} arguments'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)))</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
	    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'{}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">]</span>
    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     return '(x: {0.x}, y: {0.y})'.format(self)</span>

<span class="k">class</span> <span class="nc">Circle</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'radius'</span><span class="p">]</span>
    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     return '(radius: {0.radius})'.format(self)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">class attributes can also be accessed by instance object, such as self, but only when the same instance attribute not exists</h3>
<div class="outline-text-3" id="text-1-11">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">class_attr</span> <span class="o">=</span> <span class="s2">"ABC"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">'BB'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">class_attr</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">class_attr</span> <span class="ow">is</span> <span class="n">Foo</span><span class="o">.</span><span class="n">class_attr</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="n">class_attr</span> <span class="o">=</span> <span class="s2">"ABC"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">class_attr</span> <span class="o">=</span> <span class="n">a</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">(</span><span class="s1">'BB'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">class_attr</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">class_attr</span> <span class="ow">is</span> <span class="n">Bar</span><span class="o">.</span><span class="n">class_attr</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">8.12. Defining an Interface or Abstract Base Class</h3>
<div class="outline-text-3" id="text-1-12">
</div>
<div id="outline-container-sec-1-12-1" class="outline-4">
<h4 id="sec-1-12-1">create an abstract base class, or interface, by abc.ABCMeta, abc.abstractmethod</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
A abstract class can't be initialized.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="k">class</span> <span class="nc">IStream</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxbytes</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
	<span class="k">pass</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="k">pass</span>

<span class="c1"># typical usage:</span>
<span class="k">def</span>  <span class="nf">foo</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">IStream</span><span class="p">):</span>
	<span class="c1"># processing an IStream here</span>
	<span class="k">pass</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">IStream</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-12-2" class="outline-4">
<h4 id="sec-1-12-2">register another class to a 'sub class ' of a abstract base class, by abc.register(cls) function</h4>
<div class="outline-text-4" id="text-1-12-2">
<p>
Then isinstance(obj, AbstractBaseClass) will be  True. This let another class which is not a subclass of a base class, but can still pass the isinstance() test, which means implementing a interface.
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="c1"># Register the built-in I/O classes as supporting our interface</span>
<span class="n">IStream</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
<span class="c1"># Open a normal file and type check</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'foo.txt'</span><span class="p">)</span>
<span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">IStream</span><span class="p">)</span> <span class="c1"># Returns True</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">8.13. Implementing a Data Model or Type System, by descriptor</h3>
<div class="outline-text-3" id="text-1-13">
<p>
感觉根之前小节讲到的descriptor相同，只不过用了继承的方式写了很多细小的descriptor。
</p>
</div>
</div>
<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14">what is a descriptor? and its usage</h3>
<div class="outline-text-3" id="text-1-14">
<p>
A descriptor is  a class attribute object, which has <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span>, or <span class="underline"><span class="underline">delete</span></span> method, is used to define how a instance attribute is get, set, and delete. When an  instance attribute is get, the descriptor's <span class="underline"><span class="underline">get</span></span> method will be called. The same thing applys to <span class="underline"><span class="underline">set</span></span> and <span class="underline"><span class="underline">delete</span></span>
</p>

<p>
In descriptor's <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span> methods, we must use instance._<sub>dict</sub>_<sub>[xxx]</sub> to get a attribute. If we use getattr(instance, xxx) to get that attribute, then there will be a recursion error as below, because the getattr() function will trigger a new call of <span class="underline"><span class="underline">get</span></span> method.
RecursionError: maximum recursion depth exceeded while calling a Python object
</p>

<p>
The relationship between the descriptor object and an instance attribute:
</p>
<ol class="org-ol">
<li>if the descriptor object is assigned to a class attribute with name 'attribute<sub>a'</sub>, then it will control the instance attribute with the same name.
</li>
<li>but there is  one exception: if only the <span class="underline"><span class="underline">get</span></span> method of a descriptor is defined, then the instance attribute with the same name will be not be controled by the  descriptor, it will be get directly from the <span class="underline"><span class="underline">dict</span></span>.
</li>
</ol>
<p>
a test:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TraceDescriptor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
	    <span class="k">print</span><span class="p">(</span><span class="s1">'Getting attribute {}, value is {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
	    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
	    <span class="c1"># return getattr(instance, self.name)</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span>


    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'Setting attribute {} to {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
	<span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Circle</span><span class="p">:</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">TraceDescriptor</span><span class="p">(</span><span class="s1">'radius'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">radius</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>

<span class="n">c</span> <span class="o">=</span>  <span class="n">Circle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15">8.16. Defining More Than One Constructor in a Class, use a class method</h3>
<div class="outline-text-3" id="text-1-15">
<p>
GP: Always only assign values in the default  constructor(<span class="underline"><span class="underline">init</span></span>), and do other things by other constructors
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Date</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>  <span class="n">d</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">y</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">m</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span>  <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">today</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({0.year}, {0.month}, {0.day})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">Date</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-16" class="outline-3">
<h3 id="sec-1-16">8.17. Creating an Instance Without Invoking init</h3>
<div class="outline-text-3" id="text-1-16">
</div>
<div id="outline-container-sec-1-16-1" class="outline-4">
<h4 id="sec-1-16-1">the object._<sub>new</sub>_<sub>(*args, **kwargs)</sub> method: create a bare object</h4>
<div class="outline-text-4" id="text-1-16-1">
<p>
Every object has a <span class="underline"><span class="underline">new_<sub>method</sub>, which is inheritantanted from type._<sub>new</sub></span></span>.
</p>

<p>
The parameter should be a type object.
</p>

<p>
When you want to create an object from a json, this method can be used.
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aspk_common</span> <span class="kn">as</span> <span class="nn">AC</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">AC</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-16-2" class="outline-4">
<h4 id="sec-1-16-2">Problem: how an object is constructed?</h4>
<div class="outline-text-4" id="text-1-16-2">
<p>
I guess first create a bare object by  calling the <span class="underline"><span class="underline">new</span></span> method, then call the object's <span class="underline"><span class="underline">init</span></span> method.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-17" class="outline-3">
<h3 id="sec-1-17">8.18. Extending Classes with Mixins</h3>
<div class="outline-text-3" id="text-1-17">
</div>
<div id="outline-container-sec-1-17-1" class="outline-4">
<h4 id="sec-1-17-1">mixin classes, used to extend function of a class, class customization, by multiple inheritance</h4>
<div class="outline-text-4" id="text-1-17-1">
<p>
SOLVED, see another comment. How below codes works? For 'super()._<sub>getitem</sub>_<sub>(key)</sub>', why dict._<sub>getitem</sub>__ method will be called?
</p>

<p>
After figuring out MRO, then I know how a mixin class works:
Mixin class is used to customize an existing class.
It make use of  MRO of multiple inheritance. Suppose 'Base' is the class to be customized, 'Mixin' is the mixin class, 'Foo' is the result  class, then the typical syntax is:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Mixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>
That is, put the mixin class as the first parent class, and the Base class as the second class. Then e.g. you want change a method of Base's behavier, such as 'foo', then you can just define a method named 'foo' in Mixin, and doing some work, then call 'super().foo(…)' to call Base's foo method.
</p>

<p>
Works like a decorator pattern.
</p>

<p>
But  what's difference between this method and by directly define the 'foo' method in Foo?
=&gt; maybe the main benifet is that  by putting the codes to a Mixin class, the codes can be easily reused.
</p>


<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aspk_common</span> <span class="kn">as</span> <span class="nn">AC</span>
<span class="k">class</span> <span class="nc">Logging</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'Getting {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'self: {}</span><span class="se">\n</span><span class="s1">super: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">super</span><span class="p">()))</span>
	<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LoggingDict</span><span class="p">(</span><span class="n">Logging</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">LoggingDict</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-18" class="outline-3">
<h3 id="sec-1-18">mutiple inheritance: how method/attribue are resolved if they exists in more than one  super classes</h3>
<div class="outline-text-3" id="text-1-18">
<p>
A method/attribute is resolved in the order of all parent class given.
e.g: 
class Foo(A, B)
if a method 'aaa' is defined in  both A and B, then A.aaa will be used.
</p>
</div>
</div>

<div id="outline-container-sec-1-19" class="outline-3">
<h3 id="sec-1-19">python multiple inheritance, super and MRO(method resolution order)</h3>
<div class="outline-text-3" id="text-1-19">
<p>
Guoid's words:
<a href="http://python-history.blogspot.fi/2010/06/method-resolution-order.html">http://python-history.blogspot.fi/2010/06/method-resolution-order.html</a>
depth first, from left to right, then delete all same classes expect the last one. Then diamond problem is solved.
</p>

<p>
For below code snippets:
From the printout, super() will return the next class in MRO(method resolve order) list, given a current class. The next class can be a real parent class for current class, or if the real parent class not exists,  then the next class will be the next parent class of the  current instance. For both two conditions, they are always the same class in MRO.
</p>

<p>
For below codes: the MRO is [C, A, B].
</p>
<ul class="org-ul">
<li>So super() in class C's result is A
</li>
<li>super() in  class A is B
</li>
<li>super() in class B is object(I guess)
</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>
	<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"C"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>
	<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"MRO of C: "</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"MRO() of C: "</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">mro</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-20" class="outline-3">
<h3 id="sec-1-20">8.19. Implementing Stateful Objects or State Machines</h3>
<div class="outline-text-3" id="text-1-20">
<p>
Implementing the state pattern, by creating class for each state. In a class for one state, only define the method  use to handle the current state, all other methods should raise a 'NotImplementedError'.
Will see this latter
</p>
</div>
</div>

<div id="outline-container-sec-1-21" class="outline-3">
<h3 id="sec-1-21">8.20. Calling a Method on an Object Given the Name As a String, by getattr</h3>
<div class="outline-text-3" id="text-1-21">
<p>
A method is just an attribute of an object, so first get the method by 'getattr' given string name
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">)()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-22" class="outline-3">
<h3 id="sec-1-22">8.20. Calling a Method on an Object Given the Name As a String, by operator.methodcaller(name, *args)</h3>
<div class="outline-text-3" id="text-1-22">
<p>
The benifit of methodcaller is that it will fix all parameters of the method. So if the method will be  called given same parameters for many differenntt object, this method might be better
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"foo: {}, {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="n">operator</span><span class="o">.</span><span class="n">methodcaller</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-23" class="outline-3">
<h3 id="sec-1-23">8.21. Implementing the Visitor Pattern</h3>
<div class="outline-text-3" id="text-1-23">
<p>
感觉这里所说的vistor pattern主要是对用于处理包含不同类型对象的list. 用于通用处理。
基于类型系统的visitor pattern, 是通过在不同的基础类中的accept函数来实现 dispatch table的。相当于把dispatch table也耦合在基础类定义中了。
但最本质的目的是对于不同类型的对象，客户代码使用相同的代码进行处理。
</p>

<p>
将dispatch table 做在哪里，只影响一点点写法，对最终达到的效果没影响。
</p>


<p>
例子：
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Visitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="n">methname</span> <span class="o">=</span> <span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
	<span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="n">meth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span>
	<span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'No {} method'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">File</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="k">class</span> <span class="nc">RegularFile</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">read_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s2">"This is the content for file {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Directory</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">'''Return all children names as a list'''</span>
	<span class="k">return</span> <span class="p">[</span><span class="n">RegularFile</span><span class="p">(</span><span class="s1">'a.txt'</span><span class="p">),</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'b.exe'</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Symbolic</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">'''Return real file this symbolic point to'''</span>
	<span class="k">return</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'dd.txt'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CatVisitor</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>
    <span class="sd">'''Implement cat command for a File object.'''</span>
    <span class="k">def</span>  <span class="nf">visit_RegularFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for regular file {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="k">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">read_content</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">visit_Directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for directory {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">visit_Symbolic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for symbolic file {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">real</span><span class="p">())</span>

<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">RegularFile</span><span class="p">(</span><span class="s1">'foo.txt'</span><span class="p">),</span> <span class="n">Directory</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">),</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'a.txt'</span><span class="p">),</span> <span class="n">Symbolic</span><span class="p">(</span><span class="s1">'aa.c'</span><span class="p">)]</span>
<span class="n">visitor</span> <span class="o">=</span> <span class="n">CatVisitor</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-24" class="outline-3">
<h3 id="sec-1-24">dispatch table in python, decided by object type</h3>
<div class="outline-text-3" id="text-1-24">
<p>
将所有处理函数写在一个类中， 提供一个根据待处理对象类型分发的函数。 这个作为dispatch 基类。然后再定义针对每种类型的visit函数就行了。
这里类有两个目的：
</p>
<ol class="org-ol">
<li>定义dispatch table
</li>
<li>对一组函数的名字空间吧。
</li>
<li>以下例子中实现的 Dispatcher class 是通用的，可以共用。
</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dispatcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="n">methname</span> <span class="o">=</span> <span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
	<span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="n">meth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span>
	<span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'No {} method'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">FooDispatcher</span><span class="p">(</span><span class="n">Dispatcher</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">visit_RegularFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">pass</span>
    <span class="k">def</span> <span class="nf">visit_Directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">pass</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-25" class="outline-3">
<h3 id="sec-1-25">8.23. Managing Memory in Cyclic Data Structures, by weakref.ref(aobject)</h3>
<div class="outline-text-3" id="text-1-25">
<p>
When cyclic reference exists, the some  object will never be deleted, because its reference coutns is  large than 0.
A weakref is just a reference that don't increase the reference count. To dereference, just call it like a function. If the referenced object still exists, the object will be returne, otherwise None will be returned.
</p>

<p>
For a tree structure, the book give an example of reference the parent node by  weakref.
</p>

<p>
Note: you can't weakref to 'int', 'str', …
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="c1"># c = a     # if this line exists, then a will not be deleted after 'del a', then the second call to b() will still return a</span>

<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">())</span>
<span class="k">del</span> <span class="n">a</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">())</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-26" class="outline-3">
<h3 id="sec-1-26">8.24. Making Classes Support Comparison Operations, by define many comparision builtin method: <span class="underline"><span class="underline">eq</span></span>, <span class="underline"><span class="underline">lt</span></span>, <span class="underline"><span class="underline">le</span></span>, <span class="underline"><span class="underline">gt</span></span>, <span class="underline"><span class="underline">ge</span></span>, <span class="underline"><span class="underline">ne</span></span>
</h3>
</div>
<div id="outline-container-sec-1-27" class="outline-3">
<h3 id="sec-1-27">8.25. Creating Cached Instances, by  create a factory method(a class method)</h3>
<div class="outline-text-3" id="text-1-27">
<p>
If the parameter are the same, then return an existing object.
</p>
</div>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-object-attribute/" rel="bookmark">July 26, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-object-attribute/">Python 对象属性（一）</a></h1>
                </div>
                <div class="entry-content">
                        <p>
所有的Python 对象都有属性，可以通过 <span class="underline">obj.name</span> 这样的语法来获取属性，通过 obj.name = 'Tom' 这样的语法添加一个属性或更新属性的值（如果这个属性已存在），通过 <code>del obj.name</code> 删除一个属性。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">特殊属性和自定义属性</h2>
<div class="outline-text-2" id="text-1">
<p>
根据属性保存位置的不同，可以将属性分类为特殊属性和自定义属性。先来看一个例子。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="ow">is</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'__class__'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'My class'</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'bar'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'xxx'</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
</pre></div>

<p>
结果为：
</p>

<pre class="example">
{}
{'name': 'Tom'}
True
&lt;class '__main__.Foo'&gt;
&lt;class '__main__.Foo'&gt;
xxx
</pre>

<p>
从这个例子中，我们可以看出：
</p>
<ul class="org-ul">
<li>我们为一个对象新添加的属性都会被保存在 '<span class="underline"><span class="underline">dict</span></span>' 这个特殊属性中，'<span class="underline"><span class="underline">dict</span></span>'的类型是字典。如在添加了 name 这个属性后， <span class="underline"><span class="underline">dict</span></span> 的值变为 {'name': 'Tom'}，添加前为一个空字典。
</li>
<li>对于我们自己新添加的属性，可以通过两种方式来访问这个属性： f.name 和 f.__dict__['name']。这两种方式的效果完全相同，因为它们代表的是同一个变量。因此可认为 f.name 是 f.__dict__['name'] 的一种简写方式。
</li>
<li>对于任意的属性，f.xyz 的解析过程为：1. 首先检查xyz这个属性在对象中是否存在，如存在，则返回这个属性。2. 否则再检查 xyz这个属性在f.__dict__是否存在，如存在，则返回这个属性。
    如上面代码里，尽管我们通过直接在__dict__为对象添加一个名为__class__的属性，但由于这个属性对象本身就定义了，因此它还是原来的值。也即在以上第一步中即找到了这个属性。 而对于'bar' 属性，添加后再查询就是我们添加的值，在以上第2步中找到这个属性。
</li>
</ul>
<p>
因此可将一个python对象理解为一个C语言中的结构体，这个结构体的成员在对象创建后，就固定了，无法再添加新的成员。在本文中我们称这些属性为特殊属性。但实际上我们又是可以为一个对象添加新的属性的，这是怎么做到的呢？答案是每个对象都有一个名为__dict__的特殊属性，这个属性的类型为字典，所有新添加的属性都会被保存在这个字典里，在本文中我们称新添加的属性为自定义属性。但python向用户屏蔽两种属性的差别，提供了统一的语法来访问它们，也即通过 <code>obj.name</code> 。这个在大多数情况下会带来便利性，但有时会带来含混，此时我们需要弄清楚到底一个属性是一个特殊属性还是自定义属性。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">一些例子</h2>
<div class="outline-text-2" id="text-2">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'Tom'</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">pass</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>
</pre></div>

<p>
结果为：
</p>

<pre class="example">
{'id': 1, 'name': 'Tom'}
&lt;bound method Foo.foo of &lt;__main__.Foo object at 0x000000B2509ECFD0&gt;&gt;
</pre>

<ul class="org-ul">
<li>可见一个类的__init__函数对self添加的属性，都将成为这个类实例对象的自定义属性，如例子中的id 和name两个属性。
</li>
<li>类中定义的函数，将成为类实例的特殊属性，如例子中的foo这个属性，它的类型是method.
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">对象属性的分类及一些例子</h2>
<div class="outline-text-2" id="text-3">
<p>
对于任何对象，其属性可分为两种(以下说的都是自己的属性，不包括父类的属性)：
</p>
<ol class="org-ol">
<li>用户自定义属性。
</li>
<li>语言定义属性
</li>
</ol>
<p>
对于一个class object，其两种属性可能包含：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">用户自定义属性</th>
<th scope="col" class="left">语言定义属性</th>
</tr></thead>
<tbody>
<tr>
<td class="left">所有类变量</td>
<td class="left"><span class="underline"><span class="underline">mro</span></span></td>
</tr>
<tr>
<td class="left">所有类函数</td>
<td class="left"><span class="underline"><span class="underline">dict</span></span></td>
</tr>
<tr>
<td class="left">所有类描述符</td>
<td class="left"> </td>
</tr>
<tr>
<td class="left"><span class="underline"><span class="underline">doc</span></span></td>
<td class="left"> </td>
</tr>
<tr>
<td class="left"><span class="underline"><span class="underline">module</span></span></td>
<td class="left"> </td>
</tr>
</tbody>
</table>
<p>
那么如何为一个class object添加自定义属性？
在定义一个类时，一个def 语句将添加一个类函数到自定义属性; 一个赋值语句将添加一个类变量到自定义属性。
</p>

<p>
注：其实对于class object, 它也是type class object 的instance
</p>

<p>
对于一个instance object, 其两种属性可能包含：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">用户自定义属性</th>
<th scope="col" class="left">语言定义属性</th>
</tr></thead>
<tbody>
<tr>
<td class="left">所有属性</td>
<td class="left"><span class="underline"><span class="underline">class</span></span></td>
</tr>
<tr>
<td class="left"> </td>
<td class="left"><span class="underline"><span class="underline">dict</span></span></td>
</tr>
</tbody>
</table>
<p>
问题： str.__class__ 是一个语言定义属性还是继承自 其父类 object 的__class__ 用户自定义属性（也即object.__dict__['<span class="underline"><span class="underline">class</span></span>'], 这个是一个'attribute'）？
应该是一个语言定义属性，应该来自于 object.__dict__['<span class="underline"><span class="underline">class</span></span>']， 也可能是
</p>

<p>
问题二： str.__mro__ 的结果是： (str, object). 但我不知道这个成员来自于何处。 str.__dict__和object.__dict__里都没有。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">__dict__属性的作用</h2>
<div class="outline-text-2" id="text-4">
<p>
__dict__属性是一个语言定义属性，它用来保存所有的用户自定义属性。
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">属性的查找机制</h2>
<div class="outline-text-2" id="text-5">
<p>
x.name 等价于 getattr(x, 'name')，
</p>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-cookbook-readnote-4/" rel="bookmark">July 25, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-cookbook-readnote-4/">Python Cookbook 读书笔记（四）</a></h1>
                </div>
                <div class="entry-content">
                        <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">chapter 5: Files and I/O</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">5.1. Reading and Writing Text Data</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">open a file</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
the 't' in mode means text.
</p>
<div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="c1">#read</span>
<span class="c1"># f = open('1.txt', 'wt') #write</span>
<span class="c1"># f = open('1.txt', 'at') #append</span>

<span class="c1"># specify codec</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'latin-1'</span><span class="p">)</span> <span class="c1">#read</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'latin-1'</span><span class="p">)</span> <span class="c1">#write</span>

<span class="c1">#disable newline translation, by use the open(newline='') option</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> <span class="c1">#read</span>

<span class="c1"># specify what to do when encountering decoding/encoding errors, by use open(errors='...') option</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span> <span class="c1">#replace the char that can't be decoded to a unicode char U+fffd(which is the unicode replacemenet char)</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span> <span class="c1">#just ignore the char that can't be decoded</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">read whole content of a file as a string</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3">read/iterate each line of a file, by just treat the file object as a generator</h4>
<div class="outline-text-4" id="text-1-1-3">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4">write str to a file, by file.write(text) method</h4>
<div class="outline-text-4" id="text-1-1-4">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'abced'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">get system's default encoding</h3>
<div class="outline-text-3" id="text-1-2">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">())</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">5.2. Printing to a File, redirect stdout to a file, by use print(file=…) option</h3>
<div class="outline-text-3" id="text-1-3">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"aaaaa"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">Question: how to redirect stdout to a file system widely.</h3>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">5.3. Printing with a Different Separator or Line Ending, by use print(sep=…, end=…) options</h3>
<div class="outline-text-3" id="text-1-5">
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'##'</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
<span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'List'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">pass a sequence/list object to a function as N parameters instead of one, by using *list<sub>name</sub>
</h3>
<div class="outline-text-3" id="text-1-6">
<div class="highlight"><pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'List'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">5.4. Reading and Writing Binary Data(such as image, sound files)</h3>
<div class="outline-text-3" id="text-1-7">
<p>
By saying binary data, it means that there will no encoding/decoding works during writing/reading process.
Use mode such as 'rb', 'wb', 'ab'.
</p>

<p>
当作为binary data读取时， 与作为text data相比，没有自动的decode, encode过程。
</p>

<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># f.write('aaabbb'.encode('latin-1'))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'aaabbb'</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">what is text string and byte string in python</h3>
<div class="outline-text-3" id="text-1-8">
<p>
Each element in a text string is also a text string, 
Each element in a byte string is a int
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'Hello'</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'Hello'</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">5.5. Writing to a File That Doesn't Already Exist, by set mode of open(…) function to 'x'</h3>
<div class="outline-text-3" id="text-1-9">
<p>
If the file already exists, then don't write, and will raise a FileExistsError exception
</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'xt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'aaa bbb'</span><span class="p">)</span>
</pre></div>

<p>
感觉这个根python的哲学有点类似，不事先做判断，而是用exception的方式。
具体的用法可能需要将它放在一个try catch里。
</p>
</div>
</div>

<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">5.6. Performing I/O Operations on a String, by io.StringIO() or io.BytesIO()</h3>
<div class="outline-text-3" id="text-1-10">
<p>
a typecal application can be simulate a file when do unit testing.
</p>
</div>
</div>

<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">5.7. Reading and Writing Compressed Datafiles, by use gzip.open(…), or bz2.open(…)</h3>
<div class="outline-text-3" id="text-1-11">
<p>
After open the file, other operations are just the same as normal file.
</p>
</div>
</div>

<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">5.8. Iterating Over Fixed-Sized Records, by iter(callable, sentinel)</h3>
<div class="outline-text-3" id="text-1-12">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="n">RECORD_SIZE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">RECORD_SIZE</span><span class="p">),</span> <span class="s1">''</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'; '</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">the functools.partial(func, *args, **kwargs) function: create a new callable from a given callable with some(partial) arguments fixed. Currying</h3>
<div class="outline-text-3" id="text-1-13">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="n">b</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">b</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">())</span>
</pre></div>

<p>
写一个能够接收很多参数的函数，然后利用partial 来生成简易的使用接口。需要注意参数的顺序。
</p>
</div>
</div>

<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14">5.9. Reading Binary Data into a Mutable Buffer</h3>
</div>

<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15">5.10. Memory Mapping Binary Files, map a binary file to memory(byte array), my mmap.mmap(…) method</h3>
<div class="outline-text-3" id="text-1-15">
<p>
This is a general method to map file to memory, then you can random access the content of the file, such as by using slicing
</p>

<p>
After mapped, by change the value of the array will change the file's content. This is also a way for multiple intepreter comunication.
Below is a general function that map a file to a byte array.
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mmap</span>

<span class="k">def</span> <span class="nf">memory_map</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">ACCESS_WRITE</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">access</span><span class="p">)</span>

<span class="c1"># below is application of the function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">memory_map</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
<span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'EEF'</span>
</pre></div>
</div>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-why-not-use-getter-setter/" rel="bookmark">July 24, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-why-not-use-getter-setter/">无需为Python类添加 getter 和 setter</a></h1>
                </div>
                <div class="entry-content">
                        <p>
Getter 和 setter在java中被广泛使用。一个好的java编程准则为：将所有属性设置为私有的，同时为属性写getter和setter函数以供外部使用。 这样做的好处是属性的具体实现被隐藏，当未来需要修改时，只需要修改getter 和 setter即可，而不用修改代码中所有引用这个属性的地方。可能做的修改为：
</p>
<ul class="org-ul">
<li>在获取或设置属性时打一条日志
</li>
<li>设置属性时，对值对进检查
</li>
<li>设置发生时， 修改设置的值
</li>
<li>获取属性时，动态地计算值
</li>
</ul>
<p>
可谓是好处多多，getter和setter为变量访问提供了灵活的方式。
</p>

<p>
但python中情况却不同，因为对象属性访问的机制不同。java中需要为变量写getter和setter的原因为：当我们写这样的表达式 <code>person.name</code> 来获取一个 <code>person</code> 对象的 <code>name</code> 属性时，这个表达式的意义是固定的，它就是获取这个属性，而不可能触发一个函数的调用。但对于python, 这个表达式即可能是直接获取一个属性，也可能会调用一个函数。这取决 <code>Person</code> 类的实现方式。也就是说，python的对象属性访问的语法，天然就提供了getter和setter的功能。
</p>

<p>
由于这个区别，我们没有必要在python中为每个对象的属性写getter和setter。最开始时，我们总是将属性作为一个直接可访问的属性。当后续需要对这个属性的访问进行一些控制时，我们可以将其修改为函数触发式属性。在修改前后，调用这个对象属性的代码不用修改，因为还是使用相同的语法来访问这个属性。
</p>

<p>
可以使用@property 装饰器将一个直接访问的属性转变为函数触发式属性。如下所示，使用@property前的代码为
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">"Tom"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

<p>
代码的输出为：
</p>
<div class="highlight"><pre><span></span><span class="n">Tom</span>
</pre></div>

<p>
此时为直接访问 <code>name</code> 这个属性。当我们需要确保 <code>name</code> 是一个字符串时，可以使用 @property 装饰器将属性转变为一个函数调用，如下所示。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"get name called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name.setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"set name called"</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected a string"</span><span class="p">)</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">"Tom"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

<p>
代码的输出为：
</p>
<div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">name</span> <span class="n">called</span>
<span class="n">get</span> <span class="n">name</span> <span class="n">called</span>
<span class="n">Tom</span>
</pre></div>

<p>
可以看出
</p>
<ul class="org-ul">
<li>在创建Person对象时(代码的倒数第二行)， 用于set name的函数被调用。这个函数会检查输入是否为一个字符串，如不是则raise一个TypeError
</li>
<li>在获取属性时（代码的最后一行），用于get name的函数被调用
</li>
<li>在修改前后，使用Person类的代码完全相同
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">总结</h2>
<div class="outline-text-2" id="text-1">
<p>
Python中对象访问的语法即可能是直接访问这个属性，也可能是调用一个函数，这取决于类的实现方式。我们可以在不修改调用者代码的前提下，轻松切换这两种方式。可见python原生就提供了添加额外getter和setter所带来的好处。因此没有必要一开始就为对象属性编写getter和setter函数，而是在需要时切换到函数调用式属性。
</p>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-cookbook-readnote-3/" rel="bookmark">July 20, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-cookbook-readnote-3/">Python Cookbook 读书笔记（三）</a></h1>
                </div>
                <div class="entry-content">
                        <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">chapter 4: Iterators and Generators</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">4.1. Manually Consuming an Iterator, by next(iterator[, default]) function</h3>
<div class="outline-text-3" id="text-1-1">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'python-cookbook-3rd.org'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">open(filename, …) function will return a iterator of lines in that file</h4>
</div>
<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">a list object is not an iterator</h4>
</div>
<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3">use the iter(iterable) function to create an iterator given an iterable</h4>
</div>
<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4">the for x in X syntax works both for iterator and list object</h4>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">iterator and iterable</h3>
<div class="outline-text-3" id="text-1-2">
<p>
An object is said to be iterable if it has the <span class="underline"><span class="underline">iter</span></span> method defined.
The _<sub>iter</sub>_<sub>()</sub> will reutrn the iterator object.
</p>

<p>
An object is said to be a iterator if it has following method defined:
</p>
<ol class="org-ol">
<li>
<span class="underline"><span class="underline">iter</span></span>: which return itself
Can be tested the it._<sub>iter</sub>_<sub>()</sub> == it is true
</li>
<li>
<span class="underline"><span class="underline">next</span></span>: return the next value every time it is invoked. 
</li>
</ol>
<p>
So an iterator is an iterable,  call iter(iterable) to get an iterator.
</p>


<p>
The iter(iterable) function: 
it will return 'iterable._<sub>iter</sub>_<sub>()</sub>'
</p>


<p>
So if obja is an iterable, then iter(obja) equal obja._<sub>iter</sub>() 
</p>
<div class="highlight"><pre><span></span><span class="n">obja</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">ia</span> <span class="o">=</span> <span class="n">obja</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
<span class="n">ib</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">obja</span><span class="p">)</span>
<span class="n">ic</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ia</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ib</span> <span class="ow">is</span> <span class="n">ic</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">ia</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">ib</span><span class="p">))</span>
</pre></div>

<p>
if obja is iterator, then iter(obja) and obja is the same object.
</p>


<p>
A good ref: <a href="http://www.shutupandship.com/2012/01/understanding-python-iterables-and.html">http://www.shutupandship.com/2012/01/understanding-python-iterables-and.html</a>
</p>
</div>
<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1">a example of create a iterable class</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">MyListIter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyListIter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">""" A sample implementation of a list iterator. NOTE: This is just a </span>
<span class="sd">    demonstration of concept!!! YOU SHOULD NEVER IMPLEMENT SOMETHING LIKE THIS!</span>
<span class="sd">    Even if you have to (for any reason), there are many better ways to </span>
<span class="sd">    implement this."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>         
	    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">MyList</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ia</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'type(a): </span><span class="si">%r</span><span class="s1">, type(ia): </span><span class="si">%r</span><span class="s1">'</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">ia</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span> 
	<span class="k">print</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">how does the for in loop works</h3>
<div class="outline-text-3" id="text-1-3">
<ol class="org-ol">
<li>it first get the iterable's iterator object, by calling its _<sub>iter</sub>_<sub>()</sub> method
</li>
<li>get the element by invoke the iterator's _<sub>next</sub>_<sub>()</sub> method, and bind the value to the variable.
</li>
<li>stop when an 'StopIteration' exception happens.
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">the next(iterator) function</h3>
<div class="outline-text-3" id="text-1-4">
<p>
it just return iterator._<sub>next</sub>_<sub>()</sub></p>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">the iter(iterable) function</h3>
<div class="outline-text-3" id="text-1-5">
<p>
it just return iterable._<sub>iter</sub>_<sub>()</sub></p>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">the len(obj) function</h3>
<div class="outline-text-3" id="text-1-6">
<p>
it just return obj._<sub>len</sub>_<sub>()</sub></p>
</div>
</div>
<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">4.2. Delegating Iteration</h3>
<div class="outline-text-3" id="text-1-7">
<p>
When create a class the with a underline container, just define an _<sub>iter</sub>_<sub>()</sub> method that forward the request to the underlineing container object.
</p>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">4.3. Creating New Iteration Patterns with Generators</h3>
</div>
<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">what is a generator?</h3>
<div class="outline-text-3" id="text-1-9">
<p>
a generator is a function that contains at lease one 'yeild' statement.
</p>

<p>
Unlike normal function, it's boyd will not be executed when it is be called, instead, it will return a generator object.
</p>
</div>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">4.4. Implementing the Iterator Protocol</h3>
<div class="outline-text-3" id="text-1-10">
<p>
use the generator instead of the <span class="underline"><span class="underline">next</span></span> method, which will be much simple.
</p>

<p>
使用yeild 创建一个Tree Node,比使用_<sub>next</sub>_<sub>函数简单多了。</sub></p>

<p>
yeild from syntax.
</p>
</div>
</div>
<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">4.5. Iterating in Reverse, by the reversed(obj) function</h3>
<div class="outline-text-3" id="text-1-11">
<p>
reversed only  works if the obj
</p>
<ul class="org-ul">
<li>the obj defined a _<sub>reversed</sub>_<sub>()</sub> method. or
</li>
<li>the obj's size can be determined.
</li>
</ul>
<p>
It returns an iterator.
</p>

<p>
For example, a file handler returned by the 'open()' function can't be used with the reversed function. to use it, first convert it to a list, then pass it to the reversed() function.
</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"1.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">defined a customized  reversed iterator, by define the _<sub>reversed</sub>_<sub>()</sub> method</h3>
<div class="outline-text-3" id="text-1-12">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
	    <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">-=</span> <span class="mi">1</span>
	    <span class="k">return</span> <span class="n">n</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">ReversedCountDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ReversedCountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="n">orig</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span>  <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig</span><span class="o">.</span><span class="n">_start</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+=</span> <span class="mi">1</span>
	    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="c1"># if __name__ == '__main__':</span>
<span class="n">cd</span> <span class="o">=</span> <span class="n">CountDown</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># for a in cd:</span>
<span class="c1">#     print(a)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"reversed"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cd</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>


<p>
Implemet the iterator protocal by <span class="underline"><span class="underline">next</span></span> method is a little complex compared  to by  use the yield statement. The differenc is that then the object is … 
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
	<span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">n</span>
	    <span class="n">n</span> <span class="o">-=</span><span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">n</span>
	    <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">cd</span> <span class="o">=</span> <span class="n">CountDown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cd</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">print</span> <span class="p">(</span><span class="s2">"reversed"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cd</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">4.6. Defining Generator Functions with Extra State</h3>
<div class="outline-text-3" id="text-1-13">
</div>
<div id="outline-container-sec-1-13-1" class="outline-4">
<h4 id="sec-1-13-1">print the surrounding previous lines if pattern matched, by use a generator, implemented by a class</h4>
<div class="outline-text-4" id="text-1-13-1">
<p>
Here previous lines are states.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="k">class</span> <span class="nc">HistoryLines</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">histlen</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">histlen</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
	    <span class="k">yield</span> <span class="n">line</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">hist_lines</span> <span class="o">=</span> <span class="n">HistoryLines</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hist_lines</span><span class="p">:</span>
	<span class="k">if</span>  <span class="s1">'wrap'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
	    <span class="k">for</span> <span class="n">hl</span> <span class="ow">in</span> <span class="n">hist_lines</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">hl</span><span class="p">)</span>
</pre></div>

<p>
Good practice: if you need save some states, then don't use a function to create a generator, use a class.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14">4.7. Taking a Slice of an Iterator</h3>
<div class="outline-text-3" id="text-1-14">
</div>
<div id="outline-container-sec-1-14-1" class="outline-4">
<h4 id="sec-1-14-1">by use of the itertools.islice(start, end, step) functon</h4>
<div class="outline-text-4" id="text-1-14-1">
<p>
Because we don't know the size of a iterator or a generator, so we can't slice it directly.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span>  <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span> <span class="k">as</span> <span class="n">slice_iter</span>
<span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span>  <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>

<p>
The result is the  same as my impllemented one.
</p>
</div>
</div>

<div id="outline-container-sec-1-14-2" class="outline-4">
<h4 id="sec-1-14-2">a try by me,  works</h4>
<div class="outline-text-4" id="text-1-14-2">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">slice_iter</span><span class="p">(</span><span class="n">aiter</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span><span class="p">)[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">:</span><span class="n">step</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span><span class="p">):</span>
	<span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aiter</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span>  <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15">4.8. Skipping the First Part of an Iterable, by itertools.dropwhile(test<sub>func</sub>, iterable)</h3>
<div class="outline-text-3" id="text-1-15">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">dropwhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">),</span> <span class="n">f</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>

<p>
This is different from filtering
</p>

<p>
if the position is known, then we can use itertools.islice(iterable, start, None) to drop the first 'start' items.
</p>
</div>
</div>


<div id="outline-container-sec-1-16" class="outline-3">
<h3 id="sec-1-16">4.9. Iterating Over All Possible Combinations or Permutations</h3>
<div class="outline-text-3" id="text-1-16">
<p>
An important aspect  of itertools module: for complex iteration tasks, it is very likely there is an exist solution.
</p>
</div>

<div id="outline-container-sec-1-16-1" class="outline-4">
<h4 id="sec-1-16-1">create permutations from a iterable collection of items, by itertools.permutations(iterable[, len])</h4>
<div class="outline-text-4" id="text-1-16-1">
<p>
The return value is an iterator
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-16-2" class="outline-4">
<h4 id="sec-1-16-2">create combinations from a iterable collection of items, by itertools.combinations(iterable, len)</h4>
<div class="outline-text-4" id="text-1-16-2">
<p>
The order of items does not matter
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-16-3" class="outline-4">
<h4 id="sec-1-16-3">create combinations from a iterable collection of items, by itertools.combinations<sub>with</sub><sub>replacement</sub>(iterable, len), same item can exist more than one times.</h4>
<div class="outline-text-4" id="text-1-16-3">
<p>
The order of items does not matter
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-17" class="outline-3">
<h3 id="sec-1-17">4.10. Iterating Over the Index-Value Pairs of a Sequence, by enumerate(iterable[, start<sub>index]</sub>)</h3>
<div class="outline-text-3" id="text-1-17">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-18" class="outline-3">
<h3 id="sec-1-18">4.11. Iterating Over Multiple Sequences Simultaneously, by zip(iterable1, iterable2, …), shortest</h3>
<div class="outline-text-3" id="text-1-18">
<p>
The zip function will create an iterator that return tuples: first element from iterable1, second element from iterable2, …
Should the size of all iterables be the same? =&gt; No, it can be different. the returned size is the same as the shortest size of all iterables.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-1-19" class="outline-3">
<h3 id="sec-1-19">Iterating Over Multiple Sequences Simultaneously, by itertools.zip<sub>longest</sub>(iterable1, iterable2, …), longest</h3>
<div class="outline-text-3" id="text-1-19">
<p>
If you want the returned iterator take the longest size, then use zip<sub>longest</sub>. The element value will be None if that  iterable is exzasted.
</p>

<p>
From the two functions: zip and zip<sub>longest</sub>, there is a lesson: it better to create different function name, than add a more  parameter.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-20" class="outline-3">
<h3 id="sec-1-20">4.12. Iterating on Items in Separate Containers, by itertools.chain(iterable1, iterable2, …), concat iterables</h3>
<div class="outline-text-3" id="text-1-20">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-1-21" class="outline-3">
<h3 id="sec-1-21">4.13. Creating Data Processing Pipelines</h3>
<div class="outline-text-3" id="text-1-21">
<p>
This section is about divide  a task to many small pipelines(steps), by use of generator
Generator is a  producer, for loop is a comsumer.
</p>
</div>


<div id="outline-container-sec-1-21-1" class="outline-4">
<h4 id="sec-1-21-1">example: iterate all matched lines from all files in a directory, recursively</h4>
<div class="outline-text-4" id="text-1-21-1">
<p>
相当于把多重QIAN TAO循环给扁平化了。但执行的顺序完全相同。generator确实比较好用。
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">gen_filenames</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen_open</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
	<span class="c1"># print('file names: %s' % f)</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span>
	<span class="k">yield</span> <span class="n">fh</span>
	<span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">gen_lines</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	<span class="k">yield from</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">gen_match</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>  <span class="n">lines</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">filenames</span> <span class="o">=</span> <span class="n">gen_filenames</span><span class="p">(</span><span class="s1">'..'</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">gen_open</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">gen_lines</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="n">matched_lines</span> <span class="o">=</span> <span class="n">gen_match</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">'slice'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">matched_lines</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-21-2" class="outline-4">
<h4 id="sec-1-21-2">[not work]change two embeded for loop to two seperate one by generator</h4>
<div class="outline-text-4" id="text-1-21-2">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen_a</span><span class="p">(</span><span class="n">aiter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">:</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">gen_b</span><span class="p">(</span><span class="n">aiter</span><span class="p">,</span> <span class="n">biter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">:</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-22" class="outline-3">
<h3 id="sec-1-22">4.14. Flattening a Nested Sequence, by generator, recursively</h3>
<div class="outline-text-3" id="text-1-22">
<p>
Why this function is not included in itertools module?
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="k">def</span>  <span class="nf">flatten</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">ignored_types</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ignored_types</span><span class="p">):</span>
	    <span class="k">yield from</span> <span class="n">flatten</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ignored_types</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">7</span><span class="p">],</span>  <span class="mi">8</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"the flattened version"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-23" class="outline-3">
<h3 id="sec-1-23">yield from just like a for loop</h3>
<div class="outline-text-3" id="text-1-23">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_a</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">gen_b</span><span class="p">(</span><span class="n">gena</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">gena</span>

<span class="k">def</span> <span class="nf">for_b</span><span class="p">(</span><span class="n">gena</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span>  <span class="ow">in</span> <span class="n">gena</span><span class="p">:</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="c1"># the gen_b and for_b works exactly the same, but the yield from is better</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gen_b</span><span class="p">(</span><span class="n">gen_a</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'the for version'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">for_b</span><span class="p">(</span><span class="n">gen_a</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-24" class="outline-3">
<h3 id="sec-1-24">4.15. Iterating in Sorted Order Over Merged Sorted Iterables, by heapq.merge(iterable1, iterable2, …)</h3>
<div class="outline-text-3" id="text-1-24">
<p>
the input iterables should in sorted order. then it will create an new iterable of sorted items from all input.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">heapq</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heapq</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>

<p>
The function will only get the needed items into memory. So it better to merge two sorted files.
</p>

<p>
Similar  to <code>sorted(itertools.chain(*iterables))</code>, but will not read all content to memory.
</p>
</div>
</div>
<div id="outline-container-sec-1-25" class="outline-3">
<h3 id="sec-1-25">4.16. Replacing Infinite conditional while Loops with an Iterator, by iter(callable, sentinel) function</h3>
<div class="outline-text-3" id="text-1-25">
<p>
invoke the callable UNTIL it returns the sentinel
</p>

<p>
Means: repeated invoke the callable, and return its return value, until the return value equal to the sentinel.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">idx</span>
    <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
                </div>
            </article>
</div>
        <div class="site-content">
            <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
                    <div class="entry-meta">
                        <span class="posted-on">
                            Posted on <a href="posts/python-cookbook-readnote-2/" rel="bookmark">July 15, 2017</a>
                        </span>
                    </div>
                    <h1><a href="posts/python-cookbook-readnote-2/">Python Cookbook 读书笔记（二）</a></h1>
                </div>
                <div class="entry-content">
                        <p>
《<a href="http://shop.oreilly.com/product/0636920027072.do">Python Cookbook</a>》读书笔记.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">chapter 2: Strings and Text</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">2.1. Splitting Strings on Any of Multiple Delimiters</h3>
<div class="outline-text-3" id="text-1-1">
<p>
By us re.split and the regexp is r'[,;\s]\s*'
</p>
</div>
<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">difference between str.split and re.split</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
str.split only accept simple seperator
re.split accept regulare expression.
</p>
</div>
</div>
<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">return value of re.split</h4>
<div class="outline-text-4" id="text-1-1-2">
<ol class="org-ol">
<li>if there are no capture group, then the same as str.split
</li>
<li>if there are capture group, then all matched data will also be returned.
then the value will be rst[::2], the seperator will be rst[1::2]
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"I, you; a  seperater.   haha"</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[,;.\s]\s*'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">'([,;.\s]\s*)'</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3">iterate on two lists, by first zip the two to one</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
looks nice!
</p>
<div class="highlight"><pre><span></span><span class="c1"># Reform the line using the same delimiters</span>
<span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="n">d</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
<span class="s1">'asdf fjdk;afed,fjek,asdf,foo'</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4">regexp noncapture group, by r'(?:…)'</h4>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">2.2. Matching Text at the Start or End of a String, by str.startswith() or str.endswith() method</h3>
<div class="outline-text-3" id="text-1-2">
<div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">"aaaa.txt"</span>
<span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".txt"</span><span class="p">)</span>
<span class="c1"># pass a tuple to check against multiple choices</span>
<span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">".c"</span><span class="p">,</span> <span class="s2">".h"</span><span class="p">))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">'http:'</span><span class="p">,</span> <span class="s1">'https:'</span><span class="p">,</span> <span class="s1">'ftp:'</span><span class="p">)):</span>
	<span class="k">return</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

<p>
The parameter is simple string.
</p>

<p>
Compared to re.match, str.startswith looks nice.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">2.3. Matching Strings Using Shell Wildcard Patterns, with fnmatch.fnmatch(), fnmatch.fnmatchcase()</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Shell wildcard:
</p>
<ul class="org-ul">
<li>[] : a charset
</li>
<li>* : match any length of chars
</li>
<li>? : match only one char
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="k">print</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">(</span><span class="s2">"data 1.txt"</span><span class="p">,</span> <span class="s2">"*[0-9]*"</span><span class="p">))</span>
</pre></div>

<ol class="org-ol">
<li>the pattern must match the whole string
</li>
<li>compares to startswith(), fnmatch can match at any position
</li>
<li>compares to regexp, fnmatch looks nice
</li>
<li>fnmatch will use the same case-sensitive rule as the OS, fnmatchcase will always respect case.
</li>
<li>between simpe string and full power of regexp
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">2.4. Matching and Searching for Text Patterns</h3>
<div class="outline-text-3" id="text-1-4">
<p>
What's  the difference between matching and searching
</p>
</div>

<div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1">the str.find() function: find the start index of a substring</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"Hello xxx bbbb"</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"xx"</span><span class="p">))</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2">re.compile() function: compile a regexp strinng to a regexp object, for performance</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
If you use the regexp many times, then first compile it is good. But if you only use it for one time, then don't use the compile function
</p>
</div>
</div>

<div id="outline-container-sec-1-4-3" class="outline-4">
<h4 id="sec-1-4-3">difference between r'\d' and '\d'</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
if the string is prefixed by  a 'r', then the '\' in the string will not be intepreted by the string parser.
So the second regexp is actually r'd'.
</p>
</div>
</div>

<div id="outline-container-sec-1-4-4" class="outline-4">
<h4 id="sec-1-4-4">re.findall() function, find all matched data as a list</h4>
<div class="outline-text-4" id="text-1-4-4">
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">rg</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\d+/(?:\d+)/(?:\d+)'</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'Today'</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

<p>
The return value: if there are capture groups, then the return value is the captured data, and if the capture group number is one, it will be  a string, else be  a tuple of strings.
if  no capture groups, then the return value is all matched  data.
</p>
</div>
</div>

<div id="outline-container-sec-1-4-5" class="outline-4">
<h4 id="sec-1-4-5">re.finditer(), find all matched data as a iterater</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
Seems the return value is different from re.findall(), it will return a  matched object , the same as re.match()
Seems strange, and highly inconsistent.
</p>
</div>
</div>

<div id="outline-container-sec-1-4-6" class="outline-4">
<h4 id="sec-1-4-6">re.match() function, always match at the start of a string</h4>
</div>
<div id="outline-container-sec-1-4-7" class="outline-4">
<h4 id="sec-1-4-7">re.match() function, return value</h4>
<div class="outline-text-4" id="text-1-4-7">
<p>
rst.group(0): the matched data
rst.group(1): the first captured data
rst.groups(): all captured data as a tuple
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">2.5. Searching and Replacing Text</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-sec-1-5-1" class="outline-4">
<h4 id="sec-1-5-1">the str.replace function, replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
str.replcae(pattern, replacement)
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'yeah, but no, but yeah, but no, but yeah'</span>
<span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'yeah'</span><span class="p">,</span> <span class="s1">'yep'</span><span class="p">))</span>
<span class="c1"># 'yep, but no, but yep, but no, but yep'</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-5-2" class="outline-4">
<h4 id="sec-1-5-2">the re.sub(pattern, replacement, text) function, will also replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
use r'\1' to refer to the first captured group
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d+)/(\d+)/(\d+)'</span><span class="p">,</span> <span class="sa">r</span><span class="s1">'\3-\1-\2'</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
<span class="c1"># 'Today is 2012-11-27. PyCon starts 2013-3-13.'</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-5-3" class="outline-4">
<h4 id="sec-1-5-3">the re.sub(pattern, callback, text) function, will also replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
The second parameter can also be a function, the parameter to this function is a match object(the  same returned by re.match function).
</p>

<p>
The same example as the above one:
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">'-'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">d</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d+)/(\d+)/(\d+)'</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-5-4" class="outline-4">
<h4 id="sec-1-5-4">the re.subn(…) function, same as re.sub, but also return subsitution counts also</h4>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">2.6. Searching and Replacing Case-Insensitive Text</h3>
<div class="outline-text-3" id="text-1-6">
<p>
To do case-insensitive operations, you must use regexp with the re.IGNORECASE flags keyword parameter
</p>
</div>

<div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1">replace words in a string with original case preserved</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
a excenlent example of replacing with 原始的大小写规则. 并且是一个很好的高阶函数的例子。
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">matchcase</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
	<span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">text</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">word</span>

    <span class="k">return</span> <span class="n">replace</span>

<span class="n">text</span> <span class="o">=</span> <span class="s1">'UPPER PYTHON, lower python, Mixed Python'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'python'</span><span class="p">,</span> <span class="n">matchcase</span><span class="p">(</span><span class="s1">'snake'</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>
<span class="c1"># 'UPPER SNAKE, lower snake, Mixed Snake'</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">2.7. Specifying a Regular Expression(regexp) for the Shortest Match, by using modifier '?', no-greedy match</h3>
<div class="outline-text-3" id="text-1-7">
<p>
By default, * will match longest data. if appended with a '?' then it will match the shortest
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="n">text1</span> <span class="o">=</span> <span class="s1">'Computer says "no."'</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*)"'</span><span class="p">,</span> <span class="n">text1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">text2</span> <span class="o">=</span> <span class="s1">'Computer says "no." Phone says "yes."'</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*)"'</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c1"># Now add a '?' after '*', no greedy match</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*?)"'</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">2.8. Writing a Regular Expression for Multiline Patterns</h3>
<div class="outline-text-3" id="text-1-8">
<p>
By default, '.' will not match a new line character. 
there are two choices to let '.' match a new line character:
</p>
<ol class="org-ol">
<li>by alternative.
change r'.*' to r'(?:.|\n)*'
</li>
<li>by use the re.DOTALL flag
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'''/* aaaa</span>
<span class="s1">bbbb</span>
<span class="s1">cccc */'''</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'/\*.*\*/'</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'/\*(?:.|\n)*\*/'</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</li>
</ol>
</div>

<div id="outline-container-sec-1-8-1" class="outline-4">
<h4 id="sec-1-8-1">the re.DOTALL flag: let '.' match a newline character</h4>
</div>
</div>
<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">2.9. Normalizing Unicode Text to a Standard Representation, by unicodedata.normalize('NFC', str)</h3>
<div class="outline-text-3" id="text-1-9">
<p>
unicode may have more than one representation, see example in the book
</p>
</div>
<div id="outline-container-sec-1-9-1" class="outline-4">
<h4 id="sec-1-9-1">normalizing means make sth. has the uniform format/type</h4>
</div>
</div>
<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">2.11. Stripping Unwanted Characters from Strings</h3>
<div class="outline-text-3" id="text-1-10">
</div>
<div id="outline-container-sec-1-10-1" class="outline-4">
<h4 id="sec-1-10-1">str.strip() function. lstrip(), rstrip(), delete whitespaces characters at begining or ending</h4>
<div class="outline-text-4" id="text-1-10-1">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"    a b c </span><span class="se">\n</span><span class="s2"> "</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</pre></div>
<p>
<b>*</b> delete characters in middle of string, by str.replace(), or re.sub()
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"   hello     word    "</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">"\s+"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
<p>
<b>*</b> create a generator object  by an expression, by '(' instead of '[', like lazy evaluation on other languages
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">import os.path</span>
<span class="s1">rst = ""</span>
<span class="s1">if os.path.isfile(""):</span>
<span class="s1">    with open("", "r") as f:</span>
<span class="s1">	rst = f.read()</span>
<span class="s1">'''</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">2.12. Sanitizing and Cleaning Up Text</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-sec-1-11-1" class="outline-4">
<h4 id="sec-1-11-1">str.translate() function, change characters given a table/dictionary, the book given much unicode examples</h4>
</div>
</div>

<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">2.13. Aligning Text Strings</h3>
<div class="outline-text-3" id="text-1-12">
</div>
<div id="outline-container-sec-1-12-1" class="outline-4">
<h4 id="sec-1-12-1">the str.ljust(), str.rjust(), str.center() functions</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
accept a number, and an optionall character
</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"="</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-12-2" class="outline-4">
<h4 id="sec-1-12-2">the format function and the str.format methods</h4>
<div class="outline-text-4" id="text-1-12-2">
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"&gt;20"</span><span class="p">))</span> <span class="c1"># same as rjust</span>
<span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"=&lt;20"</span><span class="p">))</span> <span class="c1"># same as ljust</span>
<span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"^20"</span><span class="p">))</span> <span class="c1"># same as center</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"{} {:=^10}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"abc"</span><span class="p">,</span> <span class="mi">123</span><span class="p">))</span>
</pre></div>





<p>
"%s %s" % (a, b) is old way, now should use the new way.
</p>
</div>
</div>
</div>


<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">2.14. Combining and Concatenating Strings</h3>
<div class="outline-text-3" id="text-1-13">
</div>
<div id="outline-container-sec-1-13-1" class="outline-4">
<h4 id="sec-1-13-1">by str.join</h4>
</div>

<div id="outline-container-sec-1-13-2" class="outline-4">
<h4 id="sec-1-13-2">by + operator</h4>
</div>

<div id="outline-container-sec-1-13-3" class="outline-4">
<h4 id="sec-1-13-3">by print function's 'sep' parameter</h4>
</div>

<div id="outline-container-sec-1-13-4" class="outline-4">
<h4 id="sec-1-13-4">by format function</h4>
</div>
</div>
<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14">2.15. Interpolating Variables in Strings, by str.format() or str.format<sub>map</sub>() method</h3>
<div class="outline-text-3" id="text-1-14">
<p>
Note: format<sub>map</sub> doesn't exist in python 2.7
</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"{name} is {age} years old"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Tom"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>

<span class="n">name</span> <span class="o">=</span> <span class="s2">"Jim"</span>
<span class="n">age</span> <span class="o">=</span> <span class="mi">18</span>
<span class="c1"># print("{name} is {age} years old".format_map(vars()))</span>
</pre></div>


<p>
format<sub>map</sub> accept a dictionay, while format accept keywords parameters
</p>
</div>
<div id="outline-container-sec-1-14-1" class="outline-4">
<h4 id="sec-1-14-1">the vars() function, the same as locals() if no parameter</h4>
<div class="outline-text-4" id="text-1-14-1">
<p>
if pass one parameter, then it is the same as obj._<sub>dict</sub>__
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'abc'</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">123</span>
<span class="k">print</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
<span class="c1"># print(vars(s))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-14-2" class="outline-4">
<h4 id="sec-1-14-2">the dict._<sub>missing</sub>_<sub>(self, key)</sub> method will be called when a key not exists, then KeyError will not be raised.</h4>
<div class="outline-text-4" id="text-1-14-2">
<p>
If this method is defined, then when a key not exists, it will be called and return the value. Else a KeyError will be raised.
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">safedict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'{'</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">'}'</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">safedict</span><span class="p">();</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="n">d1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">();</span>
<span class="c1"># print(d1['name'])</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-14-3" class="outline-4">
<h4 id="sec-1-14-3">a function that will do variable interpolating from env, just like $var in perl, by str.format<sub>map</sub>
</h4>
<div class="outline-text-4" id="text-1-14-3">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">safedict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'{'</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">'}'</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">safedict</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span><span class="p">))</span>

<span class="n">name</span><span class="o">=</span><span class="s2">"Jim"</span>
<span class="n">age</span><span class="o">=</span><span class="mi">18</span>
<span class="k">print</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="s2">"{name} is {age} years old"</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">people</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">'name'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'John'</span><span class="p">,</span> <span class="s1">'Peter'</span><span class="p">],</span>
   <span class="s1">'age'</span><span class="p">:</span> <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'My name is {{name[{0}]}}, I am {{age[{0}]}} years old.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">people</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-14-4" class="outline-4">
<h4 id="sec-1-14-4">sys.<sub>getframe</sub>([depth]): like calls in perl, get the stack frame</h4>
<div class="outline-text-4" id="text-1-14-4">
<p>
depth default to 0, means current stack frame. 
f<sub>locals</sub> attribute is used to get all local variabls.
f<sub>lineno</sub> attribute is the line number.
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_globals</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15">2.16. Reformatting Text to a Fixed Number of Columns, by textwrap.fill(astr, columns, initial<sub>indent</sub>='', subsquent<sub>indent</sub>='')</h3>
<div class="outline-text-3" id="text-1-15">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">textwrap</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">"Look into my eyes, look into my eyes, the eyes, the eyes, </span><span class="se">\</span>
<span class="s2">the eyes, not around the eyes, don't look around the eyes, </span><span class="se">\</span>
<span class="s2">look into my eyes, you're under."</span>

<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>

<div id="outline-container-sec-1-15-1" class="outline-4">
<h4 id="sec-1-15-1">get terminal column size, by os.get<sub>terminal</sub><sub>size</sub>().columns</h4>
<div class="outline-text-4" id="text-1-15-1">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-sec-1-16" class="outline-3">
<h3 id="sec-1-16">2.17. Handling HTML and XML Entities in Text</h3>
<div class="outline-text-3" id="text-1-16">
</div>
<div id="outline-container-sec-1-16-1" class="outline-4">
<h4 id="sec-1-16-1">the html.escape(astr, quote=True) function:</h4>
<div class="outline-text-4" id="text-1-16-1">
<p>
escape means convert special characters to 
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'&lt;a&gt;this is &lt;/a&gt;'</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="k">print</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-16-2" class="outline-4">
<h4 id="sec-1-16-2">the str.encode('ascii', errors='xmlcharrefreplace') function: encode a string to ascii</h4>
<div class="outline-text-4" id="text-1-16-2">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'Spicy Jalapeño'</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'xmlcharrefreplace'</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
                </div>
            </article>
</div>
    <!-- Lower Navigation links -->
    <nav class="site-content navigation-post" role="navigation"><div class="previous">
                <a href="index-1.html" rel="prev">
                    <span class="meta-nav">Older Entries</span>                </a>
            </div>
    </nav><!-- Page Footer --><section class="footer-sidebar clear" role="complementary"><div class="widget-block">
            <aside class="widget"><h2 class="widget-title">Astropeak</h2>
                <div class="widget-text">Astropeak's blogs.</div>
            </aside>
</div>
    </section><!-- Site Attributions --><footer class="site-footer" role="contentinfo"><div class="site-info">
            <p>Contents © 2018         <a href="mailto:astropeak@gmail.com">Astropeak</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
        </div>
        <div class="social">
            <ul class="menu"></ul>
</div>
    </footer>
</body>
</html>
