<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a demo site for Nikola.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Astropeak</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://example.com/">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/emacs-lisp/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://example.com/">

                <span id="blog-title">Astropeak</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/emacs-lisp/" class="u-url">Emacs Lisp 编程笔记</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/emacs-lisp/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li>
<a href="posts/emacs-lisp/#sec-1">错误处理</a>
<ul>
<li><a href="posts/emacs-lisp/#sec-1-1">抛出错误</a></li>
<li><a href="posts/emacs-lisp/#sec-1-2">捕获错误</a></li>
<li><a href="posts/emacs-lisp/#sec-1-3">忽略错误</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">错误处理</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">抛出错误</h3>
<div class="outline-text-3" id="text-1-1">
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">signal</span> <span class="ss">'my-error</span> <span class="o">'</span><span class="p">(</span><span class="s">"This is a demo error"</span><span class="p">))</span>
<span class="p">(</span><span class="nf">error</span> <span class="s">"This is another error"</span><span class="p">)</span>
</pre></div>
<p>
What's the difference between the two?
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">捕获错误</h3>
<div class="outline-text-3" id="text-1-2">
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">progn</span>
  <span class="p">(</span><span class="nf">condition-case</span> <span class="nv">err</span>
      <span class="p">(</span><span class="nf">signal</span> <span class="ss">'my-error</span> <span class="o">'</span><span class="p">(</span><span class="s">"This is a demo error"</span><span class="p">))</span>
    <span class="p">(</span><span class="ss">'my-error</span> <span class="p">(</span><span class="nf">message</span> <span class="s">"my error handled, %s"</span> <span class="nv">err</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">message</span> <span class="s">"end"</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span> <span class="nv">aaa</span> <span class="p">()</span>
  <span class="p">(</span><span class="nf">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">condition-case</span> <span class="nv">error</span>
      <span class="p">(</span><span class="nf">progn</span>
	<span class="p">(</span><span class="nf">op/git-change-branch</span> <span class="nv">op/repository-directory</span> <span class="s">"source"</span><span class="p">)</span>
	<span class="p">(</span><span class="nf">op/git-commit-changes</span> <span class="nv">op/repository-directory</span> <span class="s">"Changes"</span><span class="p">))</span>
    <span class="o">'</span><span class="p">(</span><span class="ss">'git-error</span>  <span class="p">(</span><span class="nf">message</span> <span class="s">"Error is %s"</span> <span class="nv">error</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">aaa</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">忽略错误</h3>
<div class="outline-text-3" id="text-1-3">
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">progn</span>
  <span class="p">(</span><span class="nf">ignore-errors</span>
    <span class="c1">;;(signal 'my-error '("This is a demo error"))</span>
    <span class="p">(</span><span class="nf">error</span> <span class="s">"This is another error"</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">(</span><span class="nf">message</span> <span class="s">"end"</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/org-test/" class="u-url">Org test</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/org-test/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
Write your post here.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">ssss</h2>
<div class="outline-text-2" id="text-1">
<p>
This is a line
</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="k">print</span> <span class="s2">"Write to file </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="nb">file</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">,</span> <span class="s1">'replace'</span><span class="p">))</span>
</pre></div>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">sub title</h3>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">bbbb</h2>
<div class="outline-text-2" id="text-2">
<p>
End of the line</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/python-cookbook-readnote/" class="u-url">Python Cookbook 读书笔记</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/python-cookbook-readnote/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
《<a href="http://shop.oreilly.com/product/0636920027072.do">Python Cookbook</a>》读书笔记.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">chapter 1: Data Structures and Algorithms</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">1.6 Mapping Keys to Multiple Values in a Dictionary, by list value and defaultdict</h3>
<div class="outline-text-3" id="text-1-1">
<p>
example: create a dictionary with default value, by defaultdict
</p>

<p>
dictionary's property:
</p>
<ol class="org-ol">
<li>you can add new key to a dictionary
</li>
<li>but when you access a key that not exists, there will be error
</li>
<li>defaultdict is used to fix such problem.
</li>
</ol>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="sb">`dict`</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="sb">`func list`</span><span class="p">)</span>
<span class="c1"># `dict`['aaa'].append(2)</span>
<span class="err">$</span><span class="mi">0</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">1.6 example</h3>
<div class="outline-text-3" id="text-1-2">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">[</span><span class="s1">'colorless'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">frequency</span><span class="p">[</span><span class="s1">'ideas'</span><span class="p">]</span> <span class="c1"># will be 0</span>

<span class="n">frequency</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="c1"># first, frequency['colorless'] will return a empty list, then append one element to this list.</span>
<span class="n">frequency</span><span class="p">[</span><span class="s1">'colorless'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">[</span><span class="s1">'ideas'</span><span class="p">]</span> <span class="c1"># will be []</span>

<span class="c1"># Or you can pass a function take no arguments </span>

<span class="c1"># the idiom:</span>
<span class="n">my_dictionary</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">function</span> <span class="n">to</span> <span class="n">create</span> <span class="n">default</span> <span class="n">value</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
<span class="n">my_dictionary</span><span class="p">[</span><span class="n">item_key</span><span class="p">]</span> <span class="ow">is</span> <span class="n">updated</span> <span class="k">with</span> <span class="n">information</span> <span class="n">about</span> <span class="n">item</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">1.7 Keeping Dictionaries in Order, OrderedDict</h3>
<div class="outline-text-3" id="text-1-3">
<div class="highlight"><pre><span></span><span class="n">form</span> <span class="n">collections</span> <span class="kn">import</span> <span class="nn">OrderedDict</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="c1"># the insertion order will be reserved.</span>
</pre></div>

<p>
An typical application is when for serilization.
</p>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">1.8. Calculating with Dictionaries</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-sec-1-4-1" class="outline-4">
<h4 id="sec-1-4-1">get max key/value in a dictionary, based on the value, by inverting the dict</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="highlight"><pre><span></span><span class="nb">max</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="sb">`dict`</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="sb">`dict`</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="c1"># another solution</span>
<span class="c1"># max(`dict`, key=lambda k:`dict`[k])</span>
</pre></div>
<p>
first convert the dict to list of (value, key) pairs, then max function will first compare value, then compare key.
</p>
</div>
</div>
<div id="outline-container-sec-1-4-2" class="outline-4">
<h4 id="sec-1-4-2">result of the max value for many  things</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
for tuple and list, it just the element.
but for a dict, it returns only the key. Why? Because it accept a iterable as first parameter, and for a dictionary, the iterable value is the key.
</p>
</div>
</div>
<div id="outline-container-sec-1-4-3" class="outline-4">
<h4 id="sec-1-4-3">understanding of multi value bind</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
---&gt;  (b11, b12) = 1
TypeError: 'int' object is not iterable
</p>

<p>
The right hand side should be an iterable, every element in the iterable will be asigned to the left hand side variable, with each variable comsume one element exzactly. If the number of elements and variables not match, then there will be an error.
</p>

<p>
To consume more than one values, use the '*varname' expresstion, then the variable 'varname' will be a list of many elements.
</p>

<p>
Back to the error prints in the example, the 'int' object refers to the right side '1'.
</p>

<p>
PS:
I find python much simpler and funny than java.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">1.9. Finding Commonalities in Two Dictionaries</h3>
<div class="outline-text-3" id="text-1-5">
<p>
a dictionary's d.keys() and d.items() support set operations
So to find the common part keys/items in two dictionaries, just use the set operation '|' or 'union' function.
</p>
</div>
<div id="outline-container-sec-1-5-1" class="outline-4">
<h4 id="sec-1-5-1">get all keys as a iterable in a dictionary, by keys()</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class="highlight"><pre><span></span><span class="sb">`dict`</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-5-2" class="outline-4">
<h4 id="sec-1-5-2">get all values as a iterable in a dictionary, by values()</h4>
<div class="outline-text-4" id="text-1-5-2">
<div class="highlight"><pre><span></span><span class="sb">`dict`</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-5-3" class="outline-4">
<h4 id="sec-1-5-3">get all key, value pairs as a iterable in a dictionary, by items()</h4>
<div class="outline-text-4" id="text-1-5-3">
<div class="highlight"><pre><span></span><span class="sb">`dict`</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-5-4" class="outline-4">
<h4 id="sec-1-5-4">set operations</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
'|': union
'&amp;': intersection
'-': difference
's1 &lt; s2': check if s1 is a subset of s2
</p>

<p>
Example:
In <sup><a id="fnr.1" name="fnr.1" class="footref" href="posts/python-cookbook-readnote/#fn.1">1</a></sup>: e.keys(), d.keys()
Out<sup><a id="fnr.1.100" name="fnr.1.100" class="footref" href="posts/python-cookbook-readnote/#fn.1">1</a></sup>: (dict_keys([1, 4, 'a', 9]), dict_keys([1, 3, 5]))
</p>

<p>
In <sup><a id="fnr.2" name="fnr.2" class="footref" href="posts/python-cookbook-readnote/#fn.2">2</a></sup>: e.keys() &amp; d.keys()
Out<sup><a id="fnr.2.100" name="fnr.2.100" class="footref" href="posts/python-cookbook-readnote/#fn.2">2</a></sup>: {1}
</p>

<p>
In <sup><a id="fnr.3" name="fnr.3" class="footref" href="posts/python-cookbook-readnote/#fn.3">3</a></sup>: e.keys() | d.keys()
Out<sup><a id="fnr.3.100" name="fnr.3.100" class="footref" href="posts/python-cookbook-readnote/#fn.3">3</a></sup>: {1, 3, 4, 5, 'a', 9}
</p>

<p>
In <sup><a id="fnr.4" name="fnr.4" class="footref" href="posts/python-cookbook-readnote/#fn.4">4</a></sup>: e.keys() - d.keys()
Out<sup><a id="fnr.4.100" name="fnr.4.100" class="footref" href="posts/python-cookbook-readnote/#fn.4">4</a></sup>: {9, 4, 'a'}
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">1.10. Removing Duplicates from a Sequence while Maintaining Order</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1">problem: what is hashable(and the link to python glossary)</h4>
<div class="outline-text-4" id="text-1-6-1">
<p>
From the python glossary: 
<a href="https://docs.python.org/3/glossary.html">https://docs.python.org/3/glossary.html</a>
</p>

<p>
An object is hashable if it has a hash value which never changes during its lifetime (it needs a __hash__() method), and can be compared to other objects (it needs an __eq__() or __cmp__() method). Hashable objects which compare equal must have the same hash value.
</p>

<p>
Hashability makes an object usable as a dictionary key and a set member, because these data structures use the hash value internally.
</p>

<p>
All of Python’s immutable built-in objects are hashable, while no mutable containers (such as lists or dictionaries) are. Objects which are instances of user-defined classes are hashable by default; they all compare unequal, and their hash value is their id().
</p>
</div>
</div>
<div id="outline-container-sec-1-6-2" class="outline-4">
<h4 id="sec-1-6-2">how yield/generator iterator is implemented</h4>
<div class="outline-text-4" id="text-1-6-2">
<p>
From the glossary, it works by suspends the function and  return the value, and save the current status. Then if it was called  next time, it will start execute from the place last time it was suspended. Great!! I understanded this.
</p>

<p>
generator
A function which returns a generator iterator. It looks like a normal function except that it contains yield expressions for producing a series of values usable in a for-loop or that can be retrieved one at a time with the next() function.
Usually refers to a generator function, but may refer to a generator iterator in some contexts. In cases where the intended meaning isn’t clear, using the full terms avoids ambiguity.
</p>

<p>
generator iterator
An object created by a generator function.
Each yield temporarily suspends processing, remembering the location execution state (including local variables and pending try-statements). When the generator iterator resumes, it picks-up where it left-off (in contrast to functions which start fresh on every invocation).
</p>
</div>
</div>

<div id="outline-container-sec-1-6-3" class="outline-4">
<h4 id="sec-1-6-3">file object is also an iterable, the element is a line</h4>
<div class="outline-text-4" id="text-1-6-3">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">somefile</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-6-4" class="outline-4">
<h4 id="sec-1-6-4">a function that delete all duplicates in a list, with order preserved</h4>
<div class="outline-text-4" id="text-1-6-4">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dedupe</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">item</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">key</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">item</span>
	    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
<p>
If the element is hashable, then key function is not needed. Else, provide a fucntion to convert the  element to a hashable element.
</p>

<p>
examples:
&gt;&gt;&gt; a = [ {'x':1, 'y':2}, {'x':1, 'y':3}, {'x':1, 'y':2}, {'x':2, 'y':4}]
&gt;&gt;&gt; list(dedupe(a, key=lambda d: (d['x'],d['y'])))
[{'x': 1, 'y': 2}, {'x': 1, 'y': 3}, {'x': 2, 'y': 4}]
&gt;&gt;&gt; list(dedupe(a, key=lambda d: d['x']))
[{'x': 1, 'y': 2}, {'x': 2, 'y': 4}]
&gt;&gt;&gt;
</p>
</div>
</div>

<div id="outline-container-sec-1-6-5" class="outline-4">
<h4 id="sec-1-6-5">delete all duplicates in a list, don't preserve order, by set</h4>
<div class="outline-text-4" id="text-1-6-5">
<div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="sb">`list`</span><span class="p">)</span>
</pre></div>
<p>
Then all duplicate elements in list will be removed.
</p>
</div>
</div>

<div id="outline-container-sec-1-6-6" class="outline-4">
<h4 id="sec-1-6-6">the a?b:c expression in python, if else in one line</h4>
<div class="outline-text-4" id="text-1-6-6">
<div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">b</span> <span class="k">if</span> <span class="n">a</span> <span class="k">else</span> <span class="n">c</span>
</pre></div>
<p>
looks good
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">1.11. Naming a Slice</h3>
<div class="outline-text-3" id="text-1-7">
</div>
<div id="outline-container-sec-1-7-1" class="outline-4">
<h4 id="sec-1-7-1">the slice object</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
create a  slice
</p>
<div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
<p>
'1:2' is just a shortcut to 'slice(1,2)'
</p>

<p>
slice attributes
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">1.12. Determining the Most Frequently Occurring Items in a Sequence</h3>
<div class="outline-text-3" id="text-1-8">
<p>
A method by me
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># b = [d[k]+=1 for k in a]  # syntax error here</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>


<div id="outline-container-sec-1-8-1" class="outline-4">
<h4 id="sec-1-8-1">the collections.Counter class: change a list to a list of tuple of (element, count)</h4>
<div class="outline-text-4" id="text-1-8-1">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># get the count</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># 3 is the element in a</span>


<span class="c1"># update with more words</span>
<span class="n">b</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

<span class="c1"># and a Counter object support the math operations: '+' and '-'</span>
</pre></div>

<p>
When you need to count data, use Counter class. This is a so little class, in practice, I will always write it from scratch before.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">1.13. Sorting a List of Dictionaries by a Common Key</h3>
<div class="outline-text-3" id="text-1-9">
</div>
<div id="outline-container-sec-1-9-1" class="outline-4">
<h4 id="sec-1-9-1">the operator.itemgetter function</h4>
<div class="outline-text-4" id="text-1-9-1">
<p>
it will return a callable that can be passed to 'sorted':s key  parameter, for list  or dictionary
</p>
<div class="highlight"><pre><span></span><span class="c1"># return value of</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
<span class="c1"># is the same as this one</span>
<span class="k">lambda</span> <span class="n">r</span><span class="p">:</span><span class="n">r</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
<span class="c1"># but the former  is a little faster</span>
</pre></div>

<p>
仍然是非常小的功能，为什么搞得这么精细呢？
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">1.14. Sorting Objects Without Native Comparison Support</h3>
<div class="outline-text-3" id="text-1-10">
</div>
<div id="outline-container-sec-1-10-1" class="outline-4">
<h4 id="sec-1-10-1">the operator.attrgetter function</h4>
<div class="outline-text-4" id="text-1-10-1">
<p>
it will return a callable that can be passed to 'sorted':s key  parameter, for user defined class
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'User({})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># return value of</span>
<span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
<span class="c1"># is the same as this one</span>
<span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="n">o</span><span class="o">.</span><span class="n">name</span>
<span class="c1"># but the former  is a little faster</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-sec-1-11" class="outline-3">
<h3 id="sec-1-11">1.15. Grouping Records(a sequence of dictionaries) Together Based on a Field</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-sec-1-11-1" class="outline-4">
<h4 id="sec-1-11-1">the itertools.groupby function: group sequencially the list as tuple (key, items)</h4>
<div class="outline-text-4" id="text-1-11-1">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">rows</span> <span class="o">=</span>  <span class="p">[{</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>  <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
<span class="c1"># a should be a generator</span>
<span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>

<p>
another way is just use a default list dictionary to group, then no sort is needed.
</p>
</div>
</div>
</div>






<div id="outline-container-sec-1-12" class="outline-3">
<h3 id="sec-1-12">1.16. Filtering Sequence Elements</h3>
<div class="outline-text-3" id="text-1-12">
<p>
To fitering, just use list comprehension with an if condition
</p>
</div>
<div id="outline-container-sec-1-12-1" class="outline-4">
<h4 id="sec-1-12-1">itertools.compress function, a filtering tool</h4>
<div class="outline-text-4" id="text-1-12-1">
<p>
it takse two parameters:
</p>
<ol class="org-ol">
<li>an iterable which to be compressed
</li>
<li>a Boolean sequence, with the same length of first parameter
if the element in this sequence  is True, then the element at the same position in the first iterable will be put to the output

<p>
An example:
</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'5412 N CLARK'</span><span class="p">,</span>
    <span class="s1">'5148 N CLARK'</span><span class="p">,</span>
    <span class="s1">'5800 E 58TH'</span><span class="p">,</span>
    <span class="s1">'2122 N CLARK'</span>
    <span class="s1">'5645 N RAVENSWOOD'</span><span class="p">,</span>
    <span class="s1">'1060 W ADDISON'</span><span class="p">,</span>
    <span class="s1">'4801 N BROADWAY'</span><span class="p">,</span>
    <span class="s1">'1039 W GRANVILLE'</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">counts</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">addresses</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="c1"># Now a will be all items where count larger than 5</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>



<div id="outline-container-sec-1-13" class="outline-3">
<h3 id="sec-1-13">1.17. Extracting a Subset of a Dictionary</h3>
<div class="outline-text-3" id="text-1-13">
</div>
<div id="outline-container-sec-1-13-1" class="outline-4">
<h4 id="sec-1-13-1">dictionary comprehension, just like list comprehension, but use '{' instead of '['</h4>
<div class="outline-text-4" id="text-1-13-1">
<div class="highlight"><pre><span></span><span class="n">prices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'ACME'</span><span class="p">:</span> <span class="mf">45.23</span><span class="p">,</span>
    <span class="s1">'AAPL'</span><span class="p">:</span> <span class="mf">612.78</span><span class="p">,</span>
    <span class="s1">'IBM'</span><span class="p">:</span> <span class="mf">205.55</span><span class="p">,</span>
    <span class="s1">'HPQ'</span><span class="p">:</span> <span class="mf">37.20</span><span class="p">,</span>
    <span class="s1">'FB'</span><span class="p">:</span> <span class="mf">10.75</span>
<span class="p">}</span>
<span class="c1"># Make a dictionary of all prices over 200</span>
<span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="p">}</span>
<span class="c1"># Make a dictionary of tech stocks</span>
<span class="n">tech_names</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'AAPL'</span><span class="p">,</span> <span class="s1">'IBM'</span><span class="p">,</span> <span class="s1">'HPQ'</span><span class="p">,</span> <span class="s1">'MSFT'</span> <span class="p">}</span>
<span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tech_names</span> <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-sec-1-14" class="outline-3">
<h3 id="sec-1-14">1.18. Mapping Names to Sequence Elements</h3>
<div class="outline-text-3" id="text-1-14">
</div>
<div id="outline-container-sec-1-14-1" class="outline-4">
<h4 id="sec-1-14-1">the collections.nametuple function, map an index to a name, and access to an element with that name</h4>
<div class="outline-text-4" id="text-1-14-1">
<p>
example:
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="n">People</span> <span class="o">=</span>  <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'People'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">])</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
</pre></div>

<p>
A good application:
for database selection.
</p>

<p>
The ._replace method:
Because a tuple is immutable, so to change an element, you can use _replace to  replace a field and a new one will be returned.
A tipical usage is first  create a prototype element with all field value be the default one, then update some fields with the _replace function.
Why there is a '_' in the function name?
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="n">Stock</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">'Stock'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'shares'</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">,</span> <span class="s1">'date'</span><span class="p">,</span> <span class="s1">'time'</span><span class="p">])</span>
<span class="c1"># Create a prototype instance</span>
<span class="n">stock_prototype</span> <span class="o">=</span> <span class="n">Stock</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="c1"># Function to convert a dictionary to a Stock</span>
<span class="k">def</span> <span class="nf">dict_to_stock</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">stock_prototype</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">s</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="s1">'ACME'</span><span class="p">,</span> <span class="s1">'shares'</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">'price'</span><span class="p">:</span> <span class="mf">123.45</span><span class="p">}</span>
<span class="n">dict_to_stock</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="c1"># Stock(name='ACME', shares=100, price=123.45, date=None, time=None)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-15" class="outline-3">
<h3 id="sec-1-15">1.19. Transforming and Reducing Data at the Same Time</h3>
<div class="outline-text-3" id="text-1-15">
<p>
use generator-expression argument
</p>

<p>
The reducing function means: given a list, return a value.
</p>
</div>
</div>
<div id="outline-container-sec-1-16" class="outline-3">
<h3 id="sec-1-16">the any function, check if any of an element is True in a iterable</h3>
<div class="outline-text-3" id="text-1-16">
</div>
<div id="outline-container-sec-1-16-1" class="outline-4">
<h4 id="sec-1-16-1">check if  any .py files exist in a directory</h4>
<div class="outline-text-4" id="text-1-16-1">
<div class="highlight"><pre><span></span><span class="c1"># Determine if any .py files exist in a directory</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">'dirname'</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.py'</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'There be python!'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Sorry, no python.'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-16-2" class="outline-4">
<h4 id="sec-1-16-2">get all files in a directory as a list</h4>
<div class="outline-text-4" id="text-1-16-2">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">'dirname'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-16-3" class="outline-4">
<h4 id="sec-1-16-3">change a tuple/list/iterable to a csv line</h4>
<div class="outline-text-4" id="text-1-16-3">
<p>
This is much better than the string format method
</p>
<div class="highlight"><pre><span></span><span class="c1"># Output a tuple as CSV</span>
<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'ACME'</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">123.45</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="p">))</span><span class="c1"># Output a tuple as CSV</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-17" class="outline-3">
<h3 id="sec-1-17">1.20. Combining Multiple Mappings into a Single Mapping</h3>
<div class="outline-text-3" id="text-1-17">
</div>
<div id="outline-container-sec-1-17-1" class="outline-4">
<h4 id="sec-1-17-1">the collections.ChainMap</h4>
<div class="outline-text-4" id="text-1-17-1">
<p>
combining many maps/dictionaries, then when get an element, it will try to get from the first map, then the second, ...
</p>

<p>
And for operations that mutate the mapping always affect the first map/dictionary.
</p>

<p>
typical application:
scoped variable in a programming language.
</p>

<p>
Difference from the dict.update function:
ChainMap use a link to the original dictionary, while dict.update create a new one.
</p>
</div>
<ul class="org-ul"><li>
<a id="sec-1-17-1-1" name="sec-1-17-1-1"></a>check if an element exists in many dictionaries/maps, sequencially<br><div class="outline-text-5" id="text-1-17-1-1">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'x'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'y'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span> <span class="c1"># Outputs 1 (from a)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">'y'</span><span class="p">])</span> <span class="c1"># Outputs 2 (from b)</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">'z'</span><span class="p">])</span> <span class="c1"># Outputs 3 (from a)</span>
</pre></div>
<ul class="org-ul">
<li>chapter 2: Strings and Text
</li>
</ul>
</div>
</li></ul>
</div>
</div>
<div id="outline-container-sec-1-18" class="outline-3">
<h3 id="sec-1-18">2.1. Splitting Strings on Any of Multiple Delimiters</h3>
<div class="outline-text-3" id="text-1-18">
<p>
By us re.split and the regexp is r'[,;\s]\s*'
</p>
</div>
<div id="outline-container-sec-1-18-1" class="outline-4">
<h4 id="sec-1-18-1">difference between str.split and re.split</h4>
<div class="outline-text-4" id="text-1-18-1">
<p>
str.split only accept simple seperator
re.split accept regulare expression.
</p>
</div>
</div>
<div id="outline-container-sec-1-18-2" class="outline-4">
<h4 id="sec-1-18-2">return value of re.split</h4>
<div class="outline-text-4" id="text-1-18-2">
<ol class="org-ol">
<li>if there are no capture group, then the same as str.split
</li>
<li>if there are capture group, then all matched data will also be returned.
then the value will be rst[::2], the seperator will be rst[1::2]
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"I, you; a  seperater.   haha"</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[,;.\s]\s*'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">'([,;.\s]\s*)'</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-1-18-3" class="outline-4">
<h4 id="sec-1-18-3">iterate on two lists, by first zip the two to one</h4>
<div class="outline-text-4" id="text-1-18-3">
<p>
looks nice!
</p>
<div class="highlight"><pre><span></span><span class="c1"># Reform the line using the same delimiters</span>
<span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="n">d</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">))</span>
<span class="s1">'asdf fjdk;afed,fjek,asdf,foo'</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-18-4" class="outline-4">
<h4 id="sec-1-18-4">regexp noncapture group, by r'(?:...)'</h4>
</div>
</div>

<div id="outline-container-sec-1-19" class="outline-3">
<h3 id="sec-1-19">2.2. Matching Text at the Start or End of a String, by str.startswith() or str.endswith() method</h3>
<div class="outline-text-3" id="text-1-19">
<div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">"aaaa.txt"</span>
<span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".txt"</span><span class="p">)</span>
<span class="c1"># pass a tuple to check against multiple choices</span>
<span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">".c"</span><span class="p">,</span> <span class="s2">".h"</span><span class="p">))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">'http:'</span><span class="p">,</span> <span class="s1">'https:'</span><span class="p">,</span> <span class="s1">'ftp:'</span><span class="p">)):</span>
	<span class="k">return</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

<p>
The parameter is simple string.
</p>

<p>
Compared to re.match, str.startswith looks nice.
</p>
</div>
</div>

<div id="outline-container-sec-1-20" class="outline-3">
<h3 id="sec-1-20">2.3. Matching Strings Using Shell Wildcard Patterns, with fnmatch.fnmatch(), fnmatch.fnmatchcase()</h3>
<div class="outline-text-3" id="text-1-20">
<p>
Shell wildcard:
</p>
<ul class="org-ul">
<li>[] : a charset
</li>
<li>* : match any length of chars
</li>
<li>? : match only one char
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="k">print</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">(</span><span class="s2">"data 1.txt"</span><span class="p">,</span> <span class="s2">"*[0-9]*"</span><span class="p">))</span>
</pre></div>

<ol class="org-ol">
<li>the pattern must match the whole string
</li>
<li>compares to startswith(), fnmatch can match at any position
</li>
<li>compares to regexp, fnmatch looks nice
</li>
<li>fnmatch will use the same case-sensitive rule as the OS, fnmatchcase will always respect case.
</li>
<li>between simpe string and full power of regexp
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-1-21" class="outline-3">
<h3 id="sec-1-21">2.4. Matching and Searching for Text Patterns</h3>
<div class="outline-text-3" id="text-1-21">
<p>
What's  the difference between matching and searching
</p>
</div>

<div id="outline-container-sec-1-21-1" class="outline-4">
<h4 id="sec-1-21-1">the str.find() function: find the start index of a substring</h4>
<div class="outline-text-4" id="text-1-21-1">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"Hello xxx bbbb"</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"xx"</span><span class="p">))</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-21-2" class="outline-4">
<h4 id="sec-1-21-2">re.compile() function: compile a regexp strinng to a regexp object, for performance</h4>
<div class="outline-text-4" id="text-1-21-2">
<p>
If you use the regexp many times, then first compile it is good. But if you only use it for one time, then don't use the compile function
</p>
</div>
</div>

<div id="outline-container-sec-1-21-3" class="outline-4">
<h4 id="sec-1-21-3">difference between r'\d' and '\d'</h4>
<div class="outline-text-4" id="text-1-21-3">
<p>
if the string is prefixed by  a 'r', then the '\' in the string will not be intepreted by the string parser.
So the second regexp is actually r'd'.
</p>
</div>
</div>

<div id="outline-container-sec-1-21-4" class="outline-4">
<h4 id="sec-1-21-4">re.findall() function, find all matched data as a list</h4>
<div class="outline-text-4" id="text-1-21-4">
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">rg</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\d+/(?:\d+)/(?:\d+)'</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">'Today'</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>

<p>
The return value: if there are capture groups, then the return value is the captured data, and if the capture group number is one, it will be  a string, else be  a tuple of strings.
if  no capture groups, then the return value is all matched  data.
</p>
</div>
</div>

<div id="outline-container-sec-1-21-5" class="outline-4">
<h4 id="sec-1-21-5">re.finditer(), find all matched data as a iterater</h4>
<div class="outline-text-4" id="text-1-21-5">
<p>
Seems the return value is different from re.findall(), it will return a  matched object , the same as re.match()
Seems strange, and highly inconsistent.
</p>
</div>
</div>

<div id="outline-container-sec-1-21-6" class="outline-4">
<h4 id="sec-1-21-6">re.match() function, always match at the start of a string</h4>
</div>
<div id="outline-container-sec-1-21-7" class="outline-4">
<h4 id="sec-1-21-7">re.match() function, return value</h4>
<div class="outline-text-4" id="text-1-21-7">
<p>
rst.group(0): the matched data
rst.group(1): the first captured data
rst.groups(): all captured data as a tuple
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-22" class="outline-3">
<h3 id="sec-1-22">2.5. Searching and Replacing Text</h3>
<div class="outline-text-3" id="text-1-22">
</div>
<div id="outline-container-sec-1-22-1" class="outline-4">
<h4 id="sec-1-22-1">the str.replace function, replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-22-1">
<p>
str.replcae(pattern, replacement)
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'yeah, but no, but yeah, but no, but yeah'</span>
<span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'yeah'</span><span class="p">,</span> <span class="s1">'yep'</span><span class="p">))</span>
<span class="c1"># 'yep, but no, but yep, but no, but yep'</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-22-2" class="outline-4">
<h4 id="sec-1-22-2">the re.sub(pattern, replacement, text) function, will also replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-22-2">
<p>
use r'\1' to refer to the first captured group
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d+)/(\d+)/(\d+)'</span><span class="p">,</span> <span class="sa">r</span><span class="s1">'\3-\1-\2'</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
<span class="c1"># 'Today is 2012-11-27. PyCon starts 2013-3-13.'</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-22-3" class="outline-4">
<h4 id="sec-1-22-3">the re.sub(pattern, callback, text) function, will also replace all occurence in a string</h4>
<div class="outline-text-4" id="text-1-22-3">
<p>
The second parameter can also be a function, the parameter to this function is a match object(the  same returned by re.match function).
</p>

<p>
The same example as the above one:
</p>
<div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="s1">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">'-'</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">y</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">d</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d+)/(\d+)/(\d+)'</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-1-22-4" class="outline-4">
<h4 id="sec-1-22-4">the re.subn(...) function, same as re.sub, but also return subsitution counts also</h4>
</div>
</div>
<div id="outline-container-sec-1-23" class="outline-3">
<h3 id="sec-1-23">2.6. Searching and Replacing Case-Insensitive Text</h3>
<div class="outline-text-3" id="text-1-23">
<p>
To do case-insensitive operations, you must use regexp with the re.IGNORECASE flags keyword parameter
</p>
</div>

<div id="outline-container-sec-1-23-1" class="outline-4">
<h4 id="sec-1-23-1">replace words in a string with original case preserved</h4>
<div class="outline-text-4" id="text-1-23-1">
<p>
a excenlent example of replacing with 原始的大小写规则. 并且是一个很好的高阶函数的例子。
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">matchcase</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
	<span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">text</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
	    <span class="k">return</span> <span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">word</span>

    <span class="k">return</span> <span class="n">replace</span>

<span class="n">text</span> <span class="o">=</span> <span class="s1">'UPPER PYTHON, lower python, Mixed Python'</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">'python'</span><span class="p">,</span> <span class="n">matchcase</span><span class="p">(</span><span class="s1">'snake'</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>
<span class="c1"># 'UPPER SNAKE, lower snake, Mixed Snake'</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-24" class="outline-3">
<h3 id="sec-1-24">2.7. Specifying a Regular Expression(regexp) for the Shortest Match, by using modifier '?', no-greedy match</h3>
<div class="outline-text-3" id="text-1-24">
<p>
By default, * will match longest data. if appended with a '?' then it will match the shortest
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="n">text1</span> <span class="o">=</span> <span class="s1">'Computer says "no."'</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*)"'</span><span class="p">,</span> <span class="n">text1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">text2</span> <span class="o">=</span> <span class="s1">'Computer says "no." Phone says "yes."'</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*)"'</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="c1"># Now add a '?' after '*', no greedy match</span>
<span class="n">r</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"(.*?)"'</span><span class="p">,</span> <span class="n">text2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-25" class="outline-3">
<h3 id="sec-1-25">2.8. Writing a Regular Expression for Multiline Patterns</h3>
<div class="outline-text-3" id="text-1-25">
<p>
By default, '.' will not match a new line character. 
there are two choices to let '.' match a new line character:
</p>
<ol class="org-ol">
<li>by alternative.
change r'.*' to r'(?:.|\n)*'
</li>
<li>by use the re.DOTALL flag
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'''/* aaaa</span>
<span class="s1">bbbb</span>
<span class="s1">cccc */'''</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'/\*.*\*/'</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'/\*(?:.|\n)*\*/'</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</li>
</ol>
</div>

<div id="outline-container-sec-1-25-1" class="outline-4">
<h4 id="sec-1-25-1">the re.DOTALL flag: let '.' match a newline character</h4>
</div>
</div>
<div id="outline-container-sec-1-26" class="outline-3">
<h3 id="sec-1-26">2.9. Normalizing Unicode Text to a Standard Representation, by unicodedata.normalize('NFC', str)</h3>
<div class="outline-text-3" id="text-1-26">
<p>
unicode may have more than one representation, see example in the book
</p>
</div>
<div id="outline-container-sec-1-26-1" class="outline-4">
<h4 id="sec-1-26-1">normalizing means make sth. has the uniform format/type</h4>
</div>
</div>
<div id="outline-container-sec-1-27" class="outline-3">
<h3 id="sec-1-27">2.11. Stripping Unwanted Characters from Strings</h3>
<div class="outline-text-3" id="text-1-27">
</div>
<div id="outline-container-sec-1-27-1" class="outline-4">
<h4 id="sec-1-27-1">str.strip() function. lstrip(), rstrip(), delete whitespaces characters at begining or ending</h4>
<div class="outline-text-4" id="text-1-27-1">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"    a b c </span><span class="se">\n</span><span class="s2"> "</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</pre></div>
<p>
<b>*</b> delete characters in middle of string, by str.replace(), or re.sub()
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"   hello     word    "</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">"\s+"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
<p>
<b>*</b> create a generator object  by an expression, by '(' instead of '[', like lazy evaluation on other languages
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">import os.path</span>
<span class="s1">rst = ""</span>
<span class="s1">if os.path.isfile(""):</span>
<span class="s1">    with open("", "r") as f:</span>
<span class="s1">	rst = f.read()</span>
<span class="s1">'''</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-1-28" class="outline-3">
<h3 id="sec-1-28">2.12. Sanitizing and Cleaning Up Text</h3>
<div class="outline-text-3" id="text-1-28">
</div>
<div id="outline-container-sec-1-28-1" class="outline-4">
<h4 id="sec-1-28-1">str.translate() function, change characters given a table/dictionary, the book given much unicode examples</h4>
</div>
</div>

<div id="outline-container-sec-1-29" class="outline-3">
<h3 id="sec-1-29">2.13. Aligning Text Strings</h3>
<div class="outline-text-3" id="text-1-29">
</div>
<div id="outline-container-sec-1-29-1" class="outline-4">
<h4 id="sec-1-29-1">the str.ljust(), str.rjust(), str.center() functions</h4>
<div class="outline-text-4" id="text-1-29-1">
<p>
accept a number, and an optionall character
</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">"="</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"aaa"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-29-2" class="outline-4">
<h4 id="sec-1-29-2">the format function and the str.format methods</h4>
<div class="outline-text-4" id="text-1-29-2">
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"&gt;20"</span><span class="p">))</span> <span class="c1"># same as rjust</span>
<span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"=&lt;20"</span><span class="p">))</span> <span class="c1"># same as ljust</span>
<span class="k">print</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="s2">"aaa"</span><span class="p">,</span> <span class="s2">"^20"</span><span class="p">))</span> <span class="c1"># same as center</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"{} {:=^10}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"abc"</span><span class="p">,</span> <span class="mi">123</span><span class="p">))</span>
</pre></div>





<p>
"%s %s" % (a, b) is old way, now should use the new way.
</p>
</div>
</div>
</div>


<div id="outline-container-sec-1-30" class="outline-3">
<h3 id="sec-1-30">2.14. Combining and Concatenating Strings</h3>
<div class="outline-text-3" id="text-1-30">
</div>
<div id="outline-container-sec-1-30-1" class="outline-4">
<h4 id="sec-1-30-1">by str.join</h4>
</div>

<div id="outline-container-sec-1-30-2" class="outline-4">
<h4 id="sec-1-30-2">by + operator</h4>
</div>

<div id="outline-container-sec-1-30-3" class="outline-4">
<h4 id="sec-1-30-3">by print function's 'sep' parameter</h4>
</div>

<div id="outline-container-sec-1-30-4" class="outline-4">
<h4 id="sec-1-30-4">by format function</h4>
</div>
</div>
<div id="outline-container-sec-1-31" class="outline-3">
<h3 id="sec-1-31">2.15. Interpolating Variables in Strings, by str.format() or str.format_map() method</h3>
<div class="outline-text-3" id="text-1-31">
<p>
Note: format_map doesn't exist in python 2.7
</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">"{name} is {age} years old"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Tom"</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>

<span class="n">name</span> <span class="o">=</span> <span class="s2">"Jim"</span>
<span class="n">age</span> <span class="o">=</span> <span class="mi">18</span>
<span class="c1"># print("{name} is {age} years old".format_map(vars()))</span>
</pre></div>


<p>
format_map accept a dictionay, while format accept keywords parameters
</p>
</div>
<div id="outline-container-sec-1-31-1" class="outline-4">
<h4 id="sec-1-31-1">the vars() function, the same as locals() if no parameter</h4>
<div class="outline-text-4" id="text-1-31-1">
<p>
if pass one parameter, then it is the same as obj.__dict__
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'abc'</span>
<span class="n">d</span> <span class="o">=</span> <span class="mi">123</span>
<span class="k">print</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
<span class="c1"># print(vars(s))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-31-2" class="outline-4">
<h4 id="sec-1-31-2">the dict.__missing__(self, key) method will be called when a key not exists, then KeyError will not be raised.</h4>
<div class="outline-text-4" id="text-1-31-2">
<p>
If this method is defined, then when a key not exists, it will be called and return the value. Else a KeyError will be raised.
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">safedict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'{'</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">'}'</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">safedict</span><span class="p">();</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="n">d1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">();</span>
<span class="c1"># print(d1['name'])</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-31-3" class="outline-4">
<h4 id="sec-1-31-3">a function that will do variable interpolating from env, just like $var in perl, by str.format_map</h4>
<div class="outline-text-4" id="text-1-31-3">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">safedict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'{'</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">'}'</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">safedict</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span><span class="p">))</span>

<span class="n">name</span><span class="o">=</span><span class="s2">"Jim"</span>
<span class="n">age</span><span class="o">=</span><span class="mi">18</span>
<span class="k">print</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="s2">"{name} is {age} years old"</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">people</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">'name'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'John'</span><span class="p">,</span> <span class="s1">'Peter'</span><span class="p">],</span>
   <span class="s1">'age'</span><span class="p">:</span> <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'My name is {{name[{0}]}}, I am {{age[{0}]}} years old.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">people</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-31-4" class="outline-4">
<h4 id="sec-1-31-4">sys._getframe([depth]): like calls in perl, get the stack frame</h4>
<div class="outline-text-4" id="text-1-31-4">
<p>
depth default to 0, means current stack frame. 
f_locals attribute is used to get all local variabls.
f_lineno attribute is the line number.
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_globals</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-sec-1-32" class="outline-3">
<h3 id="sec-1-32">2.16. Reformatting Text to a Fixed Number of Columns, by textwrap.fill(astr, columns, initial_indent='', subsquent_indent='')</h3>
<div class="outline-text-3" id="text-1-32">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">textwrap</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">"Look into my eyes, look into my eyes, the eyes, the eyes, </span><span class="se">\</span>
<span class="s2">the eyes, not around the eyes, don't look around the eyes, </span><span class="se">\</span>
<span class="s2">look into my eyes, you're under."</span>

<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>

<div id="outline-container-sec-1-32-1" class="outline-4">
<h4 id="sec-1-32-1">get terminal column size, by os.get_terminal_size().columns</h4>
<div class="outline-text-4" id="text-1-32-1">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


<div id="outline-container-sec-1-33" class="outline-3">
<h3 id="sec-1-33">2.17. Handling HTML and XML Entities in Text</h3>
<div class="outline-text-3" id="text-1-33">
</div>
<div id="outline-container-sec-1-33-1" class="outline-4">
<h4 id="sec-1-33-1">the html.escape(astr, quote=True) function:</h4>
<div class="outline-text-4" id="text-1-33-1">
<p>
escape means convert special characters to 
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'&lt;a&gt;this is &lt;/a&gt;'</span>
<span class="kn">import</span> <span class="nn">html</span>
<span class="k">print</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-33-2" class="outline-4">
<h4 id="sec-1-33-2">the str.encode('ascii', errors='xmlcharrefreplace') function: encode a string to ascii</h4>
<div class="outline-text-4" id="text-1-33-2">
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'Spicy Jalapeño'</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'xmlcharrefreplace'</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">chapter 4: Iterators and Generators</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">4.1. Manually Consuming an Iterator, by next(iterator[, default]) function</h3>
<div class="outline-text-3" id="text-2-1">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'python-cookbook-3rd.org'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>

<div id="outline-container-sec-2-1-1" class="outline-4">
<h4 id="sec-2-1-1">open(filename, ...) function will return a iterator of lines in that file</h4>
</div>
<div id="outline-container-sec-2-1-2" class="outline-4">
<h4 id="sec-2-1-2">a list object is not an iterator</h4>
</div>
<div id="outline-container-sec-2-1-3" class="outline-4">
<h4 id="sec-2-1-3">use the iter(iterable) function to create an iterator given an iterable</h4>
</div>
<div id="outline-container-sec-2-1-4" class="outline-4">
<h4 id="sec-2-1-4">the for x in X syntax works both for iterator and list object</h4>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">iterator and iterable</h3>
<div class="outline-text-3" id="text-2-2">
<p>
An object is said to be iterable if it has the <span class="underline"><span class="underline">iter</span></span> method defined.
The __iter__() will reutrn the iterator object.
</p>

<p>
An object is said to be a iterator if it has following method defined:
</p>
<ol class="org-ol">
<li>
<span class="underline"><span class="underline">iter</span></span>: which return itself
Can be tested the it.__iter__() == it is true
</li>
<li>
<span class="underline"><span class="underline">next</span></span>: return the next value every time it is invoked. 
</li>
</ol>
<p>
So an iterator is an iterable,  call iter(iterable) to get an iterator.
</p>


<p>
The iter(iterable) function: 
it will return 'iterable.__iter__()'
</p>


<p>
So if obja is an iterable, then iter(obja) equal obja.__iter() 
</p>
<div class="highlight"><pre><span></span><span class="n">obja</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">ia</span> <span class="o">=</span> <span class="n">obja</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
<span class="n">ib</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">obja</span><span class="p">)</span>
<span class="n">ic</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ia</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ib</span> <span class="ow">is</span> <span class="n">ic</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">ia</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">ib</span><span class="p">))</span>
</pre></div>

<p>
if obja is iterator, then iter(obja) and obja is the same object.
</p>


<p>
A good ref: <a href="http://www.shutupandship.com/2012/01/understanding-python-iterables-and.html">http://www.shutupandship.com/2012/01/understanding-python-iterables-and.html</a>
</p>
</div>
<div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1">a example of create a iterable class</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">MyListIter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyListIter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">""" A sample implementation of a list iterator. NOTE: This is just a </span>
<span class="sd">    demonstration of concept!!! YOU SHOULD NEVER IMPLEMENT SOMETHING LIKE THIS!</span>
<span class="sd">    Even if you have to (for any reason), there are many better ways to </span>
<span class="sd">    implement this."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>         
	    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lst</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">MyList</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ia</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'type(a): </span><span class="si">%r</span><span class="s1">, type(ia): </span><span class="si">%r</span><span class="s1">'</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">ia</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span> 
	<span class="k">print</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">how does the for in loop works</h3>
<div class="outline-text-3" id="text-2-3">
<ol class="org-ol">
<li>it first get the iterable's iterator object, by calling its __iter__() method
</li>
<li>get the element by invoke the iterator's __next__() method, and bind the value to the variable.
</li>
<li>stop when an 'StopIteration' exception happens.
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">the next(iterator) function</h3>
<div class="outline-text-3" id="text-2-4">
<p>
it just return iterator.__next__()
</p>
</div>
</div>
<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">the iter(iterable) function</h3>
<div class="outline-text-3" id="text-2-5">
<p>
it just return iterable.__iter__()
</p>
</div>
</div>
<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">the len(obj) function</h3>
<div class="outline-text-3" id="text-2-6">
<p>
it just return obj.__len__()
</p>
</div>
</div>
<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">4.2. Delegating Iteration</h3>
<div class="outline-text-3" id="text-2-7">
<p>
When create a class the with a underline container, just define an __iter__() method that forward the request to the underlineing container object.
</p>
</div>
</div>

<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8">4.3. Creating New Iteration Patterns with Generators</h3>
</div>
<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9">what is a generator?</h3>
<div class="outline-text-3" id="text-2-9">
<p>
a generator is a function that contains at lease one 'yeild' statement.
</p>

<p>
Unlike normal function, it's boyd will not be executed when it is be called, instead, it will return a generator object.
</p>
</div>
</div>
<div id="outline-container-sec-2-10" class="outline-3">
<h3 id="sec-2-10">4.4. Implementing the Iterator Protocol</h3>
<div class="outline-text-3" id="text-2-10">
<p>
use the generator instead of the <span class="underline"><span class="underline">next</span></span> method, which will be much simple.
</p>

<p>
使用yeild 创建一个Tree Node,比使用__next__函数简单多了。
</p>

<p>
yeild from syntax.
</p>
</div>
</div>
<div id="outline-container-sec-2-11" class="outline-3">
<h3 id="sec-2-11">4.5. Iterating in Reverse, by the reversed(obj) function</h3>
<div class="outline-text-3" id="text-2-11">
<p>
reversed only  works if the obj
</p>
<ul class="org-ul">
<li>the obj defined a __reversed__() method. or
</li>
<li>the obj's size can be determined.
</li>
</ul>
<p>
It returns an iterator.
</p>

<p>
For example, a file handler returned by the 'open()' function can't be used with the reversed function. to use it, first convert it to a list, then pass it to the reversed() function.
</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"1.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-12" class="outline-3">
<h3 id="sec-2-12">defined a customized  reversed iterator, by define the __reversed__() method</h3>
<div class="outline-text-3" id="text-2-12">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
	    <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">-=</span> <span class="mi">1</span>
	    <span class="k">return</span> <span class="n">n</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">ReversedCountDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ReversedCountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_orig</span> <span class="o">=</span> <span class="n">orig</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span>  <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig</span><span class="o">.</span><span class="n">_start</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">+=</span> <span class="mi">1</span>
	    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">raise</span> <span class="ne">StopIteration</span>

<span class="c1"># if __name__ == '__main__':</span>
<span class="n">cd</span> <span class="o">=</span> <span class="n">CountDown</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># for a in cd:</span>
<span class="c1">#     print(a)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"reversed"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cd</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>


<p>
Implemet the iterator protocal by <span class="underline"><span class="underline">next</span></span> method is a little complex compared  to by  use the yield statement. The differenc is that then the object is ... 
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CountDown</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
	<span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">n</span>
	    <span class="n">n</span> <span class="o">-=</span><span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">_start</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">n</span>
	    <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>

<span class="n">cd</span> <span class="o">=</span> <span class="n">CountDown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cd</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">print</span> <span class="p">(</span><span class="s2">"reversed"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cd</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-2-13" class="outline-3">
<h3 id="sec-2-13">4.6. Defining Generator Functions with Extra State</h3>
<div class="outline-text-3" id="text-2-13">
</div>
<div id="outline-container-sec-2-13-1" class="outline-4">
<h4 id="sec-2-13-1">print the surrounding previous lines if pattern matched, by use a generator, implemented by a class</h4>
<div class="outline-text-4" id="text-2-13-1">
<p>
Here previous lines are states.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="k">class</span> <span class="nc">HistoryLines</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">histlen</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">histlen</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
	    <span class="k">yield</span> <span class="n">line</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">hist_lines</span> <span class="o">=</span> <span class="n">HistoryLines</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hist_lines</span><span class="p">:</span>
	<span class="k">if</span>  <span class="s1">'wrap'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
	    <span class="k">for</span> <span class="n">hl</span> <span class="ow">in</span> <span class="n">hist_lines</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">hl</span><span class="p">)</span>
</pre></div>

<p>
Good practice: if you need save some states, then don't use a function to create a generator, use a class.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-14" class="outline-3">
<h3 id="sec-2-14">4.7. Taking a Slice of an Iterator</h3>
<div class="outline-text-3" id="text-2-14">
</div>
<div id="outline-container-sec-2-14-1" class="outline-4">
<h4 id="sec-2-14-1">by use of the itertools.islice(start, end, step) functon</h4>
<div class="outline-text-4" id="text-2-14-1">
<p>
Because we don't know the size of a iterator or a generator, so we can't slice it directly.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span>  <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span> <span class="k">as</span> <span class="n">slice_iter</span>
<span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span>  <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>

<p>
The result is the  same as my impllemented one.
</p>
</div>
</div>

<div id="outline-container-sec-2-14-2" class="outline-4">
<h4 id="sec-2-14-2">a try by me,  works</h4>
<div class="outline-text-4" id="text-2-14-2">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">slice_iter</span><span class="p">(</span><span class="n">aiter</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span><span class="p">)[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">:</span><span class="n">step</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span><span class="p">):</span>
	<span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">aiter</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span>  <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">slice_iter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-2-15" class="outline-3">
<h3 id="sec-2-15">4.8. Skipping the First Part of an Iterable, by itertools.dropwhile(test_func, iterable)</h3>
<div class="outline-text-3" id="text-2-15">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">dropwhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'#'</span><span class="p">),</span> <span class="n">f</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>

<p>
This is different from filtering
</p>

<p>
if the position is known, then we can use itertools.islice(iterable, start, None) to drop the first 'start' items.
</p>
</div>
</div>


<div id="outline-container-sec-2-16" class="outline-3">
<h3 id="sec-2-16">4.9. Iterating Over All Possible Combinations or Permutations</h3>
<div class="outline-text-3" id="text-2-16">
<p>
An important aspect  of itertools module: for complex iteration tasks, it is very likely there is an exist solution.
</p>
</div>

<div id="outline-container-sec-2-16-1" class="outline-4">
<h4 id="sec-2-16-1">create permutations from a iterable collection of items, by itertools.permutations(iterable[, len])</h4>
<div class="outline-text-4" id="text-2-16-1">
<p>
The return value is an iterator
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-16-2" class="outline-4">
<h4 id="sec-2-16-2">create combinations from a iterable collection of items, by itertools.combinations(iterable, len)</h4>
<div class="outline-text-4" id="text-2-16-2">
<p>
The order of items does not matter
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-16-3" class="outline-4">
<h4 id="sec-2-16-3">create combinations from a iterable collection of items, by itertools.combinations_with_replacement(iterable, len), same item can exist more than one times.</h4>
<div class="outline-text-4" id="text-2-16-3">
<p>
The order of items does not matter
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-2-17" class="outline-3">
<h3 id="sec-2-17">4.10. Iterating Over the Index-Value Pairs of a Sequence, by enumerate(iterable[, start_index])</h3>
<div class="outline-text-3" id="text-2-17">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-18" class="outline-3">
<h3 id="sec-2-18">4.11. Iterating Over Multiple Sequences Simultaneously, by zip(iterable1, iterable2, ...), shortest</h3>
<div class="outline-text-3" id="text-2-18">
<p>
The zip function will create an iterator that return tuples: first element from iterable1, second element from iterable2, ...
Should the size of all iterables be the same? =&gt; No, it can be different. the returned size is the same as the shortest size of all iterables.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-2-19" class="outline-3">
<h3 id="sec-2-19">Iterating Over Multiple Sequences Simultaneously, by itertools.zip_longest(iterable1, iterable2, ...), longest</h3>
<div class="outline-text-3" id="text-2-19">
<p>
If you want the returned iterator take the longest size, then use zip_longest. The element value will be None if that  iterable is exzasted.
</p>

<p>
From the two functions: zip and zip_longest, there is a lesson: it better to create different function name, than add a more  parameter.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-20" class="outline-3">
<h3 id="sec-2-20">4.12. Iterating on Items in Separate Containers, by itertools.chain(iterable1, iterable2, ...), concat iterables</h3>
<div class="outline-text-3" id="text-2-20">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="n">a</span> <span class="o">=</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-2-21" class="outline-3">
<h3 id="sec-2-21">4.13. Creating Data Processing Pipelines</h3>
<div class="outline-text-3" id="text-2-21">
<p>
This section is about divide  a task to many small pipelines(steps), by use of generator
Generator is a  producer, for loop is a comsumer.
</p>
</div>


<div id="outline-container-sec-2-21-1" class="outline-4">
<h4 id="sec-2-21-1">example: iterate all matched lines from all files in a directory, recursively</h4>
<div class="outline-text-4" id="text-2-21-1">
<p>
相当于把多重QIAN TAO循环给扁平化了。但执行的顺序完全相同。generator确实比较好用。
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">gen_filenames</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen_open</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
	<span class="c1"># print('file names: %s' % f)</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span>
	<span class="k">yield</span> <span class="n">fh</span>
	<span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">gen_lines</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
	<span class="k">yield from</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">gen_match</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>  <span class="n">lines</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">filenames</span> <span class="o">=</span> <span class="n">gen_filenames</span><span class="p">(</span><span class="s1">'..'</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">gen_open</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">gen_lines</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="n">matched_lines</span> <span class="o">=</span> <span class="n">gen_match</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="s1">'slice'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">matched_lines</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-21-2" class="outline-4">
<h4 id="sec-2-21-2">[not work]change two embeded for loop to two seperate one by generator</h4>
<div class="outline-text-4" id="text-2-21-2">
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen_a</span><span class="p">(</span><span class="n">aiter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">:</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">gen_b</span><span class="p">(</span><span class="n">aiter</span><span class="p">,</span> <span class="n">biter</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">:</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-2-22" class="outline-3">
<h3 id="sec-2-22">4.14. Flattening a Nested Sequence, by generator, recursively</h3>
<div class="outline-text-3" id="text-2-22">
<p>
Why this function is not included in itertools module?
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="k">def</span>  <span class="nf">flatten</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">ignored_types</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ignored_types</span><span class="p">):</span>
	    <span class="k">yield from</span> <span class="n">flatten</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ignored_types</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">yield</span> <span class="n">v</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="mi">7</span><span class="p">],</span>  <span class="mi">8</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"the flattened version"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-2-23" class="outline-3">
<h3 id="sec-2-23">yield from just like a for loop</h3>
<div class="outline-text-3" id="text-2-23">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_a</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">gen_b</span><span class="p">(</span><span class="n">gena</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">gena</span>

<span class="k">def</span> <span class="nf">for_b</span><span class="p">(</span><span class="n">gena</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">v</span>  <span class="ow">in</span> <span class="n">gena</span><span class="p">:</span>
	<span class="k">yield</span> <span class="n">v</span>

<span class="c1"># the gen_b and for_b works exactly the same, but the yield from is better</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gen_b</span><span class="p">(</span><span class="n">gen_a</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'the for version'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">for_b</span><span class="p">(</span><span class="n">gen_a</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-2-24" class="outline-3">
<h3 id="sec-2-24">4.15. Iterating in Sorted Order Over Merged Sorted Iterables, by heapq.merge(iterable1, iterable2, ...)</h3>
<div class="outline-text-3" id="text-2-24">
<p>
the input iterables should in sorted order. then it will create an new iterable of sorted items from all input.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">heapq</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">heapq</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>

<p>
The function will only get the needed items into memory. So it better to merge two sorted files.
</p>

<p>
Similar  to <code>sorted(itertools.chain(*iterables))</code>, but will not read all content to memory.
</p>
</div>
</div>
<div id="outline-container-sec-2-25" class="outline-3">
<h3 id="sec-2-25">4.16. Replacing Infinite conditional while Loops with an Iterator, by iter(callable, sentinel) function</h3>
<div class="outline-text-3" id="text-2-25">
<p>
invoke the callable UNTIL it returns the sentinel
</p>

<p>
Means: repeated invoke the callable, and return its return value, until the return value equal to the sentinel.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">idx</span>
    <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">chapter 8: Classes and Objects</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">8.1. Changing the String Representation of Instances</h3>
<div class="outline-text-3" id="text-3-1">
<p>
It's good practice to define both __repr__() and __str__()
</p>
</div>

<div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1">the __repr__() method of a class: the literal representation of a object</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
eval(repr(x)) = x
It it not possiable to create an object from the repr(x) results, then the repr(x) result should be enclosed in '&lt;&gt;' 
</p>
</div>
</div>

<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2">the __str__() method of a class: the toString method  of a object</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
The method will be called  when the object is passed to print() function
If __str__() is not provided, then __repr__() will be used.
</p>
</div>
</div>

<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3">the format function: positional field, by {N}, N means the nth parameter</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
ValueError: cannot switch from manual field specification to automatic field numbering
If you put a numbers to a field, then you should put numbers to all field.
</p>
<div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">'{0}, {1},  {1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

<p>
Get an object's attribute by {N.attt_name} syntax
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">'{0}, {0.chain}, {0.permutations}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itertools</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

<p>
for {0!r} or {0!s}, '!r' means use __repr__(), '!s' means use __str__(). '!s' is the default value.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">8.2. Customizing String Formatting</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1">the format(aobj[, format_spec]) builtin function</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
The function is equal to: aobj.__format__(format_spec)
而一般的aobj.__format__(spec) 的实现是调用 str.format(...) 函数来实现。
</p>

<p>
str.format(...) method 还支持关键字参数来指定field name.(问题：当关键字参数与普通参数混合时会发生什么？)
{:spec} 中的 spec 会传给 aobj.__format__(format_spec) 作为参数。 spec 可以为任意字符串，它可以作为参数传递给aobj.__format__() method.
</p>

<p>
str.format(aobj)时， 到底是哪个method会被调用呢？
From below codes, it can be see that if <span class="underline"><span class="underline">format</span></span> method is defined, then <span class="underline"><span class="underline">format</span></span> will be called. else <span class="underline"><span class="underline">str</span></span> will be called, when the object is formated by the str.format(...) method.
For str(aobj), aobj.__str__ will always be called.
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__repr__ called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'Point({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__str__ called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__format__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__format__ called. spec: </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">spec</span><span class="p">)</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">'{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">[NOT FINISHED]8.3. Making Objects Support the Context-Management Protocol, that is, the with statement</h3>
<div class="outline-text-3" id="text-3-3">
<p>
To provide with statement support, just define two methods:
</p>
<ol class="org-ol">
<li>__enter__(self)
</li>
<li>__exit__(self, exc_ty, exc_val, tb)
</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SaveVar</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avar</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">avar</span> <span class="o">=</span> <span class="n">avar</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__enter__ called"</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">8.5. Encapsulating Names in a Class</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1">one underscore _ means private variable, just convention, you can still access that  variable outside  of a class</h4>
<div class="outline-text-4" id="text-3-4-1">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_age</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_age</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2">two underscore __ means name mangling, when used for inheritance</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
the variable will be renamed to _C__name. Then it will not override the super class's variable.
Because it is also has one leading underscore, so the rules for one underscore also applies.
</p>

<p>
__age is renamed to _Person__age:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">__age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__age</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">_Person__age</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5">8.6. Creating Managed Attributes, with @property decorator/annotation, add a setter, getter, deleter to a field</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Steps:
</p>
<ol class="org-ol">
<li>first create a property object by @property decorator, on a getter method. The name of the getter should be the same with the attribute field.
</li>
<li>create the setter object: by @attribute_name.setter, on a setter method. The name of the setter should be the same with the attribute field.
</li>
<li>the getter, setter function are a way to define what will be called when the attribute with the same name is get,  set. 
e.g. the attribute name is 'foo', then the 'foo' attribute will be a object that has methods: 'getter', 'setter', 'deleter'. You can choose any name to store the real value for this  attribute, but the most common value will be add a underscore, that is '_foo'.
Type of 'foo' is &lt;class 'property'&gt;

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>
	<span class="c1"># here the name attribute is depend on the def name(self) getter function. Not the reverse.</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'(name: {}, age: {})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"getting name"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nameL</span>

    <span class="nd">@name.setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"setting name"</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span>

	<span class="bp">self</span><span class="o">.</span><span class="n">nameL</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s1">'Jim'</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6">create caculate attribute by @property, getter, setter, then the attribute works like a attribute,  not a method</h3>
<div class="outline-text-3" id="text-3-6">
<p>
Seems a good application of @property.
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Circle</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radis</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">radis</span> <span class="o">=</span> <span class="n">radis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"getting area"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">radis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">radis</span><span class="o">*</span><span class="mf">3.14</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">radis</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7">8.7. Calling a Method on a Parent Class, by super() function</h3>
<div class="outline-text-3" id="text-3-7">
<p>
There are many format
</p>
<div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">()</span> <span class="c1"># unbound</span>
<span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="c1"># isinstance(obj, type)</span>
<span class="nb">super</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">type2</span><span class="p">)</span> <span class="c1"># issubclass(type2, type). issubclass(object, object) is True</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8">8.9. Creating a New Kind of Class or Instance Attribute, by creating a descriptor class for the type</h3>
<div class="outline-text-3" id="text-3-8">
<p>
如果一个类定义了三个函数： <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span>, <span class="underline"><span class="underline">delete</span></span>, 则它是一个descriptor, 可能通过它来为一个instance的attribute添加一些get, set时的函数。
</p>

<p>
@property 只是descriptor的一种表象， descriptor是最底层，最灵活的实现，在库中大量使用。 TODO： 可以再研究下基于descriptor， @property的实现。
</p>

<p>
调用顺序：如果descriptor对应的class attribute 存在, 则总会优先调用这个descriptor的函数，来获取或设置attribute的值。
但当descriptor只定义了__get__方法时，则如果同名的变量在instance.__dict__中存在，则会优先从instance.__dict__中获取。
</p>

<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Integer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__get__ method called, name: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
	<span class="c1"># If instance is None, then it is the class attribute</span>
	<span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"__set__ method called, name </span><span class="si">%s</span><span class="s2">, value: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
	<span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="c1"># 关键的是量的值，输入参数的值只是用于内部实现的。并且Integer的实现中使用instance.__dict__保存数据也只是一种实现方式。</span>
    <span class="c1"># Point.x决定了atribute的名称为x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="s1">'z'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({0.x}, {0.y})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"p.x"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="c1"># setattr(p, 'x', 5)</span>
<span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9">8.10. Using Lazily Computed Properties, an application of descriptor</h3>
</div>
<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10">8.11. Simplifying the Initialization of Data Structures, by define a common base class</h3>
<div class="outline-text-3" id="text-3-10">
<div class="highlight"><pre><span></span><span class="c1"># python  is very flexiable</span>
<span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'Expected {} arguments'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)))</span>
	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
	    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'{}: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">]</span>
    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     return '(x: {0.x}, y: {0.y})'.format(self)</span>

<span class="k">class</span> <span class="nc">Circle</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'radius'</span><span class="p">]</span>
    <span class="c1"># def __str__(self):</span>
    <span class="c1">#     return '(radius: {0.radius})'.format(self)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Circle</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11">class attributes can also be accessed by instance object, such as self, but only when the same instance attribute not exists</h3>
<div class="outline-text-3" id="text-3-11">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="n">class_attr</span> <span class="o">=</span> <span class="s2">"ABC"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s1">'BB'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">class_attr</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">class_attr</span> <span class="ow">is</span> <span class="n">Foo</span><span class="o">.</span><span class="n">class_attr</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bar</span><span class="p">:</span>
    <span class="n">class_attr</span> <span class="o">=</span> <span class="s2">"ABC"</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">class_attr</span> <span class="o">=</span> <span class="n">a</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">Bar</span><span class="p">(</span><span class="s1">'BB'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">class_attr</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">class_attr</span> <span class="ow">is</span> <span class="n">Bar</span><span class="o">.</span><span class="n">class_attr</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-12" class="outline-3">
<h3 id="sec-3-12">8.12. Defining an Interface or Abstract Base Class</h3>
<div class="outline-text-3" id="text-3-12">
</div>
<div id="outline-container-sec-3-12-1" class="outline-4">
<h4 id="sec-3-12-1">create an abstract base class, or interface, by abc.ABCMeta, abc.abstractmethod</h4>
<div class="outline-text-4" id="text-3-12-1">
<p>
A abstract class can't be initialized.
</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="k">class</span> <span class="nc">IStream</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxbytes</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
	<span class="k">pass</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="k">pass</span>

<span class="c1"># typical usage:</span>
<span class="k">def</span>  <span class="nf">foo</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">IStream</span><span class="p">):</span>
	<span class="c1"># processing an IStream here</span>
	<span class="k">pass</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">IStream</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-12-2" class="outline-4">
<h4 id="sec-3-12-2">register another class to a 'sub class ' of a abstract base class, by abc.register(cls) function</h4>
<div class="outline-text-4" id="text-3-12-2">
<p>
Then isinstance(obj, AbstractBaseClass) will be  True. This let another class which is not a subclass of a base class, but can still pass the isinstance() test, which means implementing a interface.
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="c1"># Register the built-in I/O classes as supporting our interface</span>
<span class="n">IStream</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span>
<span class="c1"># Open a normal file and type check</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'foo.txt'</span><span class="p">)</span>
<span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">IStream</span><span class="p">)</span> <span class="c1"># Returns True</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-3-13" class="outline-3">
<h3 id="sec-3-13">8.13. Implementing a Data Model or Type System, by descriptor</h3>
<div class="outline-text-3" id="text-3-13">
<p>
感觉根之前小节讲到的descriptor相同，只不过用了继承的方式写了很多细小的descriptor。
</p>
</div>
</div>
<div id="outline-container-sec-3-14" class="outline-3">
<h3 id="sec-3-14">what is a descriptor? and its usage</h3>
<div class="outline-text-3" id="text-3-14">
<p>
A descriptor is  a class attribute object, which has <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span>, or <span class="underline"><span class="underline">delete</span></span> method, is used to define how a instance attribute is get, set, and delete. When an  instance attribute is get, the descriptor's <span class="underline"><span class="underline">get</span></span> method will be called. The same thing applys to <span class="underline"><span class="underline">set</span></span> and <span class="underline"><span class="underline">delete</span></span>
</p>

<p>
In descriptor's <span class="underline"><span class="underline">get</span></span>, <span class="underline"><span class="underline">set</span></span> methods, we must use instance.__dict__[xxx] to get a attribute. If we use getattr(instance, xxx) to get that attribute, then there will be a recursion error as below, because the getattr() function will trigger a new call of <span class="underline"><span class="underline">get</span></span> method.
RecursionError: maximum recursion depth exceeded while calling a Python object
</p>

<p>
The relationship between the descriptor object and an instance attribute:
</p>
<ol class="org-ol">
<li>if the descriptor object is assigned to a class attribute with name 'attribute_a', then it will control the instance attribute with the same name.
</li>
<li>but there is  one exception: if only the <span class="underline"><span class="underline">get</span></span> method of a descriptor is defined, then the instance attribute with the same name will be not be controled by the  descriptor, it will be get directly from the <span class="underline"><span class="underline">dict</span></span>.
</li>
</ol>
<p>
a test:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TraceDescriptor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
	    <span class="k">print</span><span class="p">(</span><span class="s1">'Getting attribute {}, value is {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
	    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
	    <span class="c1"># return getattr(instance, self.name)</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">instance</span>


    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'Setting attribute {} to {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
	<span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">Circle</span><span class="p">:</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">TraceDescriptor</span><span class="p">(</span><span class="s1">'radius'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">radius</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>

<span class="n">c</span> <span class="o">=</span>  <span class="n">Circle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-15" class="outline-3">
<h3 id="sec-3-15">8.16. Defining More Than One Constructor in a Class, use a class method</h3>
<div class="outline-text-3" id="text-3-15">
<p>
GP: Always only assign values in the default  constructor(<span class="underline"><span class="underline">init</span></span>), and do other things by other constructors
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Date</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>  <span class="n">d</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">y</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">m</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span>  <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">today</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
	<span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s1">'({0.year}, {0.month}, {0.day})'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">Date</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-16" class="outline-3">
<h3 id="sec-3-16">8.17. Creating an Instance Without Invoking init</h3>
<div class="outline-text-3" id="text-3-16">
</div>
<div id="outline-container-sec-3-16-1" class="outline-4">
<h4 id="sec-3-16-1">the object.__new__(*args, **kwargs) method: create a bare object</h4>
<div class="outline-text-4" id="text-3-16-1">
<p>
Every object has a <span class="underline"><span class="underline">new__method, which is inheritantanted from type.__new</span></span>.
</p>

<p>
The parameter should be a type object.
</p>

<p>
When you want to create an object from a json, this method can be used.
</p>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aspk_common</span> <span class="kn">as</span> <span class="nn">AC</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">AC</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-3-16-2" class="outline-4">
<h4 id="sec-3-16-2">Problem: how an object is constructed?</h4>
<div class="outline-text-4" id="text-3-16-2">
<p>
I guess first create a bare object by  calling the <span class="underline"><span class="underline">new</span></span> method, then call the object's <span class="underline"><span class="underline">init</span></span> method.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-17" class="outline-3">
<h3 id="sec-3-17">8.18. Extending Classes with Mixins</h3>
<div class="outline-text-3" id="text-3-17">
</div>
<div id="outline-container-sec-3-17-1" class="outline-4">
<h4 id="sec-3-17-1">mixin classes, used to extend function of a class, class customization, by multiple inheritance</h4>
<div class="outline-text-4" id="text-3-17-1">
<p>
SOLVED, see another comment. How below codes works? For 'super().__getitem__(key)', why dict.__getitem__ method will be called?
</p>

<p>
After figuring out MRO, then I know how a mixin class works:
Mixin class is used to customize an existing class.
It make use of  MRO of multiple inheritance. Suppose 'Base' is the class to be customized, 'Mixin' is the mixin class, 'Foo' is the result  class, then the typical syntax is:
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Mixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>
That is, put the mixin class as the first parent class, and the Base class as the second class. Then e.g. you want change a method of Base's behavier, such as 'foo', then you can just define a method named 'foo' in Mixin, and doing some work, then call 'super().foo(...)' to call Base's foo method.
</p>

<p>
Works like a decorator pattern.
</p>

<p>
But  what's difference between this method and by directly define the 'foo' method in Foo?
=&gt; maybe the main benifet is that  by putting the codes to a Mixin class, the codes can be easily reused.
</p>


<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aspk_common</span> <span class="kn">as</span> <span class="nn">AC</span>
<span class="k">class</span> <span class="nc">Logging</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'Getting {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'self: {}</span><span class="se">\n</span><span class="s1">super: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">super</span><span class="p">()))</span>
	<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LoggingDict</span><span class="p">(</span><span class="n">Logging</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">LoggingDict</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-3-18" class="outline-3">
<h3 id="sec-3-18">mutiple inheritance: how method/attribue are resolved if they exists in more than one  super classes</h3>
<div class="outline-text-3" id="text-3-18">
<p>
A method/attribute is resolved in the order of all parent class given.
e.g: 
class Foo(A, B)
if a method 'aaa' is defined in  both A and B, then A.aaa will be used.
</p>
</div>
</div>

<div id="outline-container-sec-3-19" class="outline-3">
<h3 id="sec-3-19">python multiple inheritance, super and MRO(method resolution order)</h3>
<div class="outline-text-3" id="text-3-19">
<p>
Guoid's words:
<a href="http://python-history.blogspot.fi/2010/06/method-resolution-order.html">http://python-history.blogspot.fi/2010/06/method-resolution-order.html</a>
depth first, from left to right, then delete all same classes expect the last one. Then diamond problem is solved.
</p>

<p>
For below code snippets:
From the printout, super() will return the next class in MRO(method resolve order) list, given a current class. The next class can be a real parent class for current class, or if the real parent class not exists,  then the next class will be the next parent class of the  current instance. For both two conditions, they are always the same class in MRO.
</p>

<p>
For below codes: the MRO is [C, A, B].
</p>
<ul class="org-ul">
<li>So super() in class C's result is A
</li>
<li>super() in  class A is B
</li>
<li>super() in class B is object(I guess)
</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"A"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>
	<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"B"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"C"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="nb">super</span><span class="p">())</span>
	<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"MRO of C: "</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"MRO() of C: "</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">mro</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-20" class="outline-3">
<h3 id="sec-3-20">8.19. Implementing Stateful Objects or State Machines</h3>
<div class="outline-text-3" id="text-3-20">
<p>
Implementing the state pattern, by creating class for each state. In a class for one state, only define the method  use to handle the current state, all other methods should raise a 'NotImplementedError'.
Will see this latter
</p>
</div>
</div>

<div id="outline-container-sec-3-21" class="outline-3">
<h3 id="sec-3-21">8.20. Calling a Method on an Object Given the Name As a String, by getattr</h3>
<div class="outline-text-3" id="text-3-21">
<p>
A method is just an attribute of an object, so first get the method by 'getattr' given string name
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">)()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-22" class="outline-3">
<h3 id="sec-3-22">8.20. Calling a Method on an Object Given the Name As a String, by operator.methodcaller(name, *args)</h3>
<div class="outline-text-3" id="text-3-22">
<p>
The benifit of methodcaller is that it will fix all parameters of the method. So if the method will be  called given same parameters for many differenntt object, this method might be better
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"foo: {}, {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="n">operator</span><span class="o">.</span><span class="n">methodcaller</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-23" class="outline-3">
<h3 id="sec-3-23">8.21. Implementing the Visitor Pattern</h3>
<div class="outline-text-3" id="text-3-23">
<p>
感觉这里所说的vistor pattern主要是对用于处理包含不同类型对象的list. 用于通用处理。
基于类型系统的visitor pattern, 是通过在不同的基础类中的accept函数来实现 dispatch table的。相当于把dispatch table也耦合在基础类定义中了。
但最本质的目的是对于不同类型的对象，客户代码使用相同的代码进行处理。
</p>

<p>
将dispatch table 做在哪里，只影响一点点写法，对最终达到的效果没影响。
</p>


<p>
例子：
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Visitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="n">methname</span> <span class="o">=</span> <span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
	<span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="n">meth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span>
	<span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'No {} method'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">File</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="k">class</span> <span class="nc">RegularFile</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">read_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">return</span> <span class="s2">"This is the content for file {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Directory</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">'''Return all children names as a list'''</span>
	<span class="k">return</span> <span class="p">[</span><span class="n">RegularFile</span><span class="p">(</span><span class="s1">'a.txt'</span><span class="p">),</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'b.exe'</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Symbolic</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="sd">'''Return real file this symbolic point to'''</span>
	<span class="k">return</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'dd.txt'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CatVisitor</span><span class="p">(</span><span class="n">Visitor</span><span class="p">):</span>
    <span class="sd">'''Implement cat command for a File object.'''</span>
    <span class="k">def</span>  <span class="nf">visit_RegularFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for regular file {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="k">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">read_content</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">visit_Directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for directory {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
	    <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">visit_Symbolic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s1">'content for symbolic file {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">real</span><span class="p">())</span>

<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">RegularFile</span><span class="p">(</span><span class="s1">'foo.txt'</span><span class="p">),</span> <span class="n">Directory</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">),</span> <span class="n">RegularFile</span><span class="p">(</span><span class="s1">'a.txt'</span><span class="p">),</span> <span class="n">Symbolic</span><span class="p">(</span><span class="s1">'aa.c'</span><span class="p">)]</span>
<span class="n">visitor</span> <span class="o">=</span> <span class="n">CatVisitor</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-24" class="outline-3">
<h3 id="sec-3-24">dispatch table in python, decided by object type</h3>
<div class="outline-text-3" id="text-3-24">
<p>
将所有处理函数写在一个类中， 提供一个根据待处理对象类型分发的函数。 这个作为dispatch 基类。然后再定义针对每种类型的visit函数就行了。
这里类有两个目的：
</p>
<ol class="org-ol">
<li>定义dispatch table
</li>
<li>对一组函数的名字空间吧。
</li>
<li>以下例子中实现的 Dispatcher class 是通用的，可以共用。
</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dispatcher</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="n">methname</span> <span class="o">=</span> <span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
	<span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="n">meth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span>
	<span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'No {} method'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'visit_'</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">FooDispatcher</span><span class="p">(</span><span class="n">Dispatcher</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">visit_RegularFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">pass</span>
    <span class="k">def</span> <span class="nf">visit_Directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
	<span class="k">pass</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-3-25" class="outline-3">
<h3 id="sec-3-25">8.23. Managing Memory in Cyclic Data Structures, by weakref.ref(aobject)</h3>
<div class="outline-text-3" id="text-3-25">
<p>
When cyclic reference exists, the some  object will never be deleted, because its reference coutns is  large than 0.
A weakref is just a reference that don't increase the reference count. To dereference, just call it like a function. If the referenced object still exists, the object will be returne, otherwise None will be returned.
</p>

<p>
For a tree structure, the book give an example of reference the parent node by  weakref.
</p>

<p>
Note: you can't weakref to 'int', 'str', ...
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">weakref</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="c1"># c = a     # if this line exists, then a will not be deleted after 'del a', then the second call to b() will still return a</span>

<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">())</span>
<span class="k">del</span> <span class="n">a</span>
<span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">())</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-3-26" class="outline-3">
<h3 id="sec-3-26">8.24. Making Classes Support Comparison Operations, by define many comparision builtin method: <span class="underline"><span class="underline">eq</span></span>, <span class="underline"><span class="underline">lt</span></span>, <span class="underline"><span class="underline">le</span></span>, <span class="underline"><span class="underline">gt</span></span>, <span class="underline"><span class="underline">ge</span></span>, <span class="underline"><span class="underline">ne</span></span>
</h3>
</div>
<div id="outline-container-sec-3-27" class="outline-3">
<h3 id="sec-3-27">8.25. Creating Cached Instances, by  create a factory method(a class method)</h3>
<div class="outline-text-3" id="text-3-27">
<p>
If the parameter are the same, then return an existing object.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">chapter 5: Files and I/O</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">5.1. Reading and Writing Text Data</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1">open a file</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
the 't' in mode means text.
</p>
<div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="c1">#read</span>
<span class="c1"># f = open('1.txt', 'wt') #write</span>
<span class="c1"># f = open('1.txt', 'at') #append</span>

<span class="c1"># specify codec</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'latin-1'</span><span class="p">)</span> <span class="c1">#read</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'latin-1'</span><span class="p">)</span> <span class="c1">#write</span>

<span class="c1">#disable newline translation, by use the open(newline='') option</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span> <span class="c1">#read</span>

<span class="c1"># specify what to do when encountering decoding/encoding errors, by use open(errors='...') option</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span> <span class="c1">#replace the char that can't be decoded to a unicode char U+fffd(which is the unicode replacemenet char)</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span> <span class="c1">#just ignore the char that can't be decoded</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-4-1-2" class="outline-4">
<h4 id="sec-4-1-2">read whole content of a file as a string</h4>
<div class="outline-text-4" id="text-4-1-2">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-1-3" class="outline-4">
<h4 id="sec-4-1-3">read/iterate each line of a file, by just treat the file object as a generator</h4>
<div class="outline-text-4" id="text-4-1-3">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-1-4" class="outline-4">
<h4 id="sec-4-1-4">write str to a file, by file.write(text) method</h4>
<div class="outline-text-4" id="text-4-1-4">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'abced'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">get system's default encoding</h3>
<div class="outline-text-3" id="text-4-2">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">())</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">5.2. Printing to a File, redirect stdout to a file, by use print(file=...) option</h3>
<div class="outline-text-3" id="text-4-3">
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"aaaaa"</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4">Question: how to redirect stdout to a file system widely.</h3>
</div>

<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5">5.3. Printing with a Different Separator or Line Ending, by use print(sep=..., end=...) options</h3>
<div class="outline-text-3" id="text-4-5">
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'abc'</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'##'</span><span class="p">)</span>
<span class="k">print</span><span class="p">()</span>
<span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'List'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6">pass a sequence/list object to a function as N parameters instead of one, by using *list_name</h3>
<div class="outline-text-3" id="text-4-6">
<div class="highlight"><pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'List'</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7">5.4. Reading and Writing Binary Data(such as image, sound files)</h3>
<div class="outline-text-3" id="text-4-7">
<p>
By saying binary data, it means that there will no encoding/decoding works during writing/reading process.
Use mode such as 'rb', 'wb', 'ab'.
</p>

<p>
当作为binary data读取时， 与作为text data相比，没有自动的decode, encode过程。
</p>

<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># f.write('aaabbb'.encode('latin-1'))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'aaabbb'</span><span class="p">)</span>
</pre></div>
</div>
</div>


<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8">what is text string and byte string in python</h3>
<div class="outline-text-3" id="text-4-8">
<p>
Each element in a text string is also a text string, 
Each element in a byte string is a int
</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'Hello'</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'Hello'</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">', '</span><span class="p">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9">5.5. Writing to a File That Doesn't Already Exist, by set mode of open(...) function to 'x'</h3>
<div class="outline-text-3" id="text-4-9">
<p>
If the file already exists, then don't write, and will raise a FileExistsError exception
</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'2.txt'</span><span class="p">,</span> <span class="s1">'xt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'aaa bbb'</span><span class="p">)</span>
</pre></div>

<p>
感觉这个根python的哲学有点类似，不事先做判断，而是用exception的方式。
具体的用法可能需要将它放在一个try catch里。
</p>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10">5.6. Performing I/O Operations on a String, by io.StringIO() or io.BytesIO()</h3>
<div class="outline-text-3" id="text-4-10">
<p>
a typecal application can be simulate a file when do unit testing.
</p>
</div>
</div>

<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11">5.7. Reading and Writing Compressed Datafiles, by use gzip.open(...), or bz2.open(...)</h3>
<div class="outline-text-3" id="text-4-11">
<p>
After open the file, other operations are just the same as normal file.
</p>
</div>
</div>

<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12">5.8. Iterating Over Fixed-Sized Records, by iter(callable, sentinel)</h3>
<div class="outline-text-3" id="text-4-12">
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="n">RECORD_SIZE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">RECORD_SIZE</span><span class="p">),</span> <span class="s1">''</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'; '</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13">the functools.partial(func, *args, **kwargs) function: create a new callable from a given callable with some(partial) arguments fixed. Currying</h3>
<div class="outline-text-3" id="text-4-13">
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">&gt;</span><span class="n">b</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">b</span>

<span class="n">mm</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">mm</span><span class="p">())</span>
</pre></div>

<p>
写一个能够接收很多参数的函数，然后利用partial 来生成简易的使用接口。需要注意参数的顺序。
</p>
</div>
</div>

<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14">5.9. Reading Binary Data into a Mutable Buffer</h3>
</div>

<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15">5.10. Memory Mapping Binary Files, map a binary file to memory(byte array), my mmap.mmap(...) method</h3>
<div class="outline-text-3" id="text-4-15">
<p>
This is a general method to map file to memory, then you can random access the content of the file, such as by using slicing
</p>

<p>
After mapped, by change the value of the array will change the file's content. This is also a way for multiple intepreter comunication.
Below is a general function that map a file to a byte array.
</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mmap</span>

<span class="k">def</span> <span class="nf">memory_map</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">ACCESS_WRITE</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">access</span><span class="p">)</span>

<span class="c1"># below is application of the function</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">memory_map</span><span class="p">(</span><span class="s1">'1.txt'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
<span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'EEF'</span>
</pre></div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef">
<sup><a id="fn.1" name="fn.1" class="footnum" href="posts/python-cookbook-readnote/#fnr.1">1</a></sup><p>DEFINITION NOT FOUND.</p>
</div>

<div class="footdef">
<sup><a id="fn.2" name="fn.2" class="footnum" href="posts/python-cookbook-readnote/#fnr.2">2</a></sup><p>DEFINITION NOT FOUND.</p>
</div>

<div class="footdef">
<sup><a id="fn.3" name="fn.3" class="footnum" href="posts/python-cookbook-readnote/#fnr.3">3</a></sup><p>DEFINITION NOT FOUND.</p>
</div>

<div class="footdef">
<sup><a id="fn.4" name="fn.4" class="footnum" href="posts/python-cookbook-readnote/#fnr.4">4</a></sup><p>DEFINITION NOT FOUND.</p>
</div>


</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/python-object-attribute/" class="u-url">Python 对象属性（一）：基础</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/python-object-attribute/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
所有的Python 对象都有属性，可以通过 <code>obj.name</code> 这样的语法来获取属性，通过  <code>obj.name = 'Tom'~  这样的语法添加一个属性或更新属性的值（如果这个属性已存在），通过 ~del obj.name</code> 删除一个属性。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">特殊属性和自定义属性</h2>
<div class="outline-text-2" id="text-1">
<p>
根据属性保存位置的不同，可以将属性分类为特殊属性和自定义属性。先来看一个例子。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="ow">is</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'__class__'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'My class'</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'bar'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'xxx'</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span>
</pre></div>

<p>
结果为：
</p>

<pre class="example">
{}
{'name': 'Tom'}
True
&lt;class '__main__.Foo'&gt;
&lt;class '__main__.Foo'&gt;
xxx
</pre>

<p>
从这个例子中，我们可以看出：
</p>
<ul class="org-ul">
<li>我们为一个对象新添加的属性都会被保存在 '<span class="underline"><span class="underline">dict</span></span>' 这个特殊属性中，'<span class="underline"><span class="underline">dict</span></span>'的类型是字典。如在添加了 name 这个属性后， <span class="underline"><span class="underline">dict</span></span> 的值变为 {'name': 'Tom'}，添加前为一个空字典。
</li>
<li>对于我们自己新添加的属性，可以通过两种方式来访问这个属性： f.name 和 f.__dict__['name']。这两种方式的效果完全相同，因为它们代表的是同一个变量。因此可认为 f.name 是 f.__dict__['name'] 的一种简写方式。
</li>
<li>对于任意的属性，f.xyz 的解析过程为：1. 首先检查xyz这个属性在对象中是否存在，如存在，则返回这个属性。2. 否则再检查 xyz这个属性在f.__dict__是否存在，如存在，则返回这个属性。
    如上面代码里，尽管我们通过直接在__dict__为对象添加一个名为__class__的属性，但由于这个属性对象本身就定义了，因此它还是原来的值。也即在以上第一步中即找到了这个属性。 而对于'bar' 属性，添加后再查询就是我们添加的值，在以上第2步中找到这个属性。
</li>
</ul>
<p>
因此可将一个python对象理解为一个C语言中的结构体，这个结构体的成员在对象创建后，就固定了，无法再添加新的成员。在本文中我们称这些属性为特殊属性。但实际上我们又是可以为一个对象添加新的属性的，这是怎么做到的呢？答案是每个对象都有一个名为__dict__的特殊属性，这个属性的类型为字典，所有新添加的属性都会被保存在这个字典里，在本文中我们称新添加的属性为自定义属性。但python向用户屏蔽两种属性的差别，提供了统一的语法来访问它们，也即通过 <code>obj.name</code> 。这个在大多数情况下会带来便利性，但有时会带来含混，此时我们需要弄清楚到底一个属性是一个特殊属性还是自定义属性。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">一些例子</h2>
<div class="outline-text-2" id="text-2">
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'Tom'</span>

    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">pass</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>
</pre></div>

<p>
结果为：
</p>

<pre class="example">
{'id': 1, 'name': 'Tom'}
&lt;bound method Foo.foo of &lt;__main__.Foo object at 0x000000B2509ECFD0&gt;&gt;
</pre>

<ul class="org-ul">
<li>可见一个类的__init__函数对self添加的属性，都将成为这个类实例对象的自定义属性，如例子中的id 和name两个属性。
</li>
<li>类中定义的函数，将成为类实例的特殊属性，如例子中的foo这个属性，它的类型是method.
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">对象属性的分类及一些例子</h2>
<div class="outline-text-2" id="text-3">
<p>
对于任何对象，其属性可分为两种(以下说的都是自己的属性，不包括父类的属性)：
</p>
<ol class="org-ol">
<li>用户自定义属性。
</li>
<li>语言定义属性
</li>
</ol>
<p>
对于一个class object，其两种属性可能包含：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">用户自定义属性</th>
<th scope="col" class="left">语言定义属性</th>
</tr></thead>
<tbody>
<tr>
<td class="left">所有类变量</td>
<td class="left"><span class="underline"><span class="underline">mro</span></span></td>
</tr>
<tr>
<td class="left">所有类函数</td>
<td class="left"><span class="underline"><span class="underline">dict</span></span></td>
</tr>
<tr>
<td class="left">所有类描述符</td>
<td class="left"> </td>
</tr>
<tr>
<td class="left"><span class="underline"><span class="underline">doc</span></span></td>
<td class="left"> </td>
</tr>
<tr>
<td class="left"><span class="underline"><span class="underline">module</span></span></td>
<td class="left"> </td>
</tr>
</tbody>
</table>
<p>
那么如何为一个class object添加自定义属性？
在定义一个类时，一个def 语句将添加一个类函数到自定义属性; 一个赋值语句将添加一个类变量到自定义属性。
</p>

<p>
注：其实对于class object, 它也是type class object 的instance
</p>

<p>
对于一个instance object, 其两种属性可能包含：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">用户自定义属性</th>
<th scope="col" class="left">语言定义属性</th>
</tr></thead>
<tbody>
<tr>
<td class="left">所有属性</td>
<td class="left"><span class="underline"><span class="underline">class</span></span></td>
</tr>
<tr>
<td class="left"> </td>
<td class="left"><span class="underline"><span class="underline">dict</span></span></td>
</tr>
</tbody>
</table>
<p>
问题： str.__class__ 是一个语言定义属性还是继承自 其父类 object 的__class__ 用户自定义属性（也即object.__dict__['<span class="underline"><span class="underline">class</span></span>'], 这个是一个'attribute'）？
应该是一个语言定义属性，应该来自于 object.__dict__['<span class="underline"><span class="underline">class</span></span>']， 也可能是
</p>

<p>
问题二： str.__mro__ 的结果是： (str, object). 但我不知道这个成员来自于何处。 str.__dict__和object.__dict__里都没有。
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">__dict__属性的作用</h2>
<div class="outline-text-2" id="text-4">
<p>
__dict__属性是一个语言定义属性，它用来保存所有的用户自定义属性。
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">属性的查找机制</h2>
<div class="outline-text-2" id="text-5">
<p>
x.name 等价于 getattr(x, 'name')，
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/python-descriptor/" class="u-url">Python描述符简介</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/python-descriptor/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
NOTE: 以下为语音笔记，待整理
</p>


<p>
使用描述符控制python对象属性的访问。
</p>

<p>
蟒蛇中定义的所有，数据都可以，称之为，属性。比如函数和变量都是这个类的属性。具体细分一下函数是，非数据属性。而变量是数据属性。描述符用于控制变量的，获取设置和删除。根据属性的不同。描述符也可以进一步细分为数据描述，符合非数据描述符，分别用于控制，数据属性和函数属性。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">描述符协议</h2>
<div class="outline-text-2" id="text-1">
<p>
任何一个对象只要提包含了get，set delete这三个函数，中的任意一个，那么它就是一个描述符.这三个函数分别控制，属性的获取设置和删除。
</p>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">第一数据属性以及数据描述符。</h2>
<div class="outline-text-2" id="text-2">
<p>
默认情况下，数据属性的获取顺序为，第一从对象的字典中获取，第二从类字典中获取
。
该如果定义了一个类属性对象，并且这个对象是一个描述符，则获取这个属性是会优先从这个描述符，的各个方法中获取。
</p>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">第二非数据属性。</h2>
<div class="outline-text-2" id="text-3">
<p>
静态函数，类函数都是通过描述符的方式实现的。在函数定义的时候，函数被保存在类的字典里，以一个普通的函数。函数的调用过程可以分为两个两个步骤。第一个是将函数获取出来，第二个是进行实际的调用。描述符是在第一个步骤中发挥作用。它会将，函数从类的字典中取出来，然后将类对象绑定为，第一个，参数。及成员函数的第一个参数及c f变量，都是在描述符中的钙函数中绑定的。
如果将函数的获取与调用看作两个不同的过程，则已向过则以上过程会，简化。函数本身就是一个描述符，他会返回一个新的函数，这个函数哪和原来的函数一样，但是，第一个参数会被设置为，会被设置为，对象本身。因此心身的函数，将接受的参数比原来的函数，少一个。因为函数本身也是一个描述符。
</p>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">第三描述符的一些应用。</h2>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">其他的一些。</h2>
<div class="outline-text-2" id="text-5">
<p>
描述服务提供了一个抽象城。这个层次控制性的，访问与设置。
所有函数是一个描述服。
累本身应该不是苗舒服。
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/recall-precision-fscore/" class="u-url">Recall，Precision 和 F-score</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/recall-precision-fscore/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
这个三个数据用于描述一个模型的好坏程度，分别为召回率、准确度和F值。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">定义</h2>
<div class="outline-text-2" id="text-1">
<p>
在二分类模型中，对于任意一个输入数据，结果只用两个：正类或者负类。对于一个输入数据集，假定该模型产生如下结果：
</p>

<ul class="org-ul">
<li>PT： 模型结果为正类且真实为正类的数目
</li>
<li>PF： 模型结果为正类且真实为负类的数目
</li>
<li>NT： 模型结果为负类且真实为负类的数目
</li>
<li>NF： 模型结果为负类且真实为正类的数目
</li>
</ul>
<p>
则召回率、准确度和F值的定义分别为：
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<tbody>
<tr>
<td class="left">Recall</td>
<td class="left">\(\frac{PT}{PT + NF}\)</td>
</tr>
<tr>
<td class="left">Precision</td>
<td class="left">\(\frac{PT}{PT + PF}\)</td>
</tr>
<tr>
<td class="left">F-score</td>
<td class="left">\(\frac{Recall + Precision}{2}\)</td>
</tr>
</tbody>
</table>
<p>
召回率和准确度具有相同的分子，分母不同。F值是二者的算数平均数。
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">搜索引擎的例子</h2>
<div class="outline-text-2" id="text-2">
<p>
假设给定一个关键字， 搜索引擎返回了100个文档，其中80个是正确的，也即符合关键字，
剩余20个是错误的，也即和给定的关键字没有关系。则此时准确度为： \(80/100 = 80\%\)
</p>

<p>
假设还有40篇文档也符合这个关键字，但搜索引擎并没有返回这40篇文档，则召回率为： \(80 / (80 + 40) = 67\%\)
</p>

<p>
由此可见， 召回率表示了搜索引擎从所有符合条件的文档中“召回”正确文档的比例， 而准确度表示了搜索引擎返回文档中正确文档的比例。
所有符合条件的文档和返回文档这两个概念是不同的。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">进一步思考</h2>
<div class="outline-text-2" id="text-3">
<p>
召回率描述了是否有遗漏，准确度描述了是否正确，F值综合了二者。
</p>

<p>
  如果一个模型如果准确率很高，但召回率很低，即使结果中大多数数据是正确的，但却遗漏了很多正确的数据。如果一个模型召回率很高，
但准确率很低，则表示这个模型可能返回所有正确的数据，但返回的数据中，错误的数据也很多。
</p>

<p>
好的模型应该做到召回率和准确率都较高，也即F值较高。
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/python-why-not-use-getter-setter/" class="u-url">为什么不需要为Python对象添加 getter 和 setter</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/python-why-not-use-getter-setter/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
Getter 和 setter在java中被广泛使用。一个好的java编程准则为：将所有属性设置为私有的，同时为属性写getter和setter函数以供外部使用。 这样做的好处是属性的具体实现被隐藏，当未来需要修改时，只需要修改getter 和 setter即可，而不用修改代码中所有引用这个属性的地方。可能做的修改为：
</p>
<ul class="org-ul">
<li>在获取或设置属性时打一条日志
</li>
<li>设置属性时，对值对进检查
</li>
<li>设置发生时， 修改设置的值
</li>
<li>获取属性时，动态地计算值
</li>
</ul>
<p>
可谓是好处多多，getter和setter为变量访问提供了灵活的方式。
</p>

<p>
但python中情况却不同，因为对象属性访问的机制不同。java中需要为变量写getter和setter的原因为：当我们写这样的表达式 <code>person.name</code> 来获取一个 <code>person</code> 对象的 <code>name</code> 属性时，这个表达式的意义是固定的，它就是获取这个属性，而不可能触发一个函数的调用。但对于python, 这个表达式即可能是直接获取一个属性，也可能会调用一个函数。这取决 <code>Person</code> 类的实现方式。也就是说，python的对象属性访问的语法，天然就提供了getter和setter的功能。
</p>

<p>
由于这个区别，我们没有必要在python中为每个对象的属性写getter和setter。最开始时，我们总是将属性作为一个直接可访问的属性。当后续需要对这个属性的访问进行一些控制时，我们可以将其修改为函数触发式属性。在修改前后，调用这个对象属性的代码不用修改，因为还是使用相同的语法来访问这个属性。
</p>

<p>
可以使用@property 装饰器将一个直接访问的属性转变为函数触发式属性。如下所示，使用@property前的代码为
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">"Tom"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

<p>
代码的输出为：
</p>
<div class="highlight"><pre><span></span><span class="n">Tom</span>
</pre></div>

<p>
此时为直接访问 <code>name</code> 这个属性。当我们需要确保 <code>name</code> 是一个字符串时，可以使用 @property 装饰器将属性转变为一个函数调用，如下所示。
</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"get name called"</span><span class="p">)</span>
	<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name.setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="k">print</span><span class="p">(</span><span class="s2">"set name called"</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
	    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Expected a string"</span><span class="p">)</span>
	<span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">"Tom"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

<p>
代码的输出为：
</p>
<div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">name</span> <span class="n">called</span>
<span class="n">get</span> <span class="n">name</span> <span class="n">called</span>
<span class="n">Tom</span>
</pre></div>

<p>
可以看出
</p>
<ul class="org-ul">
<li>在创建Person对象时(代码的倒数第二行)， 用于set name的函数被调用。这个函数会检查输入是否为一个字符串，如不是则raise一个TypeError
</li>
<li>在获取属性时（代码的最后一行），用于get name的函数被调用
</li>
<li>在修改前后，使用Person类的代码完全相同
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">总结</h2>
<div class="outline-text-2" id="text-1">
<p>
Python中对象访问的语法即可能是直接访问这个属性，也可能是调用一个函数，这取决于类的实现方式。我们可以在不修改调用者代码的前提下，轻松切换这两种方式。可见python原生就提供了添加额外getter和setter所带来的好处。因此没有必要一开始就为对象属性编写getter和setter函数，而是在需要时切换到函数调用式属性。
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/hmm-word-segmentation/" class="u-url">基于隐马尔科夫模型的中文分词方法</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/hmm-word-segmentation/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
本文主要讲述隐马尔科夫模及其在中文分词中的应用。 基于中文分词语料库，建立中文分词的隐马尔科夫模型，最后用维特比方法进行求解。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">一、隐马尔科夫模型介绍</h2>
<div class="outline-text-2" id="text-1">
<p>
隐马尔科夫模型中包括两个序列，其中一个是观测序列，另一个是隐藏序列。模型要解决的一个问题是，给定观测序列，
求其对应的隐藏序列。比如对于语音识别，这里的观测序列是语音的每一个序列，隐藏序列是这一串语音对应的文字。
或者对于机器翻译，观测序列是待翻译的语言，而隐藏序列则是目标语言。在解决这类问题时，我们的已知条件是，
第一，隐藏序列中某一个元素到观测序列中某一个元素之间的映射关系。第二是隐藏序列中每个元素转变到另一个元素之间的关系。
并且会有两个假设，第一是每个隐藏元素中的元素，只依赖于它前面一个元素。第二是每一个隐藏元素能够直接确定另一个观测元素。
其中以上两个已知条件可以分别表示为两个矩阵，这个矩阵可以通过分词语料库，根据统计的方法求得。
</p>


<p>
从数学上理解，给定观测序列求解隐藏序列。一个观测序列可能对应无数个隐藏序列，而我们的目标隐藏序列就是，
概率最大的那一个隐藏序列，也就是说最有可能的那个序列。即求给定隐藏序列这个条件下观测序列概率最大的那个序列的条件概率问题。
</p>

<p>
虽然隐马尔科夫模型中做了比较强的假设，这里比较强的意思是，现实生活中，可能根本无法满足这种假设条件，
但是它的应用范围却是比较广泛，能够非常简单有效的解决复杂的问题。这个也是统计学方法的一个特点, 
基于大量的数据，使用简单的方法便可以解决复杂的问题。这可能是大数据的一种威力吧，如果我们有足够多的数据，
那么我们的模型可以做简化。而如果我们只有少量的数据，则我们必须用非常精确的模型，才可以得到我们想要的结果。
数据模型以及数据量也是一种此消彼长的关系。
</p>

<p>
下图为隐马尔科夫模型的概率图，其中 \(x\) 代表隐藏序列， \(y\) 代表观察序列。
<img src="posts/hmm-word-segmentation/img/hmm.png" alt="hmm.png"></p>

<p>
其中这里的隐藏序列，又称为一个马尔科夫链。马尔科夫链的定义是，序列中每一个元素，只依赖于他前面的一个元素而与其他所有元素不相关。
</p>


<p>
为了使用隐马尔科夫模型，我们必须知道两个矩阵。第一个矩阵式表示隐藏序列中, 一个元素转变到另一个元素的概率.
如果总的序列的元素数目为n，则这个是一个n乘n的矩阵。 
第二个矩阵表示隐藏序列中某个元素转变到观测序列中某个元素的概率. 如果隐藏序列中元素个数为n，观测序列中元素的数目为m，
则这个矩阵的维数为n乘m。 这两个矩阵都可以通过大量的统计数据来求得。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">第二、中文分词的隐马尔科夫模型</h2>
<div class="outline-text-2" id="text-2">
<p>
中文分词要解决的问题是，给定一段中文文字，将其划分为一个个单独的词或者单字。中文分词是所有后续自然语言处理的基础。
如果将连续的中文文字看作是观测序列，将每个文字所对应的分词状态看作是隐藏序列，每个字的分子状态可能有两个值，
一个表示这个字是某一个词的词尾，用字母E表示。另一个表示这个字不是某一个词的词尾，用字母B表示。
则中文分词问题可以看作是一个标准的隐马尔科夫模型。实际中将每个字的分子状态表示为四个可选的值。
词的开始，词的中间，词的结尾，单字成词。分别用bmes表示。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">第三、中文分词语料库</h2>
<div class="outline-text-2" id="text-3">
<p>
在网上可以免费下载，北京大学和香港大学提供的中文分词语料库。这个语料库实际上是一个txt的文档，
文档中每个单独的词用两个空格隔开。
根据分词语料库，我们可以求得隐马尔科夫模型中的两个参数矩阵. 根据大数定理，概率等于次数的比值。因此为了模型的准确性，
我们必须有大量的语料数据来计算模型的参数。
</p>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">第四、使用维特比算法进行求解</h2>
<div class="outline-text-2" id="text-4">
<p>
给定马尔科夫模型中的两个参数以及一个观测序列，求解隐藏序列的问题，可以看作是一个类似于图论中的最短路径问题.
</p>

<p>
维特比算法使用动态规划的方法进行求解。动态规划的子问题是，对于第 \(i\) 列的每一个元素 \(A_j\), 
以这个元素为最后一个节点的最短路径。如果知道第 \(i\) 列的每一个元素的最短路径，那么第 \(i+1\) 列的每个元素的最短路径变可求得.
</p>

<p>
最终的结果就是第 \(n\) 列中每一个元素的最短路径中值最小的那一个元素所对应的最短路径。
</p>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">第五、代码实现</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="https://github.com/astropeak/nlp-word-segmentation">nlp-word-segmentation</a>
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gradient-descend/" class="u-url">梯度下降算法</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/gradient-descend/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
梯度下降算法是一种用于求解函数最小值的数值计算方法。求解函数的极值一般有两种方法，第一种是解析法, 
即函数的极值可以用公式直接计算出来。如对于1元2次方程，我们可以直接求出这个函数的最大值或者最小值。
但对于更高次的方程或者非线性函数, 大多无法求出解析解，此时需要使用数值方法.
</p>


<p>
对于一元函数来说, 函数的梯度就是其导数. 假设函数为
</p>


\begin{equation}
f(x) = 2x^2-4x+3
\end{equation}

<p>
则函数的梯度函数，也即导数为
</p>

\begin{equation}
Grad(x) = 4x-4
\end{equation}

<p>
梯度下降算法的基本原理如下:
</p>

<p>
对于任意一个自变量 \(x\) 的值 \(x_1\), 我们可以计算此时函数的梯度为 \(Grad(x_1)\), 用当前的 \(x\) 的值 \(x_1\)
减去梯度值的一个比例, 得到一个新的自变量 \(x\) 的值 \(x_2 = x_1 - 0.01*Grad(x_1)\). 则函数在这个新的自变量 \(x\)
的值的地方肯定是小于原来的值的地方, 即
</p>
\begin{equation}
f(x_2) &lt; f(x_1)
\end{equation}
<p>
其中 \(0.01\) 为步长值.
</p>


<p>
比如我们取 \(x_1 = 2\), 此时梯度值为 \(4*2-4=4\), 则 \(x_2 = 2 - 0.01*(4) = 1.96\),
</p>

\begin{equation}
f(x_1) = 2*2^2-4*2+3 = 3\\
f(x_2) = 2*1.96^2-4*1.96+3 = 2.843
\end{equation}

<p>
可见 \(f(x_2) &lt; f(x_1)\)
</p>

<p>
其中
</p>
<ul class="org-ul">
<li>\(x_1=2\) 中的 \(2\) 为自变量的初值. 初值可以随机选择, 如果函数是凸的, 不管初值为何,总能找到相同的极值点
</li>
<li>\(0.01\) 为每次迭代的步长值
</li>
</ul>
<p>
重复以上步骤, 选定初值后,根据以上方法不断变化自变量的值, 随着我们每一次的迭代，自变量的值将慢慢向最优值所对应的 \(x\) 值逼近
(对于这个例子, 最优值对应的 \(x = 1\)). 那么只要迭代的次数足够多，我们总会达到这个最优点，由此便求得函数的最小值.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">梯度的概念</h2>
<div class="outline-text-2" id="text-1">
<p>
以上提到对于一元函数, 其梯度就是函数的导数,梯度值为一个数值。梯度概念是对导数的扩展, 当函数有多于一个自变量的时候.
只是梯度此时是一个向量,向量的每一维分别是对于每一个自变量求偏导数。
</p>

<p>
以一个二元函数为例
</p>
\begin{equation}
f(x_1, x_2) = (x_1-2)^2 + 3x_2
\end{equation}

<p>
函数的梯度函数为
</p>
\begin{equation}
Grad(x_1) = \frac{\partial f}{\partial x_1} = 2x_1-4\\
Grad(x_2) = \frac{\partial f}{\partial x_2}=3\\
Grad(x_1, x_2) = [Grad(x_1), Grad(x_2)] = [2x_1-4, 3]
\end{equation}


<p>
以上讲到的关于自变量沿梯度反方向变化时, 函数值将减小的规则同样适用于二元及更高元的函数. 梯度下降算法的原理也一样,
不同点为此时更新自变量时,是向量操作.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">函数的等值线</h2>
<div class="outline-text-2" id="text-2">
<p>
梯度总是垂直于函数的等值线。从等值线中可以更加形象地看出梯度下降的原理. 当自变量沿着梯度的方向变化时, 
函数值将增加, 等值线所对应的值会增加. 因此，当我们将自变量沿着梯度的反方向变化时，函数的值将会减小. 
由此我们可以求出函数的一个极小值, 通过让自变量不断的向梯度的反方向变化.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">步长值</h2>
<div class="outline-text-2" id="text-3">
<p>
  梯度给出了自变量变化的方向, 而步长值指定了每次变化的幅度. 如果步长值选得过大，则可能会导致在一次更新自变量后,
错过极值点，从而造成震荡, 无法求得函数的极值. 因此我们要保证步长值足够小，避免震荡现象的出现.
</p>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">收敛准则</h2>
<div class="outline-text-2" id="text-4">
<p>
由于是通过迭代的方式一步一步的改变自变量的值来求函数的极值, 那么怎样判断函数已经达到一个极值了呢? 
此时需要有一个收敛准则, 即判断一次迭代后,函数是否达到极值点. 一般使用的收敛准则为:指定一个精确率, 
当函数值的变化率小于这个精确率时，我们就认为收敛了，此时函数的极值已经被找到.
</p>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">在机器学习算法中的应用</h2>
<div class="outline-text-2" id="text-5">
<p>
对于一个机器学习算法，如果其目标函数可以表示成连续可微的凸函数，则我们可以用梯度下降算法进行求解其最小值或者最大值.
</p>

<p>
例如在对数几率回归算法中, 可以将目标函数写成一个连续可微的凸函数, 然后用梯度下降算法求函数的最小值, 
从而求得模型的参数。
</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/generative-model-and-descriminative-model/" class="u-url">生成模型和判定模型</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Astropeak
            </span></p>
            <p class="dateline"><a href="posts/generative-model-and-descriminative-model/" rel="bookmark"><time class="published dt-published" datetime="2018-05-04T16:29:35+08:00" title="2018-05-04 16:29">2018-05-04 16:29</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <p>
统计概率模型的作用是给定输入 \(x\) ， 预测输出 \(y\) 的概率，也即求解条件概率 \(P(y|x)\) 。统计概率模型分为两种：生成模型（Generative Model）和判定模型（Descriminative Model）。
</p>
<ul class="org-ul">
<li>如果模型学习的是 \(P(x, y)\) 的联合概率分布，则这个模型是生成模型。求得 \(P(x, y)\) 后，根据贝叶斯定律，可间接求得 
</li>
</ul>
<p>
\(P(y|x) = \frac{P(x, y)}{P(x)}\) 。
</p>
<ul class="org-ul">
<li>如果模型学习的是 \(P(y|x)\) 的条件概率分布，则这个模型是判定模型。此时是直接求解。
</li>
</ul>
<p>
常见的生成模型和判定模型如下
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">生成模型</th>
<th scope="col" class="left">判定模型</th>
</tr></thead>
<tbody>
<tr>
<td class="left">朴素贝叶斯</td>
<td class="left">罗辑斯谛回归</td>
</tr>
<tr>
<td class="left">隐马尔科夫模型</td>
<td class="left">条件随机场</td>
</tr>
</tbody>
</table>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">为什么叫生成模型</h2>
<div class="outline-text-2" id="text-1">
<p>
  生成模型的中的生成表示: 根据训练数据, 模型学习给定 \(y\) 生成 \(x\) 的概率，即学习 \(P(x|y)\) 。以朴素贝叶斯为例，
求解公式为
</p>
  \begin{equation}
y^* = \underset{y}{\operatorname{argmax}} P(y|x) = \underset{y}{\operatorname{argmax}} P(x|y)P(y)
\end{equation}

<p>
\(P(x|y)\) 表示给定分类 \(y\) ，来预测可能的 \(x\) 值，或者生成 \(x\) 的值。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">区别</h2>
<div class="outline-text-2" id="text-2">
<p>
判定模型由于是直接学习 \(P(y|x)\) ，因此在相同数目的训练数据条件下，通常其预测效果要好于生成模型。
</p>

<p>
生成模型的功能更加强大。
</p>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-1.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:n.tesla@example.com">Astropeak</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
